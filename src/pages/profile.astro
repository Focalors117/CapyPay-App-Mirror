---
import MainLayout from "../layouts/MainLayout.astro";
---

<MainLayout title="Perfil | CapyPay" showSidebar={true}>
  <div
    class="flex flex-col gap-4 lg:gap-6 min-h-screen lg:h-full p-3 sm:p-4 lg:p-0 relative overflow-y-auto"
  >
    <!-- Header Page (estilo recargas) -->
    <header
      class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 lg:gap-4 shrink-0"
    >
      <div class="flex items-center gap-3 lg:gap-4 w-full md:w-auto">
        <a
          href="/dashboard"
          class="w-9 h-9 lg:w-10 lg:h-10 rounded-full border border-white/10 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/5 transition-colors shrink-0"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 lg:h-5 lg:w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            ></path>
          </svg>
        </a>
        <div class="min-w-0 flex-1">
          <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-white truncate">
            Mi Perfil
          </h1>
          <p class="text-slate-400 text-xs sm:text-sm mt-0.5 lg:mt-1">
            Tarjeta de identificación digital
          </p>
        </div>
      </div>
    </header>
    <!-- Hero Card - User Profile Header (Now includes badges) -->
    <div
      id="perfil-card"
      class="bg-brand-black border border-white/10 rounded-3xl p-6 relative overflow-hidden group shadow-2xl shadow-black/50 transition-all duration-500"
    >
      <div
        id="glow-nivel"
        class="absolute -top-24 -right-24 w-48 h-48 rounded-full blur-3xl pointer-events-none"
        style="background: rgba(96, 165, 250, 0.2)"
      ></div>
      <div
        class="absolute -bottom-16 -left-16 w-40 h-40 bg-brand-purple/10 rounded-full blur-2xl pointer-events-none"
      ></div>

      <div class="relative z-10">
        <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6 mb-6">
          <!-- Profile Photo -->
          <div class="relative shrink-0">
            <div
              id="profile-photo-border"
              class="w-24 h-24 sm:w-28 sm:h-28 rounded-full p-1 bg-gradient-to-br from-brand-lime to-brand-purple shadow-[0_0_30px_rgba(215,253,73,0.3)] transition-all duration-500"
            >
              <div class="w-full h-full rounded-full overflow-hidden bg-black">
                <img
                  src="https://api.dicebear.com/9.x/lorelei/svg?seed=Angel"
                  alt="Foto de perfil"
                  class="w-full h-full object-cover"
                />
              </div>
            </div>
            <div
              class="absolute -bottom-1 -right-1 w-7 h-7 bg-brand-lime rounded-full flex items-center justify-center border-4 border-brand-black shadow-[0_0_15px_rgba(215,253,73,0.5)]"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 text-black"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"
                ></path>
              </svg>
            </div>
          </div>

          <!-- User Info -->
          <div class="flex-1 text-center sm:text-left w-full">
            <h2 class="text-2xl sm:text-3xl font-bold text-white mb-1">
              Angel Estudiante
            </h2>
            <p class="text-brand-lime font-medium text-sm mb-3">
              Ingeniería de Sistemas
            </p>

            <!-- Level Badge -->
            <div class="inline-flex items-center gap-2 mb-4">
              <div
                id="nivel-badge"
                class="px-4 py-1.5 rounded-lg text-sm font-bold shadow-[0_0_15px_rgba(96,165,250,0.3)] transition-all duration-300"
                style="background: rgba(96, 165, 250, 0.1); border: 2px solid #60A5FA; color: #60A5FA"
              >
                <span id="nivel-text">Bachiller</span>
              </div>
              <span class="text-xs text-slate-400">
                <span id="xp-actual">1,500</span> / <span id="xp-siguiente">2,000</span> XP
              </span>
            </div>

            <!-- Level Bar -->
            <div class="bg-white/5 rounded-2xl p-3 sm:p-4 border border-white/5">
              <div class="w-full bg-slate-800 rounded-full h-2.5 overflow-hidden">
                <div
                  id="progreso-bar"
                  class="h-full rounded-full transition-all duration-500 ease-out relative"
                  style="width: 75%; background: linear-gradient(90deg, #60A5FA, #3B82F6)"
                >
                  <div
                    class="absolute inset-0 bg-linear-to-r from-transparent via-white/30 to-transparent w-full animate-shimmer"
                  ></div>
                </div>
              </div>
              <div class="flex justify-between mt-1.5">
                <span class="text-[11px] text-slate-500" id="xp-faltante">
                  500 XP para el siguiente nivel
                </span>
                <span class="text-[11px] text-slate-500" id="procentaje">
                  75% completado
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Badges Section (INSIDE the hero card) -->
        <div class="pt-4 border-t border-white/5">
          <div class="flex items-center gap-2 mb-3">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 text-yellow-400"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
              ></path>
            </svg>
            <h3 class="text-sm font-bold text-white uppercase tracking-wider">
              Mis Insignias
            </h3>
          </div>

          <div class="flex items-start gap-3 overflow-x-auto pb-2 no-scrollbar">
            <!-- Badge 1: Comprador Frecuente -->
            <div
              class="badge-item group relative flex flex-col items-center gap-1 shrink-0 cursor-pointer transition-all active:scale-95"
              data-name="Comprador Frecuente"
            >
              <!-- Badge name tooltip (appears above badge) -->
              <div class="badge-tooltip opacity-0 group-hover:opacity-100 transition-opacity duration-200 mb-1 pointer-events-none">
                <p class="text-[9px] text-brand-lime font-medium whitespace-nowrap bg-brand-black/90 px-2 py-1 rounded-md border border-brand-purple/30">
                  Comprador Frecuente
                </p>
              </div>
              <!-- Icon only -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-7 w-7 text-brand-purple group-hover:scale-110 transition-transform duration-300 drop-shadow-[0_0_5px_rgba(131,98,232,0.5)]"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M19 5h-14l1.5-2h11zM21.794 5.392l-2.994-3.992c-.196-.261-.494-.4-.8-.4h-12c-.326 0-.62.133-.828.349l-3.172 3.356c-.196.208-.304.479-.304.765v15c0 .553.447 1 1 1h18c.553 0 1-.447 1-1v-15c0-.264-.088-.512-.232-.704z"
                ></path>
              </svg>
            </div>

            <!-- Badge 2: Racha de 7 días -->
            <div
              class="badge-item group relative flex flex-col items-center gap-1 shrink-0 cursor-pointer transition-all active:scale-95"
              data-name="Racha de 7 días"
            >
              <!-- Badge name tooltip -->
              <div class="badge-tooltip opacity-0 group-hover:opacity-100 transition-opacity duration-200 mb-1 pointer-events-none">
                <p class="text-[9px] text-brand-lime font-medium whitespace-nowrap bg-brand-black/90 px-2 py-1 rounded-md border border-brand-lime/30">
                  Racha de 7 días
                </p>
              </div>
              <!-- Icon only -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-7 w-7 text-brand-lime group-hover:scale-110 transition-transform duration-300 drop-shadow-[0_0_5px_rgba(215,253,73,0.5)]"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4h-2l4-6v4h2l-4 6z"
                ></path>
              </svg>
            </div>

            <!-- Badge 3: Cuenta Verificada -->
            <div
              class="badge-item group relative flex flex-col items-center gap-1 shrink-0 cursor-pointer transition-all active:scale-95"
              data-name="Cuenta Verificada"
            >
              <!-- Badge name tooltip -->
              <div class="badge-tooltip opacity-0 group-hover:opacity-100 transition-opacity duration-200 mb-1 pointer-events-none">
                <p class="text-[9px] text-brand-lime font-medium whitespace-nowrap bg-brand-black/90 px-2 py-1 rounded-md border border-green-400/30">
                  Cuenta Verificada
                </p>
              </div>
              <!-- Icon only -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-7 w-7 text-green-400 group-hover:scale-110 transition-transform duration-300 drop-shadow-[0_0_5px_rgba(74,222,128,0.5)]"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"
                ></path>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Account Info Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <!-- Alias Card -->
      <div
        class="bg-brand-black border border-white/10 rounded-2xl p-4 flex items-center gap-4 hover:border-brand-lime/30 transition-all group"
      >
        <div
          class="w-12 h-12 rounded-xl bg-brand-lime/10 flex items-center justify-center text-brand-lime group-hover:bg-brand-lime group-hover:text-black transition-colors shrink-0"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
            ></path>
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-[10px] text-slate-500 uppercase tracking-wider font-medium mb-0.5">
            Alias
          </p>
          <p class="text-white font-bold truncate">@angel.capy</p>
        </div>
      </div>

      <!-- Cédula Card -->
      <div
        class="bg-brand-black border border-white/10 rounded-2xl p-4 flex items-center gap-4 hover:border-brand-lime/30 transition-all group"
      >
        <div
          class="w-12 h-12 rounded-xl bg-purple-500/10 flex items-center justify-center text-purple-400 group-hover:bg-purple-500 group-hover:text-black transition-colors shrink-0"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"
            ></path>
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-[10px] text-slate-500 uppercase tracking-wider font-medium mb-0.5">
            Cédula
          </p>
          <p class="text-white font-bold truncate">V-12.345.678</p>
        </div>
      </div>

      <!-- QR Code Card -->
      <button
        class="bg-brand-black border border-white/10 rounded-2xl p-4 flex items-center gap-4 hover:border-brand-lime/30 transition-all group cursor-pointer w-full"
        onclick="alert('Mostrando código QR...')"
      >
        <div
          class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400 group-hover:bg-blue-500 group-hover:text-black transition-colors shrink-0"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"
            ></path>
          </svg>
        </div>
        <div class="flex-1 min-w-0 text-left">
          <p class="text-[10px] text-slate-500 uppercase tracking-wider font-medium mb-0.5">
            Código QR
          </p>
          <p class="text-white font-bold truncate group-hover:text-brand-lime transition-colors">
            Ver mi código QR
          </p>
        </div>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 text-slate-500 group-hover:text-brand-lime group-hover:translate-x-1 transition-all"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 5l7 7-7 7"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Profile Settings (renamed from Security Settings) -->
    <div
      class="bg-brand-black border border-white/10 rounded-3xl p-6 relative overflow-hidden shadow-2xl shadow-black/50"
    >
      <div
        class="absolute -bottom-16 -right-16 w-40 h-40 bg-green-500/5 rounded-full blur-3xl pointer-events-none"
      ></div>

      <div class="relative z-10">
        <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-brand-lime"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
            ></path>
          </svg>
          Ajustes de Perfil
        </h3>

        <div class="space-y-4">
          <!-- Edit Username -->
          <div
            class="flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/5 hover:border-white/10 transition-all"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-10 h-10 rounded-lg bg-brand-lime/10 flex items-center justify-center text-brand-lime"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                  ></path>
                </svg>
              </div>
              <div>
                <p class="text-white font-medium text-sm">Editar Username</p>
                <p class="text-slate-500 text-xs">@angel.capy</p>
              </div>
            </div>
            <button
              class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white text-xs font-bold rounded-lg transition-colors border border-white/10 hover:border-white/20"
            >
              Editar
            </button>
          </div>

          <!-- Notificaciones de Gastos Toggle -->
          <div
            class="flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/5 hover:border-white/10 transition-all"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center text-purple-400"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                  ></path>
                </svg>
              </div>
              <div>
                <p class="text-white font-medium text-sm">
                  Notificaciones de Gastos
                </p>
                <p class="text-slate-500 text-xs">Alertas en cada transacción</p>
              </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" checked class="sr-only peer" />
              <div
                class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-lime"
              ></div>
            </label>
          </div>

          <!-- Visibilidad de Perfil Toggle -->
          <div
            class="flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/5 hover:border-white/10 transition-all"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-10 h-10 rounded-lg bg-slate-700 flex items-center justify-center text-slate-400"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"
                  ></path>
                </svg>
              </div>
              <div>
                <p class="text-white font-medium text-sm">
                  Visibilidad de Perfil
                </p>
                <p class="text-slate-500 text-xs">Perfil privado</p>
              </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" class="sr-only peer" />
              <div
                class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-lime"
              ></div>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Spacer for bottom nav on mobile -->
    <div class="lg:hidden h-20 w-full shrink-0"></div>
  </div>

  <style>
    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }

    .animate-shimmer {
      animation: shimmer 2s infinite;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeInUp 0.6s ease-out forwards;
      opacity: 0;
    }

    /* Badge tooltip styling */
    .badge-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-4px);
      z-index: 10;
    }

    .badge-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 4px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
    }
  </style>

  <script define:vars={{}}>
    // Niveles Configuration (consistent with niveles.astro)
    const nivelesConfig = [
      {
        id: "novato",
        nombre: "Novato (Cachorro)",
        puntosMin: 0,
        puntosMax: 500,
        color: "#9CA3AF",
        colorGlow: "#6B7280",
      },
      {
        id: "bachiller",
        nombre: "Bachiller",
        puntosMin: 501,
        puntosMax: 2000,
        color: "#60A5FA",
        colorGlow: "#3B82F6",
      },
      {
        id: "licenciado",
        nombre: "Licenciado",
        puntosMin: 2001,
        puntosMax: 5000,
        color: "#A78BFA",
        colorGlow: "#8B5CF6",
      },
      {
        id: "master",
        nombre: "Magíster",
        puntosMin: 5001,
        puntosMax: 10000,
        color: "#F472B6",
        colorGlow: "#EC4899",
      },
      {
        id: "doctorado",
        nombre: "Doctorado",
        puntosMin: 10001,
        puntosMax: Infinity,
        color: "#D7FD49",
        colorGlow: "#A8E638",
      },
    ];

    function calcularNivelActual(puntos) {
      for (let i = nivelesConfig.length - 1; i >= 0; i--) {
        const nivel = nivelesConfig[i];
        if (puntos >= nivel.puntosMin) {
          return nivel;
        }
      }
      return nivelesConfig[0];
    }

    function calcularProgreso(puntos, nivelActual) {
      if (nivelActual.id === "doctorado") return 100;

      const progresoEnNivel = puntos - nivelActual.puntosMin;
      const totalNivel = nivelActual.puntosMax - nivelActual.puntosMin;
      return Math.min(100, Math.max(0, (progresoEnNivel / totalNivel) * 100));
    }

    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    async function initProfile() {
      let currentXP = 1500;

      // 1. Try to get XP from localStorage first (cached)
      const userStr = localStorage.getItem("capypay_user");
      if (userStr) {
        try {
          const user = JSON.parse(userStr);
          if (user.xp !== undefined) {
            currentXP = user.xp;
          }
        } catch (e) {
          console.error("Error leyendo caché de usuario", e);
        }
      }

      // 2. Update UI with current XP
      updateProfileUI(currentXP);

      // 3. Try to fetch fresh data from backend
      try {
        const response = await fetch("/api/auth/me", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("capypay_token")}`,
          },
        });

        if (response.ok) {
          const data = await response.json();
          if (data.usuario && data.usuario.xp !== undefined) {
            if (data.usuario.xp !== currentXP) {
              currentXP = data.usuario.xp;
              updateProfileUI(currentXP);
            }
          }
        }
      } catch (e) {
        console.log("Usando versión en caché (offline o error de red)");
      }
    }

    function updateProfileUI(puntos) {
      const nivelActual = calcularNivelActual(puntos);
      const progreso = calcularProgreso(puntos, nivelActual);

      const nivelBadge = document.getElementById("nivel-badge");
      const nivelText = document.getElementById("nivel-text");
      const xpActual = document.getElementById("xp-actual");
      const xpSiguiente = document.getElementById("xp-siguiente");
      const xpFaltante = document.getElementById("xp-faltante");
      const progresoBar = document.getElementById("progreso-bar");
      const perfilCard = document.getElementById("perfil-card");
      const glowNivel = document.getElementById("glow-nivel");
      const procentaje = document.getElementById("procentaje");

      if (nivelBadge && nivelText) {
        nivelText.textContent = nivelActual.nombre;
        nivelBadge.style.borderColor = nivelActual.color;
        nivelBadge.style.color = nivelActual.color;
        nivelBadge.style.backgroundColor = `${nivelActual.color}20`;
        nivelBadge.style.boxShadow = `0 0 15px ${hexToRgba(
          nivelActual.color,
          0.3
        )}`;
      }

      if (xpActual) {
        xpActual.textContent = puntos.toLocaleString();
      }

      if (xpSiguiente) {
        if (nivelActual.id === "doctorado") {
          xpSiguiente.textContent = "MAX";
        } else {
          xpSiguiente.textContent = nivelActual.puntosMax.toLocaleString();
        }
      }

      if (xpFaltante) {
        if (nivelActual.id === "doctorado") {
          xpFaltante.textContent = "¡Has alcanzado el nivel máximo!";
        } else {
          const faltante = nivelActual.puntosMax - puntos;
          xpFaltante.textContent = `${faltante.toLocaleString()} XP para el siguiente nivel`;
        }
      }

      if (progresoBar) {
        progresoBar.style.width = `${progreso}%`;
        progresoBar.style.background = `linear-gradient(90deg, ${nivelActual.color}, ${nivelActual.colorGlow})`;
      }

      if (perfilCard) {
        perfilCard.style.borderColor = nivelActual.color;
        perfilCard.style.boxShadow = `0 0 20px ${hexToRgba(nivelActual.color, 0.15)}`;
      }

      if (glowNivel) {
        glowNivel.style.background = hexToRgba(nivelActual.color, 0.2);
      }

      if (procentaje) {
        procentaje.textContent = `${Math.round(progreso)}% completado`;
      }

      // Update profile photo border with level color (checkmark stays green)
      const profilePhotoBorder = document.getElementById("profile-photo-border");

      if (profilePhotoBorder) {
        profilePhotoBorder.style.background = `linear-gradient(to bottom right, ${nivelActual.color}, ${nivelActual.colorGlow})`;
        profilePhotoBorder.style.boxShadow = `0 0 30px ${hexToRgba(
          nivelActual.color,
          0.3
        )}`;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initProfile();

      // Toggle switch functionality
      const toggles = document.querySelectorAll('input[type="checkbox"]');
      toggles.forEach((toggle) => {
        toggle.addEventListener("change", (e) => {
          const label = e.target.closest("div");
          const labelText = label.querySelector("p.text-white").textContent;
          const state = e.target.checked ? "activado" : "desactivado";
          console.log(`${labelText} ${state}`);
        });
      });

      // Edit username button (placeholder)
      const editUsernameBtn = document.querySelector(
        'button:has(p:contains("Editar"))'
      );
      if (editUsernameBtn) {
        editUsernameBtn.addEventListener("click", () => {
          alert("Función de editar username próximamente disponible");
        });
      }
    });
  </script>
</MainLayout>
