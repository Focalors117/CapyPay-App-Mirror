---
import MainLayout from "../layouts/MainLayout.astro";

// No params needed, client-side only
---

<MainLayout title="Recibo de Orden | CapyPay" showSidebar={true}>
  <div class="max-w-md mx-auto p-4 pt-10" id="receipt-container">
    <!-- Receipt Card (Hidden initially) -->
    <div
      id="receipt-card"
      class="bg-[#1a1a1a] border border-white/10 rounded-3xl p-8 relative overflow-hidden hidden shadow-2xl"
    >
      <!-- Content injected by JS -->
    </div>

    <!-- Loader -->
    <div
      id="loader"
      class="flex flex-col items-center justify-center py-20 space-y-6"
    >
      <div class="relative w-20 h-20">
        <div class="absolute inset-0 rounded-full border-4 border-white/10">
        </div>
        <div
          class="absolute inset-0 rounded-full border-4 border-brand-lime border-t-transparent animate-spin"
        >
        </div>
        <div class="absolute inset-0 flex items-center justify-center">
          <span class="text-2xl">ðŸ§¾</span>
        </div>
      </div>
      <p class="text-white/50 animate-pulse font-medium">
        Generando tu recibo...
      </p>
    </div>

    <!-- Error State -->
    <div
      id="error-state"
      class="hidden text-center py-10 scale-95 opacity-0 transition-all duration-500"
    >
      <div
        class="text-red-400 mb-4 bg-red-500/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto"
      >
        <svg
          class="w-10 h-10"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
        >
      </div>
      <h3 class="text-white text-2xl font-bold mb-2">
        No encontramos esa orden
      </h3>
      <p class="text-white/50 mb-6">
        Puede que el ID sea incorrecto o la orden no exista.
      </p>
      <a
        href="/comedor"
        class="inline-flex items-center gap-2 text-brand-lime font-bold hover:underline"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg
        >
        Volver al menÃº
      </a>
    </div>

    <div
      id="actions"
      class="mt-8 space-y-3 hidden opacity-0 translate-y-4 transition-all duration-700 delay-300"
    >
      <a
        href="/comedor"
        class="block w-full py-4 bg-brand-purple hover:bg-brand-purple/90 text-white text-center font-bold rounded-xl active:scale-95 transition-all shadow-lg shadow-brand-purple/20"
      >
        Seguir Comprando
      </a>
      <a
        href="/history"
        class="block w-full py-4 bg-white/5 hover:bg-white/10 text-white/70 text-center font-bold rounded-xl active:scale-95 transition-all"
      >
        Ver Historial de Gastos
      </a>
    </div>
  </div>

  <script>
    // @ts-nocheck
    import { comedorService } from "../services/api";

    async function loadOrder() {
      const container = document.getElementById("receipt-container");
      const receiptCard = document.getElementById("receipt-card");
      const loader = document.getElementById("loader");
      const errorState = document.getElementById("error-state");
      const actions = document.getElementById("actions");

      if (!container || !receiptCard || !loader || !errorState || !actions)
        return;

      // Fetch ID from URL search params
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get("id");

      try {
        if (!orderId) throw new Error("ID de orden invÃ¡lido");

        // Simular un pequeÃ±o delay para sensaciÃ³n de proceso si la respuesta es instantÃ¡nea
        const minTime = new Promise((resolve) => setTimeout(resolve, 800));

        const [response] = await Promise.all([
          comedorService.getOrder(orderId),
          minTime,
        ]);

        if (!response || !response.order)
          throw new Error("Orden no encontrada");

        const { order } = response;
        const items = order.order_items || [];

        // Build Receipt HTML
        const date = new Date(order.created_at).toLocaleString("es-VE", {
          day: "numeric",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

        const itemsHtml = items
          .map((item) => {
            const price = item.price_at_time || item.price || 0;
            return `
                <div class="flex justify-between items-start text-sm mb-3 pb-3 border-b border-white/5 last:border-0 last:mb-0 last:pb-0">
                    <div class="flex gap-3">
                         <div class="font-bold text-white/40">x${item.quantity}</div>
                         <div class="text-white/90">
                            ${item.menu_items?.name || "Item Desconocido"}
                         </div>
                    </div>
                    <span class="text-white font-mono font-medium">${(price * item.quantity).toFixed(2)}</span>
                </div>
            `;
          })
          .join("");

        const subtotal = items.reduce((acc, i) => {
          const price = i.price_at_time || i.price || 0;
          return acc + price * i.quantity;
        }, 0);

        // Use the SERVER stored total which includes commission
        const totalPagado = parseFloat(order.total) || subtotal;

        // Calculate commission for display
        const comision = totalPagado - subtotal;

        receiptCard.innerHTML = `
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-brand-lime via-white to-brand-purple"></div>
                
                <div class="text-center mb-8 pt-2">
                    <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-brand-lime text-black mb-4 shadow-lg shadow-brand-lime/20 animate-bounce-short">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <h2 class="text-3xl font-black text-white tracking-tight">Â¡Orden Exitosa!</h2>
                    <p class="text-white/40 text-xs mt-2 font-mono uppercase tracking-widest">ID: ${String(order.id).split("-")[0]}</p>
                </div>

                <div class="bg-white/5 rounded-xl p-4 mb-6 ring-1 ring-white/10">
                    <div class="flex justify-between text-xs text-white/50 mb-2">
                        <span>Fecha de compra</span>
                        <span>${date}</span>
                    </div>
                    <div class="flex justify-between text-xs text-white/50">
                        <span>Estado del pedido</span>
                        <span class="text-brand-lime uppercase font-bold tracking-wider flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-brand-lime animate-pulse"></span>
                            ${order.status}
                        </span>
                    </div>
                </div>

                <div class="mb-4">
                     <h3 class="text-[10px] font-bold text-white/30 uppercase tracking-widest mb-4">Detalle del consumo</h3>
                     <div class="space-y-3 mb-4">
                        ${itemsHtml}
                     </div>
                     
                     <!-- Subtotal & Commission Breakdown -->
                     ${
                       comision > 0
                         ? `
                     <div class="pt-3 border-t border-white/5 flex justify-between text-xs text-white/50">
                        <span>Subtotal</span>
                        <span>${subtotal.toFixed(2)}</span>
                     </div>
                     <div class="pt-1 flex justify-between text-xs text-white/50">
                        <span>Tasa de Servicio (5%)</span>
                        <span>${comision.toFixed(2)}</span>
                     </div>
                     `
                         : ""
                     }
                </div>

                <div class="border-t-2 border-dashed border-white/10 pt-6">
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-white/60 text-sm">Total Pagado</span>
                        <span class="text-4xl font-black text-brand-lime tracking-tighter">${totalPagado.toFixed(2)}<span class="text-lg text-brand-lime/50 ml-1">BARAS</span></span>
                    </div>
                     <div class="mt-6 bg-gradient-to-r from-brand-purple/20 to-brand-purple/10 border border-brand-purple/30 p-3 rounded-lg text-center transform hover:scale-[1.02] transition-transform cursor-default">
                        <p class="text-brand-purple-light text-sm font-bold flex items-center justify-center gap-2">
                            <span>âœ¨</span> +${order.xp_earned || items.length * 15} XP Ganada
                        </p>
                    </div>
                </div>
            `;

        // Reveal
        loader.classList.add("hidden");

        receiptCard.classList.remove("hidden");
        receiptCard.classList.add("animate-fade-in-up"); // Ensure you have this class or similar, or standard simple transition

        actions.classList.remove("hidden");
        actions.classList.remove("opacity-0", "translate-y-4"); // Trigger CSS transition
      } catch (e) {
        console.error(e);
        loader.classList.add("hidden");
        errorState.classList.remove("hidden");
        setTimeout(() => {
          errorState.classList.remove("scale-95", "opacity-0");
        }, 50);
      }
    }

    // Init
    loadOrder();
  </script>

  <style>
    @keyframes bounce-short {
      0%,
      100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }
    .animate-bounce-short {
      animation: bounce-short 1s ease-in-out infinite;
    }
  </style>
</MainLayout>
