---
import MainLayout from "../layouts/MainLayout.astro";
import CartSidebar from "../components/CartSidebar.astro";
---

<MainLayout title="Comedor | CapyPay" showSidebar={true}>
  <CartSidebar />
  <!-- Custom Styles for this page -->
  <style>
    .glass-card {
      background: rgba(20, 20, 20, 0.6);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>

  <div class="max-w-7xl mx-auto px-4 md:px-6 py-8 pb-40 overflow-x-hidden">
    <!-- Header / Navbar especifia para el comedor -->
    <header
      class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8"
    >
      <div class="flex items-center gap-2 sm:gap-4 w-full md:w-auto">
        <a
          href="/dashboard"
          class="w-9 h-9 lg:w-10 lg:h-10 rounded-full border border-white/10 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/5 transition-colors shrink-0"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 lg:h-5 lg:w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
        </a>
        <div
          class="w-10 h-10 sm:w-12 sm:h-12 bg-brand-lime rounded-2xl flex items-center justify-center text-black shadow-[0_0_20px_rgba(215,253,73,0.3)]"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="24px"
            viewBox="0 -960 960 960"
            width="24px"
            fill="currentColor"
            ><path
              d="M280-80v-366q-51-14-85.5-56T160-600v-280h80v280h40v-280h80v280h40v-280h80v280q0 56-34.5 98T360-446v366h-80Zm400 0v-320H560v-280q0-83 58.5-141.5T760-880v800h-80Z"
            ></path></svg
          >
        </div>
        <div>
          <h1
            class="text-xl sm:text-2xl font-extrabold tracking-tight text-white leading-tight"
          >
            CapyPay <span
              class="bg-linear-to-r from-brand-lime to-emerald-400 bg-clip-text text-transparent"
              >Gourmet</span
            >
          </h1>
          <!-- RESPONSIVE: Text size adjusts, simpler subtext for mobile clarity -->
          <p class="text-white/40 text-sm font-medium flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-brand-lime animate-pulse"
            ></span>
            Abierto: 7:00 AM - 3:00 PM
          </p>
        </div>
      </div>

      <!-- REMOVED Search Bar & Avatar as requested for cleaner UI -->
      <!-- RESPONSIVE: Kept header flex logic to align items correctly on mobile vs desktop -->
    </header>

    <!-- Stats Row -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 pb-40">
      <!-- WIDGET A: Estado del Comedor / Ritmo de Cocina -->
      <div
        id="widget-a-container"
        class="glass-card flex flex-col justify-between h-48 col-span-1 border border-white/5 hover:border-brand-lime/20 transition-all duration-500 group relative overflow-hidden rounded-4xl"
      >
        <!-- View: Browsing (Default) -->
        <div
          id="view-browsing-occupied"
          class="flex flex-col h-full p-5 relative z-10 box-border"
        >
          <div class="flex items-start justify-between">
            <div class="flex items-center gap-2">
              <span class="relative flex h-2.5 w-2.5">
                <span
                  id="ping-dot"
                  class="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand-lime opacity-75"
                ></span>
                <span
                  id="static-dot"
                  class="relative inline-flex rounded-full h-2.5 w-2.5 bg-brand-lime"
                ></span>
              </span>
              <p
                class="text-white/50 text-[10px] sm:text-xs font-bold uppercase tracking-widest"
              >
                Cola Virtual
              </p>
            </div>
          </div>

          <div class="grow flex flex-col justify-center">
            <div class="flex items-baseline gap-1">
              <h3
                class="text-5xl lg:text-6xl font-black text-white tracking-tighter leading-none"
              >
                <span id="ocupacion-text">--</span>
              </h3>
              <span class="text-sm font-medium text-white/40 mb-2"
                >personas</span
              >
            </div>
            <p
              id="ocupacion-detail"
              class="text-[11px] text-white/60 font-medium truncate mt-1"
            >
              Cargando...
            </p>
          </div>

          <div class="mt-auto pt-2">
            <div
              class="w-full bg-white/5 h-1.5 rounded-full overflow-hidden mb-2"
            >
              <div
                id="ocupacion-bar"
                class="h-full bg-brand-lime w-[0%] transition-all duration-1000"
              >
              </div>
            </div>
            <div class="flex items-center justify-between">
              <span
                class="text-[9px] text-white/30 font-bold uppercase tracking-wider"
                >CAPACIDAD</span
              >
              <span
                id="ocupacion-status"
                class="text-[10px] font-bold text-brand-lime">--</span
              >
            </div>
          </div>
        </div>

        <!-- View: Waiting (Kitchen Rhythm) -->
        <div
          id="view-waiting-rhythm"
          class="hidden flex-col h-full p-5 relative z-10 animate-fade-in bg-linear-to-br from-cyan-950 to-black"
        >
          <div class="flex items-center gap-2 mb-2">
            <div class="p-1.5 bg-cyan-500/10 rounded-lg text-cyan-400">
              <svg
                class="w-4 h-4 animate-spin-slow"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
              >
            </div>
            <p
              class="text-white/50 text-[10px] sm:text-xs font-bold uppercase tracking-widest"
            >
              Ritmo Cocina
            </p>
          </div>

          <div class="grow flex flex-col justify-center">
            <h3
              class="text-3xl sm:text-4xl font-black text-cyan-400 tracking-tight leading-none mb-1"
            >
              Alta
            </h3>
            <span class="text-xs text-secondary font-medium text-white/40"
              >Frecuencia de lotes</span
            >
          </div>

          <div class="mt-auto">
            <div
              class="bg-cyan-900/40 rounded-xl p-2.5 border border-cyan-500/20 flex items-center gap-3 w-full"
            >
              <span class="relative flex h-2 w-2">
                <span
                  class="animate-ping absolute inline-flex h-full w-full rounded-full bg-cyan-400 opacity-75"
                ></span>
                <span
                  class="relative inline-flex rounded-full h-2 w-2 bg-cyan-400"
                ></span>
              </span>
              <span
                class="text-[9px] text-white/90 uppercase font-bold tracking-wide"
                >Produciendo a tope</span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- WIDGET B: Tiempo / Mi Turno (REDISEÑADO) -->
      <div
        id="widget-b-container"
        class="glass-card flex flex-col justify-between h-48 col-span-1 border border-white/5 hover:border-brand-purple/40 transition-all duration-500 relative overflow-hidden rounded-4xl"
      >
        <!-- View: Browsing (Default Time) -->
        <div
          id="view-browsing-time"
          class="flex flex-col h-full p-5 relative z-10 box-border"
        >
          <div class="flex items-center gap-2">
            <div class="p-1 rounded bg-blue-500/10 text-blue-400">
              <svg
                class="w-3.5 h-3.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
              >
            </div>
            <p
              class="text-white/50 text-[10px] sm:text-xs font-bold uppercase tracking-widest"
            >
              Estimación
            </p>
          </div>

          <div class="grow flex flex-col justify-center">
            <h3
              id="espera-text"
              class="text-4xl lg:text-5xl font-black text-blue-400 tracking-tight drop-shadow-[0_0_15px_rgba(96,165,250,0.3)] leading-none"
            >
              -- min
            </h3>
            <p class="text-[11px] text-white/60 leading-tight mt-2">
              Promedio actual
            </p>
          </div>

          <div
            class="mt-auto bg-blue-900/10 rounded-xl p-2.5 border border-blue-500/10 flex items-center justify-between group cursor-default hover:bg-blue-900/20 transition-colors"
          >
            <div class="flex flex-col">
              <span class="text-[8px] text-blue-300 font-bold uppercase"
                >TURNO ACTUAL</span
              >
              <span
                id="turno-text"
                class="text-xs font-mono font-bold text-white">#----</span
              >
            </div>
            <div
              class="h-8 w-8 rounded-full bg-blue-500/10 flex items-center justify-center border border-blue-400/20"
            >
              <!-- Ticket Icon instead of bell -->
              <svg
                class="w-4 h-4 text-blue-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"
                ></path></svg
              >
            </div>
          </div>
        </div>

        <!-- View: Pre-Arrival (Smart Check-in) -->
        <div
          id="view-pre-arrival"
          class="hidden flex-col h-full p-5 animate-fade-in relative z-20 bg-linear-to-br from-brand-purple/20 to-black/80"
        >
          <div class="w-full flex justify-between items-start mb-2">
            <div class="flex flex-col">
              <span
                class="text-purple-300/60 text-[9px] font-bold uppercase tracking-widest"
                >TU TICKET</span
              >
              <h3
                id="my-ticket-id"
                class="text-3xl font-mono font-black text-white tracking-tight mt-0.5"
              >
                #----
              </h3>
            </div>
            <span
              class="text-[8px] font-black text-black bg-brand-white px-2 py-1 rounded-md animate-pulse"
              >ACTIVO</span
            >
          </div>

          <div class="grow flex items-center justify-center">
            <p class="text-center text-xs text-white/50 px-4 leading-tight">
              Confirma cuando estés en el lugar
            </p>
          </div>

          <div
            id="btn-confirm-presence"
            class="mt-auto cursor-pointer relative overflow-hidden group bg-brand-purple hover:bg-white text-white hover:text-brand-purple rounded-xl p-3 flex items-center justify-center gap-3 transition-all duration-300 shadow-lg shadow-brand-purple/20 active:scale-95"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"
              ></path></svg
            >
            <span class="text-[10px] font-black uppercase tracking-widest"
              >CHECK-IN</span
            >
          </div>
        </div>

        <!-- View: Waiting (Position) -->
        <div
          id="view-waiting-position"
          class="hidden flex-col h-full p-5 animate-fade-in text-center relative z-20"
        >
          <div class="w-full flex flex-col items-center justify-center h-full">
            <p
              id="turns-label"
              class="text-[9px] text-white/50 font-bold uppercase tracking-widest mb-2"
            >
              Turnos antes de ti
            </p>

            <div
              class="relative mb-3 flex items-center justify-center h-16 w-full"
            >
              <span
                id="people-ahead-count"
                class="text-6xl font-black text-white relative z-10 transition-all duration-300"
                >...</span
              >
              <!-- Dynamic Pulse Background for Proximity -->
              <div
                id="proximity-glow"
                class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-40 h-40 bg-brand-lime/20 rounded-full blur-2xl animate-pulse"
              >
              </div>
              <div
                id="normal-glow"
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 bg-white/5 rounded-full blur-xl"
              >
              </div>
            </div>

            <div
              id="progress-container"
              class="w-full bg-white/10 h-1.5 rounded-full overflow-hidden max-w-30 mx-auto transition-opacity duration-300"
            >
              <div
                class="h-full bg-brand-white w-[50%] animate-pulse-slow rounded-full"
              >
              </div>
            </div>
            <p
              id="waiting-time-detail"
              class="text-[10px] text-white/50 font-bold mt-2"
            >
              Calculando...
            </p>
          </div>
        </div>

        <!-- View: Ready (Notification & Action) -->
        <div
          id="view-ready"
          class="hidden flex-col h-full p-5 relative z-30 animate-fade-in w-full bg-[#0F1608] rounded-4xl overflow-hidden"
        >
          <!-- Ambient Background Effects -->
          <div
            class="absolute inset-0 bg-linear-to-br from-brand-lime/10 via-transparent to-black/50 opacity-100 z-0"
          >
          </div>
          <div
            class="absolute -right-6 -top-6 w-32 h-32 bg-brand-lime/10 blur-3xl rounded-full pointer-events-none"
          >
          </div>

          <!-- Header (Aligned Left) -->
          <div class="flex items-center gap-2.5 mb-2 relative z-10">
            <div
              class="p-1.5 rounded-full bg-brand-lime/20 text-brand-lime border border-brand-lime/30 animate-pulse shadow-[0_0_10px_rgba(215,253,73,0.2)]"
            >
              <svg
                class="w-3.5 h-3.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"></path></svg
              >
            </div>
            <p
              class="text-brand-lime text-[10px] sm:text-xs font-bold uppercase tracking-widest drop-shadow-sm"
            >
              ¡Listo para retirar!
            </p>
          </div>

          <!-- Middle: Big Typography -->
          <div class="grow flex flex-col justify-center relative z-10">
            <h3
              class="text-3xl sm:text-4xl font-black text-white tracking-tight leading-none mb-1 drop-shadow-md"
            >
              TICKET
            </h3>
            <p
              id="ready-ticket-id"
              class="text-2xl sm:text-3xl font-mono text-brand-lime font-black tracking-tight leading-none drop-shadow-[0_0_15px_rgba(215,253,73,0.3)]"
            >
              #----
            </p>
          </div>

          <!-- Footer: High Contrast Action -->
          <div class="mt-auto relative z-10">
            <button
              id="btn-complete-order"
              class="w-full bg-white hover:bg-brand-lime hover:text-black text-black font-black text-[9px] py-2.5 rounded-xl uppercase tracking-widest transition-all duration-300 hover:scale-[1.02] active:scale-95 shadow-lg shadow-black/50 flex items-center justify-center gap-2 group cursor-pointer border border-transparent hover:border-brand-lime/50 h-8.5"
            >
              <span>¡YA LO TENGO!</span>
              <svg
                class="w-3 h-3 text-black transition-transform group-hover:translate-x-0.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"></path></svg
              >
            </button>
          </div>
        </div>
      </div>

      <!-- Gamification Badge Card -->
      <div
        class="bg-linear-to-br from-indigo-900 to-purple-900 p-4 rounded-3xl relative overflow-hidden flex flex-col justify-between group cursor-pointer col-span-2 md:col-span-1 h-auto min-h-35 border border-white/10 hover:border-indigo-500/50 transition-all"
      >
        <div class="z-10">
          <div class="flex items-center justify-between mb-2">
            <p
              class="text-indigo-200 text-[10px] font-bold uppercase tracking-widest"
            >
              Torneo de Facultades
            </p>
            <span
              class="bg-brand-lime text-black px-2 py-0.5 rounded text-[9px] font-bold animate-pulse"
              >LIVE</span
            >
          </div>
          <h3 class="text-lg sm:text-xl font-extrabold text-white mb-1">
            Gran Chigüire 👑
          </h3>
          <p class="text-indigo-200/80 text-xs text-balance leading-relaxed">
            Acumula <span class="text-white font-bold">Puntos de Batalla</span> para
            tu facultad. ¡XP es para tu nivel personal!
          </p>
        </div>

        <a
          href="/ranking"
          class="z-10 mt-4 px-3 py-1.5 sm:px-4 sm:py-2 bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-xl text-xs font-bold text-white transition-all w-fit flex items-center gap-2 border border-white/10"
        >
          Entrar a la Batalla
          <svg
            class="w-3 h-3"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"></path></svg
          >
        </a>

        <div
          class="absolute -right-4 -bottom-4 opacity-30 transform rotate-12 group-hover:rotate-6 group-hover:scale-110 transition-all duration-500"
        >
          <svg
            class="w-28 h-28 text-indigo-500 mix-blend-overlay"
            fill="currentColor"
            viewBox="0 -960 960 960"
            ><path
              d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"
            ></path></svg
          >
        </div>
      </div>

      <!-- Featured Card: Plato del Día -->
      <section class="col-span-2 md:col-span-3">
        <div class="flex items-center justify-between mb-4 px-1">
          <h2
            class="text-xl font-extrabold tracking-tight text-white flex items-center gap-2"
          >
            🍽️ Menú del Día
          </h2>
          <span
            class="text-brand-lime text-[10px] sm:text-xs font-bold px-2 py-1 bg-brand-lime/10 rounded border border-brand-lime/20 animate-pulse"
            >ACTUALIZADO AHORA</span
          >
        </div>
        <div
          id="plato-dia-container"
          class="relative group overflow-hidden rounded-3xl bg-[#1c2210] border border-white/10 shadow-2xl min-h-auto h-auto transition-all"
        >
          <!-- JS Injected Content -->
          <!-- RESPONSIVE: h-auto allows container to grow with content, overflow logic fixed -->
          <div class="h-64 sm:h-96 md:h-100 flex items-center justify-center">
            <div
              class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-lime"
            >
            </div>
          </div>
        </div>
      </section>

      <!-- Popular / Favorites Section (Rotator) -->
      <section class="col-span-2 md:col-span-3 mb-4">
        <div class="flex items-center justify-between mb-4 px-1">
          <h2
            class="text-xl font-extrabold tracking-tight text-white flex items-center gap-2"
          >
            🔥 Lo Más Popular
          </h2>
          <!-- Simple Indicators -->
          <div
            id="pop-indicators"
            class="flex gap-1.5 bg-black/20 p-1 rounded-full backdrop-blur-sm"
          >
            <!-- JS injected -->
          </div>
        </div>

        <div
          id="popular-rotator"
          class="relative overflow-hidden rounded-3xl bg-[#1c2210] border border-white/10 shadow-2xl h-64 sm:h-96 md:h-100 transition-all select-none"
        >
          <!-- JS will inject popular slides here -->
          <div class="h-full w-full flex items-center justify-center">
            <div
              class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-lime"
            >
            </div>
          </div>
        </div>
      </section>

      <!-- Capy-Tip Alert -->
      <div
        class="bg-brand-lime/5 border border-brand-lime/20 p-4 rounded-2xl flex flex-col items-center text-center gap-3 w-full col-span-2 md:col-span-3 order-4 md:order-4"
      >
        <div class="flex items-center gap-3 w-full justify-center">
          <div
            class="size-10 shrink-0 rounded-xl bg-brand-lime/10 flex items-center justify-center text-brand-lime"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
              ></path></svg
            >
          </div>
          <div class="text-left">
            <h4 class="font-bold text-white text-xs uppercase tracking-wide">
              Capy-Tip
            </h4>
            <p
              id="capy-tip-text"
              class="text-white/70 text-xs animate-fade-in-up"
            >
              ¡Agrega una malta bien fría para completar tu experiencia!
            </p>
          </div>
        </div>
      </div>

      <!-- Premium Carousel Section -->
      <section
        class="relative group col-span-2 md:col-span-3 order-3 md:order-3"
      >
        <div class="flex flex-col mb-6 px-1 gap-4">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-extrabold tracking-tight text-white">
              Capy-Gourmet <span
                class="bg-linear-to-r from-brand-purple to-purple-500 bg-clip-text text-transparent font-black italic pr-1 pb-1"
                >PREMIUM</span
              >
            </h2>
          </div>

          <!-- Basic Filters -->
          <div class="flex items-center gap-2 overflow-x-auto hide-scrollbar">
            <button
              class="filter-btn active bg-brand-white text-brand-black font-bold text-xs px-4 py-2 rounded-full border border-white/10 transition-all hover:scale-105"
              data-category="all"
            >
              Todos
            </button>
            <button
              class="filter-btn bg-white/5 text-white/60 font-medium text-xs px-4 py-2 rounded-full border border-white/5 transition-all hover:bg-white/10 hover:text-white"
              data-category="desayuno"
            >
              🍳 Desayunos
            </button>
            <button
              class="filter-btn bg-white/5 text-white/60 font-medium text-xs px-4 py-2 rounded-full border border-white/5 transition-all hover:bg-white/10 hover:text-white"
              data-category="almuerzo"
            >
              🍔 Almuerzos
            </button>
            <button
              class="filter-btn bg-white/5 text-white/60 font-medium text-xs px-4 py-2 rounded-full border border-white/5 transition-all hover:bg-white/10 hover:text-white"
              data-category="bebida"
            >
              🥤 Bebidas
            </button>
          </div>
        </div>

        <!-- Container -->
        <div class="relative w-full min-h-100">
          <!-- Decoration / Fade Masks (Subtle inside container) -->
          <div
            class="hidden md:block absolute inset-y-0 left-0 w-16 bg-linear-to-r from-[#0a0a0a] to-transparent z-10 pointer-events-none rounded-l-3xl"
          >
          </div>
          <div
            class="hidden md:block absolute inset-y-0 right-0 w-16 bg-linear-to-l from-[#0a0a0a] to-transparent z-10 pointer-events-none rounded-r-3xl"
          >
          </div>

          <!-- Navigation Buttons (Absolute) -->
          <button
            id="scroll-left"
            class="absolute top-1/2 -translate-y-1/2 scale-0 md:scale-100 md:-left-6 z-20 w-12 h-12 rounded-full bg-black/50 backdrop-blur-xl border border-white/10 flex items-center justify-center text-white hover:bg-brand-lime hover:text-black hover:scale-110 transition-all duration-300 opacity-0 group-hover:opacity-100 translate-x-4 group-hover:translate-x-0 shadow-xl"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"></path></svg
            >
          </button>

          <button
            id="scroll-right"
            class="absolute top-1/2 -translate-y-1/2 scale-0 md:scale-100 md:-right-6 z-20 w-12 h-12 rounded-full bg-black/50 backdrop-blur-xl border border-white/10 flex items-center justify-center text-white hover:bg-brand-lime hover:text-black hover:scale-110 transition-all duration-300 opacity-0 group-hover:opacity-100 -translate-x-4 group-hover:translate-x-0 shadow-xl"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"></path></svg
            >
          </button>

          <!-- Carousel Track -->
          <!-- RESPONSIVE: overflow-x-auto allows native swipe on mobile, snap-x for snap effect -->
          <div
            id="carousel-container"
            class="flex gap-4 md:gap-6 overflow-x-auto snap-x snap-mandatory py-8 md:py-12 -mx-4 md:mx-0 px-4 md:px-2 hide-scrollbar scroll-smooth min-h-105"
          >
            <!-- Card 1: Pepito Guaro -->
            <div
              class="flex-none w-[80vw] sm:w-72 md:w-[calc(25%-1.125rem)] bg-white/5 border border-white/5 rounded-3xl p-4 group transition-all hover:bg-white/8 snap-center hover:-translate-y-2 duration-500 ease-out"
            >
              <div
                class="relative h-48 rounded-2xl overflow-hidden mb-3 box-shadow-lg"
              >
                <img
                  alt="Pepito Guaro"
                  class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                  src="https://images.unsplash.com/photo-1734769853702-c7444c039c8c?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                />
                <div
                  class="absolute top-2 right-2 bg-black/60 backdrop-blur-md px-2 py-0.5 rounded-full border border-white/10"
                >
                  <span class="text-brand-lime font-black text-[10px]"
                    >450 B</span
                  >
                </div>
              </div>
              <h4 class="font-bold text-base text-white mb-1">Pepito Guaro</h4>
              <p class="text-white/50 text-[10px] mb-3 line-clamp-2">
                Lomito, pollo, chuleta, queso pecorino y salsas.
              </p>
              <button
                class="add-to-cart-btn w-full py-2.5 rounded-xl border border-brand-lime/30 text-brand-lime font-bold text-[10px] uppercase hover:bg-brand-lime hover:text-black transition-all"
                data-id="pepito-guaro"
                data-name="Pepito Guaro"
                data-price="450"
                data-image="https://images.unsplash.com/photo-1596662951482-0c4babeae723"
                >Agregar</button
              >
            </div>
            <!-- Card 2: Cachapa con Queso -->
            <div
              class="flex-none w-[80vw] sm:w-72 md:w-[calc(25%-1.125rem)] bg-white/5 border border-white/5 rounded-3xl p-4 group transition-all hover:bg-white/8 snap-center hover:-translate-y-2 duration-500 ease-out"
            >
              <div
                class="relative h-48 rounded-2xl overflow-hidden mb-3 shadow-lg"
              >
                <img
                  alt="Cachapa con Queso"
                  class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                  src="https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=800"
                />
                <div
                  class="absolute top-2 right-2 bg-black/60 backdrop-blur-md px-2 py-0.5 rounded-full border border-white/10"
                >
                  <span class="text-brand-lime font-black text-[10px]"
                    >380 B</span
                  >
                </div>
              </div>
              <h4 class="font-bold text-base text-white">Cachapa de Maíz</h4>
              <p class="text-white/50 text-[10px] mb-3 line-clamp-1">
                Maíz tierno molido con full queso de mano.
              </p>
              <button
                class="add-to-cart-btn w-full py-2.5 rounded-xl border border-brand-lime/30 text-brand-lime font-bold text-[10px] uppercase hover:bg-brand-lime hover:text-black transition-all"
                data-id="cachapa-queso"
                data-name="Cachapa con Queso"
                data-price="380"
                data-image="https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=800"
                >Agregar</button
              >
            </div>
            <!-- Card 3: Tequeños -->
            <div
              class="flex-none w-[80vw] sm:w-72 md:w-[calc(25%-1.125rem)] bg-white/5 border border-white/5 rounded-3xl p-4 group transition-all hover:bg-white/8 snap-center hover:-translate-y-2 duration-500 ease-out"
            >
              <div
                class="relative h-48 rounded-2xl overflow-hidden mb-3 shadow-lg"
              >
                <img
                  alt="Tequeños Ración"
                  class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                  src="https://images.unsplash.com/photo-1640718534338-466077731ca9?q=80&w=1166&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                />
                <div
                  class="absolute top-2 right-2 bg-black/60 backdrop-blur-md px-2 py-0.5 rounded-full border border-white/10"
                >
                  <span class="text-brand-lime font-black text-[10px]"
                    >200 B</span
                  >
                </div>
              </div>
              <h4 class="font-bold text-base text-white">Ración de Tequeños</h4>
              <p class="text-white/50 text-[10px] mb-3 line-clamp-1">
                6 unidades de tequeños full queso.
              </p>
              <button
                class="add-to-cart-btn w-full py-2.5 rounded-xl border border-brand-lime/30 text-brand-lime font-bold text-[10px] uppercase hover:bg-brand-lime hover:text-black transition-all"
                data-id="tequenos-racion"
                data-name="Ración de Tequeños"
                data-price="200"
                data-image="https://images.unsplash.com/photo-1574484284008-59166b615a77?w=800"
                >Agregar</button
              >
            </div>
            <!-- Card 4: Pasticho -->
            <div
              class="flex-none w-[80vw] sm:w-72 md:w-[calc(25%-1.125rem)] bg-white/5 border border-white/5 rounded-3xl p-4 group transition-all hover:bg-white/8 snap-center hover:-translate-y-2 duration-500 ease-out"
            >
              <div
                class="relative h-48 rounded-2xl overflow-hidden mb-3 shadow-lg"
              >
                <img
                  alt="Pasticho Venezolano"
                  class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                  src="https://images.unsplash.com/photo-1551183053-bf91a1d81141?w=800"
                />
                <div
                  class="absolute top-2 right-2 bg-black/60 backdrop-blur-md px-2 py-0.5 rounded-full border border-white/10"
                >
                  <span class="text-brand-lime font-black text-[10px]"
                    >420 B</span
                  >
                </div>
              </div>
              <h4 class="font-bold text-base text-white">
                Pasticho Venezolano
              </h4>
              <p class="text-white/50 text-[10px] mb-3 line-clamp-1">
                Con extra de carne, bechamel y parmesano.
              </p>
              <button
                class="add-to-cart-btn w-full py-2.5 rounded-xl border border-brand-lime/30 text-brand-lime font-bold text-[10px] uppercase hover:bg-brand-lime hover:text-black transition-all"
                data-id="pasticho-venezolano"
                data-name="Pasticho Venezolano"
                data-price="420"
                data-image="https://images.unsplash.com/photo-1551183053-bf91a1d81141?w=800"
                >Agregar</button
              >
            </div>
            <!-- Card 5: Extra 1 -->
            <div
              class="flex-none w-[80vw] sm:w-72 md:w-[calc(25%-1.125rem)] bg-white/5 border border-white/5 rounded-3xl p-4 group transition-all hover:bg-white/8 snap-center hover:-translate-y-2 duration-500 ease-out"
            >
              <div
                class="relative h-48 rounded-2xl overflow-hidden mb-3 shadow-lg"
              >
                <img
                  alt="Burger Suprema"
                  class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                  src="https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=800"
                />
                <div
                  class="absolute top-2 right-2 bg-black/60 backdrop-blur-md px-2 py-0.5 rounded-full border border-white/10"
                >
                  <span class="text-brand-lime font-black text-[10px]"
                    >550 B</span
                  >
                </div>
              </div>
              <h4 class="font-bold text-base text-white">Burger Suprema</h4>
              <p class="text-white/50 text-[10px] mb-3 line-clamp-1">
                Doble carne, cheddar fundido y bacon.
              </p>
              <button
                class="add-to-cart-btn w-full py-2.5 rounded-xl border border-brand-lime/30 text-brand-lime font-bold text-[10px] uppercase hover:bg-brand-lime hover:text-black transition-all"
                data-id="burger-suprema"
                data-name="Burger Suprema"
                data-price="550"
                data-image="https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=800"
                >Agregar</button
              >
            </div>
            <!-- Card 6: Extra 2 -->
            <div
              class="flex-none w-[80vw] sm:w-72 md:w-[calc(25%-1.125rem)] bg-white/5 border border-white/5 rounded-3xl p-4 group transition-all hover:bg-white/8 snap-center hover:-translate-y-2 duration-500 ease-out"
            >
              <div
                class="relative h-48 rounded-2xl overflow-hidden mb-3 shadow-lg"
              >
                <img
                  alt="Dragon Roll"
                  class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                  src="https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=800"
                />
                <div
                  class="absolute top-2 right-2 bg-black/60 backdrop-blur-md px-2 py-0.5 rounded-full border border-white/10"
                >
                  <span class="text-brand-lime font-black text-[10px]"
                    >600 B</span
                  >
                </div>
              </div>
              <h4 class="font-bold text-base text-white">Dragon Roll</h4>
              <p class="text-white/50 text-[10px] mb-3 line-clamp-1">
                Langostinos tempura, aguacate.
              </p>
              <button
                class="add-to-cart-btn w-full py-2.5 rounded-xl border border-brand-lime/30 text-brand-lime font-bold text-[10px] uppercase hover:bg-brand-lime hover:text-black transition-all"
                data-id="dragon-roll"
                data-name="Dragon Roll"
                data-price="600"
                data-image="https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=800"
                >Agregar</button
              >
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Floating Action Button: Scan to Pay / Open Cart -->
    <div
      class="fixed bottom-24 lg:bottom-12 right-6 lg:right-12 z-40 flex flex-col gap-4"
    >
      <!-- Extra Cart Button (Manual) -->
      <button
        id="manual-cart-btn"
        class="bg-[#1a1a1a] hover:bg-white/10 active:scale-95 transition-all w-16 h-16 rounded-full shadow-2xl border border-white/10 flex items-center justify-center text-white relative group"
      >
        <div
          class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold w-6 h-6 rounded-full hidden"
          id="cart-badge-count"
        >
          0
        </div>
        <svg
          class="w-7 h-7"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
          ></path></svg
        >
        <span
          class="absolute right-full mr-4 bg-black/80 px-2 py-1 rounded text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none"
          >Ver Carrito</span
        >
      </button>

      <!-- Orders Button (Desktop/Mobile) - Replacement for QR -->
      <a
        href="/orders"
        id="floating-orders-btn"
        class="bg-brand-lime hover:scale-110 active:scale-95 transition-all w-16 h-16 rounded-full shadow-[0_0_30px_rgba(215,253,73,0.4)] flex items-center justify-center text-black animate-pulse relative group"
      >
        <svg
          class="w-8 h-8"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
          ></path></svg
        >
        <span
          class="absolute right-full mr-4 bg-black/80 px-2 py-1 rounded text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none"
          >Ver Pedidos</span
        >
      </a>
    </div>

    <script>
      // @ts-nocheck
      import { addItemToCart, isCartOpen, cartItems } from "../store/cartStore";
      import { showToast } from "../utils/toast";
      import { fetchAPI, comedorService, authService } from "../services/api";

      console.log("Comedor script loaded (API Integrated + Cached)");

      // State Management
      const DiningState = {
        BROWSING: "browsing",
        PRE_ARRIVAL: "pre_arrival",
        WAITING: "waiting",
        READY: "ready",
      };

      let currentState = DiningState.BROWSING;
      let activeOrder = null;
      let confirmedPresence = false;

      // Cache Config
      const CACHE_KEY = "capypay_menu_cache_v3";
      const CACHE_DURATION = 7 * 24 * 60 * 60 * 1000; // 7 Days (Weekly refresh as requested)

      // Tips Config
      const TIPS = [
        "¡Agrega una malta bien fría para completar tu experiencia!",
        "La hora pico es a las 12:30 PM, ¡llega antes!",
        "Gana doble XP pidiendo el Plato del Día.",
        "Usa el código 'CAPY10' (mentira, no hay códigos aún).",
        "Recarga tu saldo con anticipación para evitar colas.",
      ];

      async function initComedor() {
        try {
          console.log("Initializing Comedor...");

          // Check for active user & orders
          const user = authService.getCurrentUser();
          if (user && user.id) {
            checkActiveOrders(user.id);
          }

          loadStats();
          startStatsTimer(user ? user.id : null);
          startTipRotation();

          // Button Listener: Confirm Presence
          const btnConfirm = document.getElementById("btn-confirm-presence");
          if (btnConfirm) {
            btnConfirm.addEventListener("click", () => {
              confirmedPresence = true;
              localStorage.setItem("capypay_dining_confirmed", "true");
              updateDiningState();
              showToast(
                "¡Bienvenido! Te avisaremos cuando salga tu pedido.",
                "success",
              );
            });
          }

          // Button Listener: Complete Order (Reset)
          const btnComplete = document.getElementById("btn-complete-order");
          if (btnComplete) {
            btnComplete.addEventListener("click", () => {
              // 1. Permanently ignore this completed order ID to prevent loop
              if (activeOrder && activeOrder.id) {
                const dismissed = JSON.parse(
                  localStorage.getItem("capypay_dismissed_orders") || "[]",
                );
                if (!dismissed.includes(activeOrder.id)) {
                  dismissed.push(activeOrder.id);
                  localStorage.setItem(
                    "capypay_dismissed_orders",
                    JSON.stringify(dismissed),
                  );
                }
              }

              activeOrder = null;
              confirmedPresence = false;
              localStorage.removeItem("capypay_dining_confirmed");
              currentState = DiningState.BROWSING;
              updateDiningState();
              showToast("Gracias por usar CapyPay Comedor 🍔", "success");
            });
          }

          // 1. Check Cache
          const cached = localStorage.getItem(CACHE_KEY);
          let menuData = null;
          let useCache = false;

          if (cached) {
            const parsed = JSON.parse(cached);
            if (Date.now() - parsed.timestamp < CACHE_DURATION) {
              console.log("Using Cached Menu");
              menuData = parsed.data;
              useCache = true;
            }
          }

          // 2. Fetch if no cache
          if (!useCache) {
            console.log("Fetching Menu from API...");
            menuData = await fetchAPI("/comedor/menu");
            if (menuData) {
              localStorage.setItem(
                CACHE_KEY,
                JSON.stringify({
                  timestamp: Date.now(),
                  data: menuData,
                }),
              );
            }
          }

          if (menuData) {
            renderPlatoDia(menuData.platoDia);
            renderPopularRotator(menuData.popularItems || []);
            if (menuData.items && Array.isArray(menuData.items)) {
              // Save original list for filtering
              window.allCarouselItems = menuData.items;
              renderCarousel(menuData.items);
            }
            initFilterListeners();
          }
        } catch (e) {
          console.error("Init Error", e);
          showToast("Error cargando el menú", "error");
        }
      }

      function initFilterListeners() {
        const buttons = document.querySelectorAll(".filter-btn");
        buttons.forEach((btn) => {
          btn.addEventListener("click", (e) => {
            // Update active state
            buttons.forEach((b) => {
              b.classList.remove(
                "active",
                "bg-brand-white",
                "text-brand-black",
              );
              b.classList.add("bg-white/5", "text-white/60");
            });
            const target = e.currentTarget;
            target.classList.remove("bg-white/5", "text-white/60");
            target.classList.add(
              "active",
              "bg-brand-white",
              "text-brand-black",
            );

            // Filter Logic
            const category = target.dataset.category;
            const allItems = window.allCarouselItems || [];

            let filtered = allItems;
            if (category !== "all") {
              filtered = allItems.filter((item) => {
                // 1. Prioridad: Categoría explícita del Backend
                if (item.category) {
                  return (
                    item.category.trim().toLowerCase() ===
                    category.toLowerCase()
                  );
                }

                // 2. Fallback: Heurística si no hay categoría definida
                const txt = (item.name + " " + item.description).toLowerCase();
                if (category === "bebida")
                  return (
                    txt.includes("jugo") ||
                    txt.includes("malta") ||
                    txt.includes("agua") ||
                    txt.includes("refresco") ||
                    txt.includes("soda")
                  );
                if (category === "desayuno")
                  return (
                    txt.includes("empanada") ||
                    txt.includes("arepa") ||
                    txt.includes("cachapa") ||
                    txt.includes("teque") ||
                    txt.includes("pastelito")
                  );
                if (category === "almuerzo")
                  return (
                    txt.includes("pabellon") ||
                    txt.includes("pollo") ||
                    txt.includes("carne") ||
                    txt.includes("pasta") ||
                    txt.includes("arroz") ||
                    txt.includes("burger") ||
                    txt.includes("pepito")
                  );
                return true;
              });
            }

            renderCarousel(filtered);
          });
        });
      }

      // --- Core Logic for States ---

      async function checkActiveOrders(userId) {
        try {
          const res = await comedorService.getMyOrders(userId);
          // Check if recent order exists
          if (res && res.orders && res.orders.length > 0) {
            const lastOrder = res.orders[0]; // Most recent

            // Case A: Still cooking
            if (lastOrder.status === "preparing") {
              activeOrder = lastOrder;
              confirmedPresence =
                localStorage.getItem("capypay_dining_confirmed") === "true";
              updateDiningState();
            }
            // Case B: Kitchen Finished it! (But user hasn't dismissed it yet locally)
            else if (lastOrder.status === "completed") {
              // 0. Check if explicitly dismissed (Reset Loop Fix)
              const dismissed = JSON.parse(
                localStorage.getItem("capypay_dismissed_orders") || "[]",
              );
              if (dismissed.includes(lastOrder.id)) {
                // Ignore this order, it was already collected/dismissed
                return;
              }

              // Check if we were previously waiting for this order
              // If 'capypay_dining_confirmed' exists, it means we were tracking it.
              // Or if we check the timestamp to be very recent (< 30 min)
              const wasTracking =
                localStorage.getItem("capypay_dining_confirmed") === "true";
              const isRecent =
                Date.now() - new Date(lastOrder.completed_at).getTime() <
                30 * 60000;

              if (wasTracking || isRecent) {
                activeOrder = lastOrder;
                currentState = DiningState.READY; // Force READY locally
                renderStateUI();

                // Vibrate if fresh
                if (isRecent && navigator.vibrate)
                  navigator.vibrate([200, 100, 200]);
              } else {
                // Allow cleanup
                localStorage.removeItem("capypay_dining_confirmed");
              }
            }
          }
        } catch (e) {
          console.error("Order check failed", e);
        }
      }

      function updateDiningState() {
        if (!activeOrder) {
          currentState = DiningState.BROWSING;
        } else if (!confirmedPresence) {
          currentState = DiningState.PRE_ARRIVAL;
        } else {
          // We are confirmed, but are we ready?
          // Need stats to know
          // For now set to WAITING, stats update will upgrade to READY
          currentState = DiningState.WAITING;
        }

        renderStateUI();
      }

      function renderStateUI() {
        console.log("Rendering State:", currentState);

        // Helper to toggle visibility
        const show = (id) =>
          document.getElementById(id)?.classList.remove("hidden", "flex");
        const hide = (id) =>
          document.getElementById(id)?.classList.add("hidden");
        const showFlex = (id) => {
          const el = document.getElementById(id);
          if (el) {
            el.classList.remove("hidden");
            el.classList.add("flex");
          }
        };

        // Reset all views
        [
          "view-browsing-occupied",
          "view-waiting-rhythm",
          "view-browsing-time",
          "view-pre-arrival",
          "view-waiting-position",
          "view-ready",
        ].forEach(hide);

        // Note: We no longer manipulate the container classes directly to prevent layout shifts.
        // The inner views (e.g. view-ready) cover the container with absolute positioning and own styles.

        if (currentState === DiningState.BROWSING) {
          showFlex("view-browsing-occupied");
          showFlex("view-browsing-time");
        } else if (currentState === DiningState.PRE_ARRIVAL) {
          showFlex("view-browsing-occupied"); // Keep general stats
          showFlex("view-pre-arrival");

          if (activeOrder) {
            const el = document.getElementById("my-ticket-id");
            if (el) el.innerText = `#${activeOrder.id.toString().slice(0, 4)}`;
          }
        } else if (currentState === DiningState.WAITING) {
          showFlex("view-waiting-rhythm");
          showFlex("view-waiting-position");
        } else if (currentState === DiningState.READY) {
          showFlex("view-waiting-rhythm"); // Still useful to see kitchen rhythm
          showFlex("view-ready");

          if (activeOrder) {
            const el = document.getElementById("ready-ticket-id");
            if (el) el.innerText = `#${activeOrder.id.toString().slice(0, 4)}`;
          }
        }
      }

      let lastStatsUpdate = Date.now();

      async function loadStats() {
        try {
          // Pass activeOrder.id if available to get accurate position
          let query = "";
          if (activeOrder && activeOrder.id) {
            query = `?orderId=${activeOrder.id}`;
          }

          const stats = await fetchAPI(`/comedor/stats${query}`);

          if (stats) {
            lastStatsUpdate = Date.now();
            updateStatsUI(stats);

            // Re-evaluate State if we have an active order
            if (activeOrder && confirmedPresence) {
              // Use backend provided turnsAhead if available
              if (stats.turnsAhead !== undefined && stats.turnsAhead !== null) {
                const diff = stats.turnsAhead;
                const countEl = document.getElementById("people-ahead-count");
                const labelEl = document.getElementById("label-people-ahead");

                if (diff === 0) {
                  // Message for 0 turns
                  if (countEl) {
                    countEl.innerText = "YA!";
                    countEl.classList.remove("text-6xl");
                    countEl.classList.add("text-5xl", "text-brand-lime");
                  }
                  if (labelEl) {
                    labelEl.innerText = "¡Eres el siguiente!";
                    labelEl.classList.add(
                      "text-brand-lime",
                      "font-black",
                      "animate-pulse",
                    );
                    labelEl.classList.remove("text-white/60");
                  }
                } else {
                  // Standard count
                  if (countEl) {
                    countEl.innerText = diff;
                    countEl.classList.add("text-6xl");
                    countEl.classList.remove("text-5xl", "text-brand-lime");
                  }
                  if (labelEl) {
                    labelEl.innerText = "Personas delante";
                    labelEl.classList.remove(
                      "text-brand-lime",
                      "font-black",
                      "animate-pulse",
                    );
                    labelEl.classList.add("text-white/60");
                  }
                }

                // Dynamic Glow Logic
                const proxGlow = document.getElementById("proximity-glow");
                const normGlow = document.getElementById("normal-glow");

                if (diff >= 0 && diff < 5) {
                  if (proxGlow) proxGlow.classList.remove("hidden");
                  if (normGlow) normGlow.classList.add("hidden");
                } else {
                  if (proxGlow) proxGlow.classList.add("hidden");
                  if (normGlow) normGlow.classList.remove("hidden");
                }

                const waitEl = document.getElementById("waiting-time-detail");
                if (waitEl) {
                  if (diff === 0) {
                    waitEl.innerText = "¡Tu pedido estará listo pronto!";
                  } else {
                    const mins = (diff > 0 ? diff : 0) * 3;
                    waitEl.innerText = `Aprox ${mins} min`;
                  }
                }
              }
            }
          }
        } catch (e) {
          console.error("Stats Error", e);
        }
      }

      function updateStatsUI(stats) {
        const ocupacionText = document.getElementById("ocupacion-text");
        const ocupacionBar = document.getElementById("ocupacion-bar");
        const ocupacionDetail = document.getElementById("ocupacion-detail");
        const ocupacionStatus = document.getElementById("ocupacion-status");

        // Update Queue Card
        if (ocupacionText) {
          ocupacionText.innerText =
            stats.ocupacion.count !== undefined ? stats.ocupacion.count : "--";
        }

        // Update Dots Animation & Tiers
        const pingDot = document.getElementById("ping-dot");
        const staticDot = document.getElementById("static-dot");

        let colorClass = "bg-brand-lime";
        let textClass = "text-brand-lime";
        let barClass = "bg-brand-lime";

        const nivel = stats.ocupacion.nivel;
        if (nivel === "Full") {
          colorClass = "bg-red-500";
          barClass = "bg-red-500";
          textClass = "text-red-500";
        } else if (nivel === "Alta") {
          colorClass = "bg-orange-500";
          barClass = "bg-orange-500";
          textClass = "text-orange-500";
        } else if (nivel === "Media") {
          colorClass = "bg-yellow-400";
          barClass = "bg-yellow-400";
          textClass = "text-yellow-400";
        }

        if (pingDot && staticDot) {
          pingDot.className = `animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${colorClass}`;
          staticDot.className = `relative inline-flex rounded-full h-2.5 w-2.5 ${colorClass}`;
        }

        if (ocupacionStatus) {
          ocupacionStatus.innerText = stats.ocupacion.nivel;
          ocupacionStatus.className = `text-[10px] font-bold ${textClass}`;
        }

        if (ocupacionBar) {
          ocupacionBar.style.width = `${stats.ocupacion.porcentaje}%`;
          ocupacionBar.className = `h-full transition-all duration-1000 ${barClass}`;
        }

        if (ocupacionDetail) {
          ocupacionDetail.innerText = stats.ocupacion.detalle;
        }

        // Update Time Card
        const esperaText = document.getElementById("espera-text");
        if (esperaText) esperaText.innerText = stats.tiempoEspera;

        const turnoText = document.getElementById("turno-text");
        if (turnoText) turnoText.innerText = stats.proximoTurno;
      }

      function startStatsTimer(userId) {
        setInterval(() => {
          // Live Refresh of stats every 10s
          loadStats();
          if (userId) checkActiveOrders(userId);

          // Also update timestamp text if needed
          const ocupacionDetail = document.getElementById("ocupacion-detail");
          if (ocupacionDetail && ocupacionDetail.dataset.original) {
            const diffMins = Math.floor((Date.now() - lastStatsUpdate) / 60000);
            // ocupacionDetail.innerText = `${ocupacionDetail.dataset.original} • Hace ${diffMins} min`;
          }
        }, 10000); // 10 seconds for live feel
      }

      function startTipRotation() {
        let index = 0;
        const tipEl = document.getElementById("capy-tip-text");
        if (!tipEl) return;

        setInterval(() => {
          index = (index + 1) % TIPS.length;
          // Fade out
          tipEl.style.opacity = "0";
          setTimeout(() => {
            tipEl.innerText = TIPS[index];
            // Fade in
            tipEl.style.opacity = "1";
          }, 300);
        }, 8000); // Rotate every 8s
      }

      function renderPlatoDia(item) {
        const container = document.getElementById("plato-dia-container");
        if (!container) return;
        if (!item) {
          container.innerHTML =
            '<div class="h-96 flex items-center justify-center text-white/40 italic">No hay plato del día disponible hoy.</div>';
          return;
        }
        container.innerHTML = `
        <div class="grid h-min w-full overflow-hidden rounded-3xl border border-white/10 bg-[#1c2210] shadow-2xl" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
            <div class="relative h-64 sm:h-auto min-h-[280px] w-full">
                <div class="absolute inset-0 bg-linear-to-t md:bg-linear-to-r from-[#0a0a0a] via-transparent to-transparent z-10 opacity-70"></div>
                <img alt="${item.name}" class="absolute inset-0 w-full h-full object-cover" style="width:100%; height:100%;" src="${item.image_url || "https://images.unsplash.com/photo-1546069901-ba9599a7e63c"}" />
                <div class="absolute top-4 left-4 z-20">
                    <span class="bg-brand-lime text-black text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest shadow-xl flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
                    PLATO DEL DÍA • DOBLA TUS PUNTOS
                    </span>
                </div>
            </div>
            
            <div class="p-6 md:p-8 flex flex-col justify-center bg-[#1c2210] w-full box-border">
              <h3 class="text-2xl md:text-3xl font-extrabold mb-3 leading-tight text-white line-clamp-2">${item.name}</h3>
              <p class="text-white/70 text-sm md:text-base mb-6 font-medium line-clamp-3 leading-relaxed">${item.description}</p>
              
              <div class="flex items-center justify-between mt-auto gap-4 pt-4 border-t border-white/5">
                  <div class="flex flex-col relative group/tooltip cursor-help">
                    <span class="text-[10px] text-white/40 font-bold uppercase tracking-wider">PRECIO</span>
                    ${
                      parseFloat(item.price) === 0
                        ? `<p class="text-3xl font-black text-brand-lime whitespace-nowrap">GRATIS</p>`
                        : `<p class="text-3xl font-black text-brand-lime whitespace-nowrap">${item.price} BARAS</p>`
                    }
                    
                    <!-- Tooltip -->
                    <div class="absolute bottom-full left-0 mb-2 hidden group-hover/tooltip:block w-48 bg-black/90 text-white text-[10px] p-2 rounded-lg border border-white/10 shadow-xl z-30">
                        <p class="font-bold mb-1">Costo de Gestión: 5%</p>
                        <p class="text-white/60">Este monto simbólico ayuda al mantenimiento de la plataforma digital.</p>
                        <div class="absolute -bottom-1 left-4 w-2 h-2 bg-black/90 rotate-45 border-r border-b border-white/10"></div>
                    </div>
                  </div>
                  <button class="add-to-cart-btn bg-white text-black hover:bg-brand-lime font-black px-6 py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 text-xs uppercase tracking-widest hover:scale-105 active:scale-95 transition-all"
                  data-id="${item.id}" data-name="${item.name}" data-price="${item.price}" data-image="${item.image_url}">
                    <span>AÑADIR</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                  </button>
              </div>
            </div>
        </div>
        `;
        const btn = container.querySelector(".add-to-cart-btn");
        if (btn) attachCartListener(btn);
      }

      function renderCarousel(items) {
        const scrollContainer = document.getElementById("carousel-container");
        if (!scrollContainer) return;
        scrollContainer.innerHTML = "";
        if (items.length === 0) {
          scrollContainer.innerHTML =
            '<div class="w-full text-center text-white/50 p-10">No hay productos disponibles por ahora.</div>';
          return;
        }
        const cardTemplate = (item) => `
          <div class="flex-none w-[80vw] sm:w-72 md:w-[calc(25%-1.125rem)] bg-white/5 border border-white/5 rounded-2xl md:rounded-3xl p-3 md:p-4 group transition-all hover:bg-white/8 snap-center hover:-translate-y-2 duration-500 ease-out flex flex-col text-center">
            <div class="relative h-32 md:h-48 rounded-xl md:rounded-2xl overflow-hidden mb-2 md:mb-3 shadow-lg shrink-0">
              <img alt="${item.name}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" src="${item.image_url || "https://images.unsplash.com/photo-1546069901-ba9599a7e63c"}" />
              <div class="absolute top-2 right-2 bg-black/60 backdrop-blur-md px-1.5 py-0.5 rounded-full border border-white/10">
                <span class="text-brand-lime font-black text-[9px] md:text-[10px]">${item.price} B</span>
              </div>
            </div>
            <h4 class="font-bold text-xs md:text-base text-white leading-tight mb-1 truncate px-1">${item.name}</h4>
            <div class="grow mb-2 md:mb-3 w-full">
                <p class="text-white/50 text-[9px] md:text-[10px] line-clamp-2 leading-tight px-1">${item.description}</p>
            </div>
            <button class="add-to-cart-btn w-full py-1.5 md:py-2.5 rounded-lg md:rounded-xl border border-brand-lime/30 text-brand-lime font-bold text-[9px] md:text-[10px] uppercase hover:bg-brand-lime hover:text-black transition-all mt-auto flex items-center justify-center gap-1"
              data-id="${item.id}" data-name="${item.name}" data-price="${item.price}" data-image="${item.image_url}">
              <span>Agregar</span>
            </button>
          </div>
        `;
        const createCard = (item) => {
          const x = document.createElement("div");
          x.innerHTML = cardTemplate(item);
          return x.firstElementChild;
        };

        const set = items.map(createCard);
        set.forEach((card) => {
          scrollContainer.appendChild(card);
          const btn = card.querySelector(".add-to-cart-btn");
          if (btn) attachCartListener(btn);
        });

        if (items.length >= 3) {
          // Simple cloning for infinite feeling if plenty items
          const set2 = items.map(createCard);
          const set3 = items.map(createCard);
          [...set2, ...set3].forEach((card) => {
            scrollContainer.appendChild(card);
            const btn = card.querySelector(".add-to-cart-btn");
            if (btn) attachCartListener(btn);
          });
          initInfiniteScroll(items.length);
        }
      }

      function attachCartListener(btn) {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const target = e.currentTarget;
          const item = {
            id: target.dataset.id,
            name: target.dataset.name,
            price: parseInt(target.dataset.price || "0"),
            image: target.dataset.image,
          };
          addItemToCart(item);
          isCartOpen.set(true);
          showToast(`¡${item.name} agregado! 🍔`, "success");
        });
      }

      // --- Cart Badge Logic ---
      const manualCartBtn = document.getElementById("manual-cart-btn");
      const cartBadge = document.getElementById("cart-badge-count");

      cartItems.subscribe((items) => {
        const count = Object.values(items).reduce(
          (acc, item) => acc + item.quantity,
          0,
        );
        if (cartBadge) {
          cartBadge.textContent = count.toString();
          if (count > 0) {
            cartBadge.classList.remove("hidden");
            cartBadge.classList.add("flex", "items-center", "justify-center");
          } else {
            cartBadge.classList.add("hidden");
            cartBadge.classList.remove(
              "flex",
              "items-center",
              "justify-center",
            );
          }
        }
        if (count > 0 && manualCartBtn) {
          manualCartBtn.classList.add("scale-110");
          setTimeout(() => manualCartBtn.classList.remove("scale-110"), 200);
        }
      });

      if (manualCartBtn) {
        manualCartBtn.addEventListener("click", () => isCartOpen.set(true));
      }

      // --- Infinite Scroll Helper ---
      function initInfiniteScroll(count) {
        const scrollContainer = document.getElementById("carousel-container");
        const btnLeft = document.getElementById("scroll-left");
        const btnRight = document.getElementById("scroll-right");

        if (!scrollContainer || !btnLeft || !btnRight) return;

        const getCardWidth = () => {
          const card = scrollContainer.children[0];
          if (!card) return 0;
          const style = window.getComputedStyle(scrollContainer);
          const gap = parseFloat(style.gap) || 24;
          return card.clientWidth + gap;
        };

        setTimeout(() => {
          const width = getCardWidth();
          if (width > 0) {
            const singleSetWidth = width * count;
            scrollContainer.scrollLeft = singleSetWidth;
          }
        }, 100);

        scrollContainer.addEventListener("scroll", () => {
          const width = getCardWidth();
          if (width === 0) return;
          const singleSetWidth = width * count;
          // teleport
          if (scrollContainer.scrollLeft < 50) {
            scrollContainer.scrollLeft += singleSetWidth;
          } else if (scrollContainer.scrollLeft > singleSetWidth * 2 - 50) {
            scrollContainer.scrollLeft -= singleSetWidth;
          }
        });

        const smoothScroll = (element, change, duration) => {
          const start = element.scrollLeft;
          const startTime = performance.now();
          const easeInOutCubic = (t) =>
            t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;

          const animateScroll = (currentTime) => {
            const timeElapsed = currentTime - startTime;
            let progress = timeElapsed / duration;
            if (progress > 1) progress = 1;
            element.scrollLeft = start + change * easeInOutCubic(progress);
            if (progress < 1) requestAnimationFrame(animateScroll);
          };
          requestAnimationFrame(animateScroll);
        };

        btnLeft.onclick = () =>
          smoothScroll(scrollContainer, -getCardWidth() * 2, 600);
        btnRight.onclick = () =>
          smoothScroll(scrollContainer, getCardWidth() * 2, 600);
      }

      // 🛠️ DEV TOOLS: SIMULACIÓN VS REALIDAD

      // 1. Simulación Local (Solo UI)
      window.simularPedidoListo = () => {
        console.log("⏩ Simulando avance de cocina (UI ONLY)...");
        if (!activeOrder) {
          activeOrder = { id: 777, status: "preparing" };
          confirmedPresence = true;
        }
        currentState = DiningState.READY;
        renderStateUI();
        showToast("🔔 ¡DING! Tu pedido está listo (Simulación)", "success");
        if (navigator.vibrate) navigator.vibrate([400, 100, 200, 100, 400]);
      };

      // 2. Avance Real (Backend) - ¡Limpia la cola!
      window.avanzarCocinaReal = async () => {
        try {
          showToast("👨‍🍳 Avanzando cocina en servidor...", "info");
          const res = await fetchAPI("/comedor/complete-all", {
            method: "POST",
          });
          if (res && res.count !== undefined) {
            showToast(
              `✅ ¡Listo! ${res.count} órdenes completadas.`,
              "success",
            );
            // Recargar estado
            loadStats();
            checkActiveOrders(authService.getCurrentUser()?.id);
          }
        } catch (e) {
          console.error(e);
          showToast("Error conectando con cocina", "error");
        }
      };

      // Truco: Triple click en el título para activar simulación en móvil sin consola
      const titleEl = document.querySelector("h2");
      if (titleEl) {
        let clicks = 0;
        titleEl.addEventListener("click", () => {
          clicks++;
          if (clicks === 3) {
            window.simularPedidoListo();
            clicks = 0;
          }
          setTimeout(() => (clicks = 0), 1000);
        });
      }

      function renderPopularRotator(items) {
        const container = document.getElementById("popular-rotator");
        const indicators = document.getElementById("pop-indicators");

        if (!container || !items || items.length === 0) {
          if (container)
            container.innerHTML =
              '<div class="h-full flex items-center justify-center flex-col text-white/30 italic"><span>Aún no hay tendencias.</span><span class="text-xs mt-2">¡Sé el primero en pedir!</span></div>';
          if (indicators) indicators.style.display = "none";
          return;
        }

        container.innerHTML = "";
        if (indicators) indicators.innerHTML = "";

        let currentIndex = 0;
        let timer = null;

        // Create Slides
        items.forEach((item, idx) => {
          // Slide
          const slide = document.createElement("div");
          slide.className = `absolute inset-0 w-full h-full transition-all duration-700 ease-in-out flex flex-col md:flex-row bg-[#1c2210] ${idx === 0 ? "opacity-100 translate-x-0 z-10 pointer-events-auto" : "opacity-0 translate-x-full z-0 pointer-events-none"}`;
          slide.innerHTML = `
                <div class="relative w-full md:w-1/2 h-1/2 md:h-full overflow-hidden">
                    <div class="absolute inset-0 bg-linear-to-t md:bg-linear-to-r from-[#0a0a0a] via-transparent to-transparent z-10 opacity-60"></div>
                     <img src="${item.image_url || "https://images.unsplash.com/photo-1546069901-ba9599a7e63c"}" class="w-full h-full object-cover transform hover:scale-105 transition-transform duration-1000" alt="${item.name}">
                     <div class="absolute top-4 left-4 z-20 bg-orange-500/90 text-white text-[10px] font-bold px-2 py-1 rounded-md shadow-lg flex items-center gap-1 backdrop-blur-md">
                        🔥 TOP #${idx + 1}
                     </div>
                </div>
                <div class="w-full md:w-1/2 h-1/2 md:h-full p-6 md:p-10 flex flex-col justify-center relative">
                    <!-- Background Gloss -->
                    <div class="absolute top-0 right-0 w-64 h-64 bg-orange-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

                    <h3 class="text-2xl md:text-3xl font-black text-white mb-2 leading-tight line-clamp-2">${item.name}</h3>
                    <p class="text-white/60 text-xs md:text-sm font-medium mb-6 line-clamp-3 leading-relaxed">${item.description || "Delicioso plato preparado con los mejores ingredientes del campus."}</p>
                    
                    <div class="mt-auto flex items-center gap-4 relative z-20">
                        <span class="text-2xl font-bold text-white">$${item.price}</span>
                        <button class="pop-add-btn bg-white text-black hover:bg-orange-500 hover:text-white transition-colors duration-300 font-bold uppercase tracking-widest text-[10px] md:text-xs px-6 py-3 rounded-xl shadow-lg flex-1 md:flex-none flex items-center justify-center gap-2 group cursor-pointer" 
                          data-id="${item.id}" 
                          data-name="${item.name}" 
                          data-price="${item.price}" 
                          data-image="${item.image_url || ""}">
                            PEDIR AHORA
                            <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                        </button>
                    </div>
                </div>
              `;
          container.appendChild(slide);

          // Indicator
          if (indicators) {
            const dot = document.createElement("button");
            dot.className = `h-1.5 rounded-full transition-all duration-300 ${idx === 0 ? "bg-orange-500 w-6" : "bg-white/20 w-1.5 hover:bg-white/40"}`;
            dot.onclick = () => {
              resetTimer();
              goToSlide(idx);
            };
            indicators.appendChild(dot);
          }
        });

        // Re-attach specific listeners
        container.querySelectorAll(".pop-add-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopImmediatePropagation();
            const t = e.currentTarget;
            const item = {
              id: t.getAttribute("data-id"),
              name: t.getAttribute("data-name"),
              price: parseInt(t.getAttribute("data-price") || "0"),
              image: t.getAttribute("data-image"),
              quantity: 1,
            };
            addItemToCart(item);
            isCartOpen.set(true);
            showToast(`¡${item.name} es muy popular! 🔥`, "success");
          });
        });

        function updateSlides() {
          const slides = container.children;
          if (!indicators) return;
          const dots = indicators.children;

          for (let i = 0; i < slides.length; i++) {
            if (i === currentIndex) {
              slides[i].classList.remove(
                "opacity-0",
                "translate-x-full",
                "pointer-events-none",
              );
              slides[i].classList.add(
                "opacity-100",
                "translate-x-0",
                "z-10",
                "pointer-events-auto",
              );
              if (dots[i])
                dots[i].className =
                  "h-1.5 rounded-full transition-all duration-300 bg-orange-500 w-6";
            } else {
              slides[i].classList.remove(
                "opacity-100",
                "translate-x-0",
                "z-10",
                "pointer-events-auto",
                "translate-x-full",
              );
              slides[i].classList.add(
                "opacity-0",
                "translate-x-full",
                "z-0",
                "pointer-events-none",
              );
              if (dots[i])
                dots[i].className =
                  "h-1.5 rounded-full transition-all duration-300 bg-white/20 w-1.5 hover:bg-white/40";
            }
          }
        }

        function nextSlide() {
          currentIndex = (currentIndex + 1) % items.length;
          updateSlides();
        }

        function goToSlide(idx) {
          currentIndex = idx;
          updateSlides();
        }

        function resetTimer() {
          if (timer) clearInterval(timer);
          timer = setInterval(nextSlide, 5000); // 5 Seconds Rotation
        }

        // Init Timer
        resetTimer();
      }

      // Init Logic
      initComedor();
    </script>
  </div>
</MainLayout>
