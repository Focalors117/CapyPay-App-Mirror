---
import "../styles/landing.css";
// import "../styles/global.css"; // Disable Tailwind for this page if possible or ensure CSS specificity
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>Iniciar Sesión | CapyPay</title>
  </head>
  <body>
     <header class="main-header">
       <div class="header-container">
         <div class="logo">
           <a href="/">
             <img
               src="/assets/landing/vectors/logocapinamedbottom.svg"
               alt="CapyPay Logo"
               style="width: 76px; height: 91.48px;"
             />
           </a>
         </div>
       </div>
     </header>

     <a href="/" class="btn-regresar">
       <span>&lt;</span>
       <span>Regresar</span>
     </a>

    <main>
      <div class="contenedor-registro">
        <div class="texto-hero">
          <h1 class="titulo-hackea">
            REGRESA A <br />
            TU MUNDO. <br />
          </h1>
          <p class="subtitulo-cero">CAPY WORLD</p>
        </div>

        <div class="card-registro">
          <h2>INICIAR SESIÓN</h2>

          <form class="form-neubrutalist" id="login-form">
            <div class="input-group">
              <label>Correo Electrónico</label>
              <input
                type="email"
                id="email"
                placeholder="Introduce tu correo"
              />
            </div>

            <div class="input-group">
              <label>Contraseña</label>
              <input
                type="password"
                id="password"
                placeholder="Introduce tu contraseña"
              />
            </div>

            <div
              id="error-msg"
              style="color: red; text-align: center; font-family: 'Baloo Bhaijaan 2'; margin-bottom: 10px; display: none;"
            >
            </div>

            <p class="login-link">
              ¿No tienes una cuenta? <a
                href="/registro"
                style="text-decoration: none; font-weight: bold;">Regístrate</a
              >
            </p>

            <button type="button" id="login-btn" class="btn-sumate"
              >¡Entrar Ahora!</button
            >
          </form>
        </div>
      </div>

      <!-- Usando rutas relativas a public/assets/landing/vectors -->
      <img
        src="/assets/landing/vectors/manodosdedos.svg"
        class="ilustracion-libre"
        alt="Mano"
      />
      <img
        src="/assets/landing/vectors/vectormoneda.svg"
        class="ilustracion-fondo"
        alt="Monedas Fondo"
      />
      <img
        src="/assets/landing/vectors/vectormoneda.svg"
        class="ilustracion-libre espejo"
        alt="Mano Espejo"
      />

      <script>
        // @ts-nocheck
        import { authService } from "../services/api.js";

        const btn = document.getElementById("login-btn");
        const emailInput = document.getElementById("email");
        const passInput = document.getElementById("password");
        const errorMsg = document.getElementById("error-msg");
        const form = document.getElementById("login-form");

        const handleLogin = async () => {
          // UI Update
          const originalText = btn.innerText;
          btn.disabled = true;
          btn.innerText = "Conectando...";
          btn.style.opacity = "0.7";

          if (errorMsg) errorMsg.style.display = "none";
          if (errorMsg) errorMsg.innerText = "";

          const email = emailInput?.value;
          const password = passInput?.value;

          if (!email || !password) {
            if (errorMsg) {
              errorMsg.innerText = "Por favor completa todos los campos";
              errorMsg.style.display = "block";
            }
            btn.disabled = false;
            btn.innerText = originalText;
            btn.style.opacity = "1";
            return;
          }

          try {
            console.log("Iniciando login con:", email);
            const response = await authService.login(email, password);
            console.log("Respuesta login:", response);

            // Éxito
            btn.innerText = "¡Éxito! Redirigiendo...";

            setTimeout(() => {
              window.location.href = "/dashboard";
            }, 500);
          } catch (error) {
            console.error(error);
            if (errorMsg) {
              errorMsg.innerText =
                error.message || "Error al conectar con el servidor";
              errorMsg.style.display = "block";
            }

            // Reset botón
            btn.disabled = false;
            btn.innerText = originalText;
            btn.style.opacity = "1";
          }
        };

        if (btn) btn.addEventListener("click", handleLogin);
        // Allow Enter key to submit
        if (form)
          form.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              handleLogin();
            }
          });
      </script>
    </main>
  </body>
</html>
