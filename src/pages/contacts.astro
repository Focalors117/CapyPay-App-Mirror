---
import MainLayout from "../layouts/MainLayout.astro";
---

<MainLayout title="Contactos | CapyPay">
  <div class="flex flex-col gap-6 h-full p-4 lg:p-0 relative">
    <!-- 1. Header Area (Title + New Btn + Search + Filters) -->
    <div class="flex flex-col gap-6">
      <!-- Top Row: Title & Add Button -->
      <div
        class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4"
      >
        <div>
          <h1 class="text-3xl font-bold text-white mb-2">Contactos</h1>
          <p class="text-slate-400 text-sm">
            Gestiona tus destinatarios frecuentes y favoritos.
          </p>
        </div>
        <button
          id="btn-open-modal"
          class="bg-[#2a2a2a] hover:bg-[#333] text-white px-5 py-2.5 rounded-xl font-medium transition-all flex items-center gap-2 border border-white/10 group cursor-pointer"
        >
          <div
            class="w-5 h-5 rounded-full bg-brand-lime/20 flex items-center justify-center text-brand-lime group-hover:bg-brand-lime group-hover:text-black transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-3 w-3"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="3"
                d="M12 4v16m8-8H4"></path>
            </svg>
          </div>
          <span>AÃ±adir Nuevo</span>
        </button>
      </div>

      <!-- Second Row: Search & Filters -->
      <div
        class="flex flex-col md:flex-row gap-4 justify-between items-center bg-[#0f1012] p-2 rounded-2xl border border-white/5"
      >
        <!-- Search Input -->
        <div class="relative w-full md:w-96 group">
          <input
            type="text"
            id="search-input"
            placeholder="Buscar por nombre, cÃ©dula o alias..."
            class="w-full bg-[#1a1a1a] text-white text-sm rounded-xl pl-10 pr-4 py-3 border border-transparent focus:border-brand-lime/30 focus:bg-black transition-all placeholder:text-slate-600 outline-none"
          />
          <div
            class="absolute left-0 top-0 h-full w-10 flex items-center justify-center text-slate-600 group-focus-within:text-brand-lime transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
        </div>

        <!-- Filter Tabs -->
        <div class="flex p-1 bg-[#1a1a1a] rounded-xl self-stretch md:self-auto">
          <button
            class="px-5 py-2 rounded-lg text-xs font-bold bg-brand-lime text-black shadow-lg transition-all filter-btn"
            data-filter="all">Todos</button
          >
          <button
            class="px-5 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-white transition-all filter-btn"
            data-filter="recent">Recientes</button
          >
          <button
            class="px-5 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-white transition-all filter-btn"
            data-filter="favorites">Favoritos</button
          >
        </div>
      </div>
    </div>

    <!-- 2. Content Grid -->
    <div
      id="contacts-grid"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 flex-1 overflow-y-auto custom-scrollbar content-start pb-20 mt-2"
    >
      <!-- Loading State -->
      <div class="col-span-full flex justify-center py-20 text-slate-500">
        <div class="animate-pulse flex flex-col items-center gap-2">
          <div
            class="w-8 h-8 border-2 border-brand-lime/30 border-t-brand-lime rounded-full animate-spin"
          >
          </div>
          <span>Cargando contactos...</span>
        </div>
      </div>
      <!-- Contacts will be injected here via JS -->
    </div>
  </div>

  <!-- 3. Modal Nuevo Contacto (Hidden by default) -->
  <div
    id="modal-add-contact"
    class="fixed inset-0 z-60 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300"
  >
    <div
      class="bg-[#121212] w-full max-w-md rounded-3xl border border-white/10 p-6 shadow-2xl transform scale-95 transition-transform duration-300 relative overflow-hidden"
    >
      <!-- Decoration -->
      <div
        class="absolute -top-20 -left-20 w-40 h-40 bg-brand-lime/5 rounded-full blur-3xl"
      >
      </div>

      <h2
        class="text-xl font-bold text-white mb-4 relative z-10 flex items-center gap-2"
      >
        <div
          class="w-8 h-8 rounded-full bg-brand-lime flex items-center justify-center text-black"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"
            ></path>
          </svg>
        </div>
        AÃ±adir Contacto
      </h2>

      <form id="form-add-contact" class="flex flex-col gap-4 relative z-10">
        <!-- Input Cedula with Live Search -->
        <div class="relative group/input">
          <label
            class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2"
            >CÃ©dula del Usuario</label
          >
          <div class="relative">
            <input
              type="text"
              id="input-cedula"
              name="cedula"
              required
              autocomplete="off"
              placeholder="Ej: 8459201"
              class="w-full bg-[#0a0a0a] border border-white/10 rounded-xl px-4 py-3.5 text-white focus:border-brand-lime/50 focus:outline-none transition-all placeholder:text-slate-700"
            />
            <div class="absolute right-3 top-3 text-slate-600">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
          </div>

          <!-- Suggestions Dropdown -->
          <div
            id="cedula-suggestions"
            class="absolute left-0 right-0 top-full mt-2 bg-[#1a1a1a] border border-white/10 rounded-xl shadow-2xl max-h-48 overflow-y-auto hidden z-50 custom-scrollbar"
          >
            <!-- Items injected via JS -->
          </div>
        </div>

        <!-- Input Alias -->
        <div>
          <label
            class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2"
            >Alias (Opcional)</label
          >
          <input
            type="text"
            name="alias"
            placeholder="Ej: El Jefe, MamÃ¡, etc."
            class="w-full bg-[#0a0a0a] border border-white/10 rounded-xl px-4 py-3.5 text-white focus:border-brand-lime/50 focus:outline-none transition-all placeholder:text-slate-700"
          />
        </div>

        <!-- Error Message -->
        <div
          id="add-error"
          class="hidden text-red-400 text-sm bg-red-500/10 p-3 rounded-lg border border-red-500/20 items-center gap-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
          >
          <span id="add-error-text">Error</span>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 justify-end mt-4 pt-4 border-t border-white/5">
          <button
            type="button"
            id="btn-close-modal"
            class="px-5 py-2.5 text-slate-400 hover:text-white transition-colors cursor-pointer text-sm font-medium"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="bg-brand-lime hover:bg-[#bce628] text-black px-6 py-2.5 rounded-xl font-bold transition-all shadow-[0_0_15px_rgba(215,253,73,0.3)] hover:shadow-[0_0_25px_rgba(215,253,73,0.5)] cursor-pointer text-sm flex items-center gap-2"
          >
            Guardar Contacto
          </button>
        </div>
      </form>
    </div>
  </div>
</MainLayout>

<script>
  // @ts-nocheck
  import { userService } from "../services/api.js";

  // --- DOM ELEMENTS ---
  const grid = document.getElementById("contacts-grid");
  const searchInput = document.getElementById("search-input");
  const filterBtns = document.querySelectorAll(".filter-btn");

  // Modal
  const modal = document.getElementById("modal-add-contact");
  const btnOpen = document.getElementById("btn-open-modal");
  const btnClose = document.getElementById("btn-close-modal");
  const form = document.getElementById("form-add-contact");
  const errorContainer = document.getElementById("add-error");
  const errorText = document.getElementById("add-error-text");

  // Live Search
  const inputCedula = document.getElementById("input-cedula");
  const suggestionsBox = document.getElementById("cedula-suggestions");

  // --- STATE ---
  let allContacts = [];
  let currentFilter = "all";

  // --- MODAL LOGIC ---
  function toggleModal(show) {
    if (!modal) return;
    if (show) {
      modal.classList.remove("opacity-0", "pointer-events-none");
      const inner = modal.querySelector("div");
      if (inner) {
        inner.classList.remove("scale-95");
        inner.classList.add("scale-100");
      }
      if (inputCedula) inputCedula.focus();
    } else {
      modal.classList.add("opacity-0", "pointer-events-none");
      const inner = modal.querySelector("div");
      if (inner) {
        inner.classList.remove("scale-100");
        inner.classList.add("scale-95");
      }
      if (form) form.reset();
      if (errorContainer) errorContainer.classList.add("hidden");
      if (suggestionsBox) suggestionsBox.classList.add("hidden");
    }
  }

  if (btnOpen) btnOpen.addEventListener("click", () => toggleModal(true));
  if (btnClose) btnClose.addEventListener("click", () => toggleModal(false));

  // --- LIVE SEARCH (AUTOCOMPLETE) ---
  let debounceTimer;
  if (inputCedula && suggestionsBox) {
    inputCedula.addEventListener("input", (e) => {
      const target = e.target;
      const val = target.value.trim();
      clearTimeout(debounceTimer);

      if (val.length < 2) {
        suggestionsBox.classList.add("hidden");
        return;
      }

      debounceTimer = setTimeout(async () => {
        try {
          const results = await userService.searchUsers(val);
          renderSuggestions(results);
        } catch (err) {
          console.error("Search error", err);
        }
      }, 300);
    });

    // Close on click outside
    document.addEventListener("click", (e) => {
      if (
        !inputCedula.contains(e.target) &&
        !suggestionsBox.contains(e.target)
      ) {
        suggestionsBox.classList.add("hidden");
      }
    });
  }

  function renderSuggestions(users) {
    if (!suggestionsBox) return;
    if (!users || users.length === 0) {
      suggestionsBox.classList.add("hidden");
      return;
    }

    suggestionsBox.innerHTML = "";
    users.forEach((u) => {
      const item = document.createElement("div");
      item.className =
        "px-4 py-3 hover:bg-brand-lime/10 cursor-pointer border-b border-white/5 last:border-0 flex flex-col transition-colors group";
      item.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-white text-sm font-bold group-hover:text-brand-lime transition-colors">${u.cedula}</span>
                    <span class="text-[10px] bg-white/10 px-1.5 rounded text-slate-400">Usuario</span>
                </div>
                <span class="text-slate-400 text-xs">${u.name}</span>
            `;
      item.addEventListener("click", () => {
        inputCedula.value = u.cedula;
        // Auto-fill alias logic
        const aliasInput = form.querySelector('input[name="alias"]');
        if (aliasInput && !aliasInput.value) aliasInput.value = u.name;

        suggestionsBox.classList.add("hidden");
      });
      suggestionsBox.appendChild(item);
    });

    suggestionsBox.classList.remove("hidden");
  }

  // --- GRID RENDERING ---

  // Globals needed for HTML onclick attributes
  window.toggleCardMenu = (id) => {
    const menu = document.getElementById(`menu-${id}`);
    // Close others
    document.querySelectorAll(".card-menu").forEach((m) => {
      if (m.id !== `menu-${id}`) m.classList.add("hidden");
    });
    // Toggle current
    menu.classList.toggle("hidden");
  };

  // Close menus on click outside
  document.addEventListener("click", (e) => {
    if (!e.target.closest(".card-actions")) {
      document
        .querySelectorAll(".card-menu")
        .forEach((m) => m.classList.add("hidden"));
    }
  });

  function createContactCard(contact) {
    const isFav = contact.is_favorite;
    const div = document.createElement("div");
    div.className =
      "bg-[#0f1012] border border-white/5 rounded-3xl p-6 flex flex-col items-center gap-4 hover:border-brand-lime/30 transition-all group relative animate-fade-in hover:shadow-xl hover:shadow-black/50 hover:-translate-y-1 duration-300";

    // Add Star Badge if favorite
    const favBadge = isFav
      ? `<div class="absolute top-4 right-4 text-brand-lime animate-pulse"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></div>`
      : "";

    div.innerHTML = `
            ${favBadge}
            <!-- Avatar -->
            <div class="relative">
                <img
                    src="https://api.dicebear.com/9.x/avataaars/svg?seed=${contact.nombre}"
                    alt="${contact.nombre}"
                    class="w-20 h-20 rounded-full bg-[#1a1a1a] border-4 border-[#0f1012] group-hover:border-brand-lime transition-colors shadow-2xl"
                />
                <div class="absolute bottom-1 right-1 w-4 h-4 bg-brand-lime border-2 border-[#0f1012] rounded-full"></div>
            </div>

            <!-- Text Info -->
            <div class="text-center w-full mb-2">
                <h3 class="text-white font-bold text-lg truncate mb-1" title="${contact.nombre}">
                    ${contact.nombre}
                </h3>
                <div class="flex justify-center mb-2">
                    <span class="text-[10px] text-slate-500 font-mono bg-[#1a1a1a] px-2 py-0.5 rounded border border-white/5">
                        ${contact.cedula}
                    </span>
                </div>
                <div class="text-xs text-slate-400 truncate w-full px-2">
                    ${contact.alias ? "@" + contact.alias : "@" + contact.nombre.replace(/\s+/g, "").toLowerCase()} 
                </div>
            </div>

            <!-- Actions Row -->
            <div class="flex gap-2 w-full mt-auto">
                <button 
                  class="flex-1 bg-brand-lime hover:bg-[#bce628] text-black text-xs font-bold py-3 rounded-xl transition-all shadow-[0_0_10px_rgba(215,253,73,0.1)] hover:shadow-[0_0_20px_rgba(215,253,73,0.3)] cursor-pointer active:scale-95"
                  onclick="window.location.href='/dashboard?transferTo=${contact.cedula}'"
                >
                    Enviar Capys
                </button>
                
                <div class="relative card-actions">
                    <button 
                        onclick="toggleCardMenu('${contact.id}')"
                        class="w-10 h-full rounded-xl bg-[#1a1a1a] text-slate-400 hover:text-white hover:bg-[#252525] flex items-center justify-center border border-white/5 transition-colors cursor-pointer"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                        </svg>
                    </button>
                    <!-- Dropdown Menu -->
                    <div id="menu-${contact.id}" class="card-menu hidden absolute bottom-full right-0 mb-2 w-48 bg-[#1a1a1a] border border-white/10 rounded-xl shadow-2xl overflow-hidden z-20 animate-fade-in-up origin-bottom-right">
                        <div class="p-1">
                            <button class="w-full text-left px-3 py-2.5 text-xs font-medium text-slate-300 hover:bg-white/5 hover:text-white rounded-lg flex items-center gap-3 transition-colors cursor-pointer btn-favorite" data-id="${contact.id}" data-fav="${isFav}">
                                <span class="${isFav ? "text-brand-lime" : "text-slate-500"}">â˜…</span> ${isFav ? "Quitar de Favoritos" : "AÃ±adir a Favoritos"}
                            </button>
                            <div class="h-px bg-white/5 my-1"></div>
                            <button class="w-full text-left px-3 py-2.5 text-xs font-medium text-red-400 hover:bg-red-500/10 hover:text-red-300 rounded-lg flex items-center gap-3 transition-colors btn-delete cursor-pointer" data-id="${contact.id}">
                                <span>ðŸ—‘</span> Eliminar Contacto
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    return div;
  }

  function createAddCard() {
    const div = document.createElement("div");
    div.className =
      "bg-transparent border-2 border-dashed border-[#2a2a2a] rounded-3xl p-6 flex flex-col items-center justify-center gap-4 hover:border-brand-lime hover:bg-brand-lime/5 transition-all group cursor-pointer h-full min-h-[280px]";
    div.innerHTML = `
             <div class="w-20 h-20 rounded-full bg-[#151515] flex items-center justify-center text-slate-600 group-hover:bg-brand-lime group-hover:text-black transition-all shadow-lg group-hover:scale-110 duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
             </div>
             <div class="text-center">
                 <h3 class="text-slate-400 group-hover:text-brand-lime font-bold mb-1 transition-colors text-lg">AÃ±adir Nuevo</h3>
                 <p class="text-xs text-slate-600 group-hover:text-slate-500 transition-colors">Guardar nuevo destinatario</p>
             </div>
         `;
    div.addEventListener("click", () => toggleModal(true));
    return div;
  }

  function renderGrid() {
    if (!grid) return;
    grid.innerHTML = "";

    let filtered = allContacts;

    // 1. Search Filter
    const term = searchInput.value.toLowerCase();
    if (term) {
      filtered = filtered.filter(
        (c) =>
          c.nombre.toLowerCase().includes(term) ||
          c.cedula.includes(term) ||
          (c.alias && c.alias.toLowerCase().includes(term)),
      );
    }

    // 2. Tab Filter
    if (currentFilter === "favorites") {
      filtered = filtered.filter((c) => c.is_favorite);
    }
    // 3. Recent Filter (mock logic: last 5) - or use created_at if available, but for now just slice if filter is recent
    if (currentFilter === "recent") {
      // Assuming list comes ordered by add time or something, otherwise just take first few
      filtered = filtered.slice(0, 5);
    }

    // Render
    if (filtered.length === 0 && !term) {
      // Empty State (No contacts at all)
      // If favorite filter is active, show specific message
      if (currentFilter === "favorites") {
        grid.innerHTML = `
            <div class="col-span-full flex flex-col items-center justify-center p-10 text-slate-500 border-2 border-dashed border-white/5 rounded-3xl h-64">
                <span class="text-4xl mb-2">â˜…</span>
                <p>No tienes favoritos aÃ±adidos aÃºn.</p>
            </div>`;
      } else {
        grid.appendChild(createAddCard());
      }
    } else if (filtered.length === 0 && term) {
      // Empty Search Results
      grid.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center p-10 text-slate-500 border-2 border-dashed border-white/5 rounded-3xl h-64">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                   <p>No hay resultados para "${term}"</p>
                </div>
            `;
    } else {
      // Render Cards
      filtered.forEach((c) => {
        grid.appendChild(createContactCard(c));
      });
      // Append Add Card only if viewing all and not searching
      if (currentFilter === "all" && !term) {
        grid.appendChild(createAddCard());
      }
    }

    // Attach Listeners to dynamic elements
    document.querySelectorAll(".btn-delete").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        const id = btn.getAttribute("data-id");
        if (!confirm("Â¿EstÃ¡s seguro de eliminar este contacto?")) return;
        try {
          await userService.deleteContact(id);
          // Refresh
          loadContacts();
        } catch (err) {
          alert(err.message);
        }
      });
    });

    // Attach Listeners for Favorite Toggle
    document.querySelectorAll(".btn-favorite").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        // Prevent bubbling if needed, but menu closes anyway by UI logic
        const id = btn.getAttribute("data-id");
        const isFav = btn.getAttribute("data-fav") === "true";
        try {
          await userService.toggleFavorite(id, !isFav);
          loadContacts();
        } catch (err) {
          console.error(err);
          alert("Error al actualizar favorito");
        }
      });
    });
  }

  // --- DATA LOADING ---
  async function loadContacts() {
    if (!grid) return;
    try {
      const data = await userService.getContacts();
      allContacts = data.contactos || [];
      renderGrid();
    } catch (error) {
      console.error(error);
      grid.innerHTML =
        '<div class="col-span-full text-red-400 text-center py-10">Error cargando contactos. Revisa tu conexiÃ³n.</div>';
    }
  }

  // --- EVENT LISTENERS (Global) ---
  searchInput.addEventListener("input", () => renderGrid());

  filterBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      // Styles
      filterBtns.forEach((b) => {
        b.classList.remove("bg-brand-lime", "text-black", "shadow-lg");
        b.classList.add("text-slate-500");
      });
      btn.classList.remove("text-slate-500");
      btn.classList.add("bg-brand-lime", "text-black", "shadow-lg");

      // Logic
      currentFilter = btn.getAttribute("data-filter");
      renderGrid();
    });
  });

  // Form Submit
  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const cedula = formData.get("cedula");
      const alias = formData.get("alias");

      errorContainer.classList.add("hidden");

      try {
        await userService.addContact(cedula, alias);
        toggleModal(false);
        loadContacts();
      } catch (error) {
        errorText.innerText = error.message;
        errorContainer.classList.remove("hidden");
      }
    });
  }

  // Init Page
  loadContacts();
</script>
