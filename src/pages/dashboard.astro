---
import CapyPay from "../layouts/MainLayout.astro";
import BalanceCard from "../components/BalanceCard.astro";
import HistoryCard from "../components/HistoryCard.astro";
import QuickPay from "../components/QuickPay.astro";
import FinanceChart from "../components/FinanceChart.astro";
import TransferWidget from "../components/TransferWidget.astro";
import ExchangeRateWidget from "../components/ExchangeRateWidget.astro";
---

<CapyPay title="Dashboard | CapyPay" showSidebar={true}>
  <!-- 
    GRID PRINCIPAL
    Movil: Una sola columna (reordenada via Flex Order o Contents para cambiar el orden visual)
    Escritorio: Malla de 12 columnas para un dise帽o complejo
  -->
  <div
    class="grid grid-cols-1 lg:grid-cols-12 gap-6 w-full lg:h-full lg:min-h-0"
  >
    <!-- ENCABEZADO MOVIL (Orden 1) - Visible solo en pantallas peque帽as -->
    <div
      class="flex items-center justify-between p-2 lg:hidden order-1 animate-fade-in-down"
    >
      <div class="flex items-center gap-3">
        <!-- Widget de Nivel -->
        <div
          class="bg-brand-black rounded-full px-3 py-1 border border-white/10 flex items-center gap-2"
        >
          <span class="text-[10px] text-slate-400 font-bold uppercase">Nvl</span
          >
          <span class="text-brand-lime font-bold text-sm">12</span>
        </div>
        <!-- Saludo -->
        <h1 class="text-lg font-bold text-white">
          Hola, <span id="header-username">Cormex</span>
        </h1>
      </div>
      <!-- Campanita de Notificaciones y Cerrar Sesion -->
      <div class="flex items-center gap-2">
        <!-- Notificaciones -->
        <div
          class="w-8 h-8 rounded-full bg-brand-black border border-white/10 flex items-center justify-center text-slate-400"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
            ></path>
          </svg>
        </div>
        <!-- Boton de Cerrar Sesion (Movil) -->
        <button
          id="mobile-logout-btn"
          class="w-8 h-8 rounded-full bg-red-500/10 border border-red-500/20 flex items-center justify-center text-red-400 cursor-pointer"
          aria-label="Cerrar Sesi贸n"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
            ></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- BUSQUEDA MOVIL (Orden 2) -->
    <div
      class="lg:hidden order-2 animate-fade-in-down"
      style="animation-delay: 100ms;"
    >
      <div class="relative group/search">
        <input
          type="text"
          placeholder="Buscar contactos..."
          class="w-full bg-brand-black text-white text-sm rounded-xl pl-10 pr-4 py-3 border border-white/10 focus:outline-none focus:border-brand-lime/50 focus:bg-black transition-all placeholder:text-slate-500"
        />
        <div
          class="absolute left-0 top-0 h-full w-10 flex items-center justify-center text-slate-500 pointer-events-none group-focus-within/search:text-brand-lime"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- 
      COLUMNA IZQUIERDA: Widgets (4 Columnas en Escritorio)
      Movil: Contents (Los hijos se convierten en Orden 3, 4, 6)
    -->
    <aside
      class="contents lg:col-span-4 lg:flex lg:flex-col lg:order-1 animate-fade-in-left gap-6 h-full min-h-0"
    >
      <div class="shrink-0 order-3 lg:order-0">
        <BalanceCard amount="12,450.00" />
      </div>

      <div class="shrink-0 order-4 lg:order-0">
        <QuickPay />
      </div>

      <div class="shrink-0 min-h-87.5 lg:flex-1 lg:min-h-0 order-6 lg:order-0">
        <FinanceChart />
      </div>
    </aside>

    <!-- 
      COLUMNA PRINCIPAL (8 Columnas en Escritorio)
      Movil: Contents (Encabezado Oculto, Hijos Orden 5, 7, 8)
    -->
    <section
      class="contents lg:col-span-8 lg:flex lg:flex-col lg:order-2 animate-fade-in-up gap-6 h-full min-h-0"
    >
      <!-- Encabezado (Solo Escritorio) -->
      <header
        class="hidden lg:flex justify-between items-center bg-brand-black border border-white/10 rounded-3xl p-6 w-full shrink-0 isolate shadow-none animate-fade-in-down"
      >
        <div>
          <h1 class="text-2xl font-bold text-white flex gap-2 items-center">
            Hola, <span id="desktop-username">Cormex</span>
            <span class="animate-wave origin-bottom-right inline-block"></span
            >
          </h1>
          <p class="text-slate-400 text-xs mt-1 flex items-center gap-1">
            <span class="w-1.5 h-1.5 rounded-full bg-brand-lime"></span>
            ltimo acceso: Hoy, 09:30 AM
          </p>
        </div>
        <div
          class="text-xs font-medium bg-brand-lime/10 text-brand-lime border border-brand-lime/30 px-3 py-1.5 rounded-full whitespace-nowrap"
        >
          {
            new Date().toLocaleDateString("es-ES", {
              month: "long",
              day: "numeric",
            })
          }
        </div>
      </header>

      <!-- Malla Interna: Centro + Derecha -->
      <div
        class="contents lg:grid lg:grid-cols-2 lg:gap-6 lg:flex-1 lg:min-h-0"
      >
        <!-- COLUMNA CENTRAL (Transferencias/Tasa de Cambio) -->
        <div class="contents lg:flex lg:flex-col lg:gap-6 animate-fade-in-up">
          <!-- Widget de Transferencia (Orden 5) -->
          <div
            class="shrink-0 min-h-95 lg:flex-1 lg:min-h-50 order-5 lg:order-0"
          >
            <TransferWidget />
          </div>
          <!-- Widget de Tasa de Cambio (Orden 7) -->
          <div class="h-40 shrink-0 order-7 lg:order-0">
            <ExchangeRateWidget />
          </div>
        </div>

        <!-- COLUMNA DERECHA (Actividad) (Orden 8) -->
        <div
          class="h-full min-h-0 animate-fade-in-up order-8 lg:order-0"
          style="animation-delay: 100ms;"
        >
          <!-- Modulo de Actividad -->
          <div
            class="bg-brand-black border border-white/10 rounded-3xl flex flex-col h-full isolate shadow-none w-full overflow-hidden min-h-100 lg:min-h-0"
          >
            <div class="p-6 pb-4 shrink-0 border-b border-white/10">
              <div class="flex flex-col gap-2">
                <div class="flex items-center justify-between">
                  <h2 class="text-xl font-bold text-white">Actividad</h2>
                  <a
                    href="/history"
                    class="text-[10px] text-brand-lime hover:text-white transition-colors flex items-center gap-1 group"
                  >
                    Ver historial
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-3 w-3 group-hover:translate-x-0.5 transition-transform"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"></path>
                    </svg>
                  </a>
                </div>
                <div class="flex gap-1 overflow-x-auto pb-1 no-scrollbar">
                  <button
                    id="filter-all"
                    class="text-[10px] bg-brand-lime hover:bg-[#ccf044] text-black font-bold px-3 py-1 rounded-full transition-colors whitespace-nowrap shadow-[0_0_10px_rgba(215,253,73,0.2)]"
                    >Todos</button
                  >
                  <button
                    id="filter-income"
                    class="text-[10px] text-slate-400 hover:text-brand-lime px-3 py-1 rounded-full transition-colors whitespace-nowrap"
                    >Ingresos</button
                  >
                  <button
                    id="filter-expenses"
                    class="text-[10px] text-slate-400 hover:text-brand-lime px-3 py-1 rounded-full transition-colors whitespace-nowrap"
                    >Gastos</button
                  >
                </div>
              </div>
            </div>

            <div
              id="history-list-container"
              class="p-4 overflow-y-auto custom-scrollbar flex-1"
            >
              <p class="text-center text-slate-500 text-sm mt-10">
                Cargando movimientos...
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Espaciador para la Barra de Navegaci贸n Inferior en Movil -->
    <div class="lg:hidden h-32 w-full order-12 shrink-0"></div>
  </div>

  <style>
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes fadeInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    @keyframes wave {
      0%,
      100% {
        transform: rotate(0deg);
      }
      25% {
        transform: rotate(20deg);
      }
      75% {
        transform: rotate(-15deg);
      }
    }

    .animate-fade-in-down {
      animation: fadeInDown 0.6s ease-out forwards;
    }
    .animate-fade-in-up {
      animation: fadeInUp 0.6s ease-out forwards;
      opacity: 0;
      animation-delay: 0.2s;
    }
    .animate-fade-in-left {
      animation: fadeInLeft 0.6s ease-out forwards;
      opacity: 0;
      animation-delay: 0.1ms;
    }
    .animate-wave {
      animation: wave 1.5s infinite;
    }
  </style>

  <script>
    // @ts-nocheck
    import { authService, userService } from "../services/api.js";

    let cachedMovements = [];
    let currentFilter = "all"; // 'all' | 'income' | 'expense'

    function setupFilters() {
      const btnAll = document.getElementById("filter-all");
      const btnIncome = document.getElementById("filter-income");
      const btnExpense = document.getElementById("filter-expenses");

      const updateStyles = (activeId) => {
        [btnAll, btnIncome, btnExpense].forEach((btn) => {
          if (!btn) return;
          if (btn.id === activeId) {
            btn.classList.remove("text-slate-400", "hover:text-brand-lime");
            btn.classList.add(
              "bg-brand-lime",
              "text-black",
              "shadow-[0_0_10px_rgba(215,253,73,0.2)]",
            );
          } else {
            btn.classList.add("text-slate-400", "hover:text-brand-lime");
            btn.classList.remove(
              "bg-brand-lime",
              "text-black",
              "shadow-[0_0_10px_rgba(215,253,73,0.2)]",
            );
          }
        });
      };

      if (btnAll)
        btnAll.onclick = () => {
          currentFilter = "all";
          updateStyles("filter-all");
          renderHistoryList();
        };
      if (btnIncome)
        btnIncome.onclick = () => {
          currentFilter = "income";
          updateStyles("filter-income");
          renderHistoryList();
        };
      if (btnExpense)
        btnExpense.onclick = () => {
          currentFilter = "expense";
          updateStyles("filter-expenses");
          renderHistoryList();
        };
    }

    function renderHistoryList() {
      const container = document.getElementById("history-list-container");
      if (!container) return;

      // Filtrar
      let moves = cachedMovements;
      if (currentFilter === "income") {
        moves = moves.filter((m) => !m.es_negativo);
      } else if (currentFilter === "expense") {
        moves = moves.filter((m) => m.es_negativo);
      }

      if (moves.length === 0) {
        container.innerHTML =
          '<p class="text-center text-slate-500 text-sm mt-10">No hay movimientos.</p>';
        return;
      }

      let html = '<div class="space-y-4"><div class="grid grid-cols-1 gap-2">';

      // Show max 7 items of the filtered list
      const recentMoves = moves.slice(0, 7);

      recentMoves.forEach((mov) => {
        const isNegative = mov.es_negativo;
        const amount = mov.monto;
        const displayAmount = isNegative ? `-$${amount}` : `+$${amount}`;
        const amountColor = isNegative ? "text-purple-400" : "text-[#d7fd48]";
        const iconBg = isNegative ? "bg-purple-500/10" : "bg-[#d7fd48]/10";
        const iconColor = isNegative ? "text-purple-400" : "text-[#d7fd48]";
        const dateObj = new Date(mov.fecha);
        const dateStr = adjustDate(dateObj); // Using helper if needed, or simple local
        // const dateStr = dateObj.toLocaleTimeString([], {
        const dateTime = dateObj.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
        const dateFull = dateObj.toLocaleDateString();

        const iconSvg = isNegative
          ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>'
          : '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>';

        html += `
                    <div class="group flex items-center justify-between p-4 rounded-xl bg-neutral-900 border border-white/5 transition-all duration-300 cursor-pointer w-[calc(100%-8px)] mx-auto hover:bg-neutral-800 hover:border-[#d7fd48]/30 hover:scale-[1.01] overflow-hidden">
                      <div class="flex items-center gap-4 min-w-0">
                        <div class="w-12 h-12 rounded-full ${iconBg} flex items-center justify-center ${iconColor} shrink-0">
                           ${iconSvg}
                        </div>
                        <div class="flex flex-col min-w-0">
                          <h4 class="text-sm font-bold text-white truncate">${mov.descripcion || mov.concept || mov.tipo}</h4>
                          <p class="text-[10px] text-slate-500">${dateFull} ${dateTime}</p>
                        </div>
                      </div>
                      <div class="text-sm font-bold ${amountColor} whitespace-nowrap">
                        ${displayAmount}
                      </div>
                    </div>`;
      });

      container.innerHTML = html + "</div></div>";
    }

    // Helper just in case
    function adjustDate(d) {
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    async function initDashboard() {
      setupFilters();
      console.log("Iniciando Dashboard..."); // Debug
      const user = authService.getCurrentUser();
      console.log("Usuario en Storage:", user); // Debug

      if (!user) {
        console.warn(
          "No hay usuario, redireccionando a login en 3s para depurar...",
        );
        // Comentamos la redirecci贸n inmediata para ver el log
        // window.location.href = '/login';
        return;
      }

      // Actualizar nombre desde localStorage (r谩pido)
      const mobileName = document.getElementById("header-username");
      const desktopName = document.getElementById("desktop-username");

      const updateName = (name) => {
        const firstName = name.split(" ")[0];
        if (mobileName) mobileName.innerText = firstName;
        if (desktopName) desktopName.innerText = firstName;
      };

      if (user.nombre || user.name) {
        updateName(user.nombre || user.name);
      }

      // Logout Mobile
      const mobileLogout = document.getElementById("mobile-logout-btn");
      if (mobileLogout) {
        mobileLogout.addEventListener("click", (e) => {
          e.preventDefault();
          authService.logout();
        });
      }

      // Obtener datos frescos del backend
      try {
        // En tu backend devuelve 'usuarioId', no id. Pero api.js lo mapea a id. Revisamos ambas.
        const userId = user.id || user.usuarioId || user._id;
        console.log("Intentando obtener perfil para ID:", userId);

        if (userId) {
          const profileData = await userService.getProfile(userId);
          console.log("Datos del perfil frescos:", profileData);

          // Adaptamos seg煤n venga la respuesta del backend
          const realUser =
            profileData.usuario || profileData.user || profileData;

          // Actualizar Saldo
          if (realUser.balance !== undefined) {
            const balanceEl = document.getElementById("user-balance-display");
            if (balanceEl) {
              balanceEl.innerText = new Intl.NumberFormat("en-US", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              }).format(realUser.balance);
            }
          }

          // Actualizar Nombre si cambi贸
          if (realUser.nombre || realUser.name) {
            updateName(realUser.nombre || realUser.name);
          }

          // Cargar Historial
          if (realUser.cedula) {
            loadHistory(realUser.cedula);
          }
        } else {
          console.error("No se encontr贸 un ID v谩lido en el usuario local");
        }
      } catch (e) {
        console.error("Error cargando perfil", e);
      }
    }

    async function loadHistory(cedula) {
      const container = document.getElementById("history-list-container");
      if (!container) return;

      try {
        const response = await userService.getHistory(cedula);
        if (response && response.movimientos) {
          cachedMovements = response.movimientos;
          renderHistoryList();
        }
      } catch (e) {
        console.error(e);
        container.innerHTML =
          '<p class="text-center text-red-500/50 text-xs mt-10">Error al cargar historial</p>';
      }
    }

    document.addEventListener("DOMContentLoaded", initDashboard);
    // Escuchar evento global para refrescar datos sin recargar (ej: tras transferencia)
    document.addEventListener("capypay:refresh-data", initDashboard);
  </script>
</CapyPay>
