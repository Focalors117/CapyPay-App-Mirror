---
import MainLayout from "../layouts/MainLayout.astro";

// Initial Mock Data (Skeleton)
const rankData = {
  user: {
    name: "Cargando...",
    rank: "-",
    points: 0,
    avatar: "https://ui-avatars.com/api/?background=0D8ABC&color=fff",
  },
  rival: {
    rank: "-",
    avatar: "https://ui-avatars.com/api/?background=random&color=fff",
  },
  top3: [
    {
      rank: 2,
      name: "...",
      points: "0",
      avatar: "https://ui-avatars.com/api/?background=random&color=fff",
    },
    {
      rank: 1,
      name: "...",
      points: "0",
      avatar: "https://ui-avatars.com/api/?background=random&color=fff",
    }, // Index 1 is Rank 1 in array usually? Wait, let's check usage.
    {
      rank: 3,
      name: "...",
      points: "0",
      avatar: "https://ui-avatars.com/api/?background=random&color=fff",
    },
  ],
  list: [], // Empty initially
};
---

<MainLayout title="Ranking de Influencia | CapyPay" showSidebar={true}>
  <!-- Inject Custom Fonts/Icons just for this page if needed, though MainLayout usually handles it.
       MainLayout has 'Outfit', but this design asked for 'Space Grotesk'. 
       We will stick to the project font 'Outfit' for consistency primarily, or load Space Grotesk if strictly required. 
       Let's stick to project defaults for better integration unless it looks bad. -->

  <style>
    .hexagon-clip {
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    }
    .glow-lime {
      box-shadow: 0 0 20px rgba(215, 253, 73, 0.4);
    }
    .glow-purple {
      box-shadow: 0 0 25px rgba(131, 98, 232, 0.6);
    }
    .glow-neon-strong {
      box-shadow:
        0 0 40px rgba(215, 253, 73, 0.8),
        0 0 80px rgba(215, 253, 73, 0.4);
      /* animation: pulse-glow 2s infinite alternate; */
    }
    @keyframes pulse-glow {
      0% {
        box-shadow:
          0 0 40px rgba(215, 253, 73, 0.8),
          0 0 80px rgba(215, 253, 73, 0.4);
      }
      100% {
        box-shadow:
          0 0 60px rgba(215, 253, 73, 1),
          0 0 100px rgba(215, 253, 73, 0.6);
      }
    }
    .particles-container {
      position: absolute;
      inset: -50px;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
      display: none; /* Removed heavy particle animation */
    }
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #d7fd49; /* brand-lime */
      border-radius: 50%;
      opacity: 0.35;
      animation: falling-particle 3s infinite linear;
    }
    .particle:nth-child(1) {
      left: 20%;
      animation-delay: 0s;
    }
    .particle:nth-child(2) {
      left: 80%;
      animation-delay: 1.5s;
    }
    .particle:nth-child(3) {
      left: 50%;
      animation-delay: 0.8s;
    }

    @keyframes falling-particle {
      0% {
        transform: translateY(-20px);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      100% {
        transform: translateY(150px);
        opacity: 0;
      }
    }

    .glass-blur {
      /* backdrop-filter: blur(12px); REMOVED TO FIX JITTER */
      /* -webkit-backdrop-filter: blur(12px); */
    }

    /* Colors for Levels */
    .text-accent-pink {
      color: #db2777;
    }
    .glow-pink {
      box-shadow: 0 0 25px rgba(219, 39, 119, 0.6);
    }

    .text-accent-purple {
      color: #7c3aed;
    }
    .glow-purple {
      box-shadow: 0 0 25px rgba(124, 58, 237, 0.6);
    }

    .from-accent-purple {
      --tw-gradient-from: #7c3aed;
      --tw-gradient-stops:
        var(--tw-gradient-from), var(--tw-gradient-to, rgba(131, 98, 232, 0));
    }
    /* Highlight User Row */
    .user-highlight-card {
      background: linear-gradient(
        90deg,
        rgba(215, 253, 73, 0.15) 0%,
        rgba(215, 253, 73, 0.05) 100%
      );
      border: 1px solid rgba(215, 253, 73, 0.5);
      box-shadow: 0 0 15px rgba(215, 253, 73, 0.1) inset;
    }
  </style>

  <!-- Content Wrapper with padding for bottom fixed bar -->
  <div class="max-w-7xl mx-auto px-4 md:px-6 py-8 pb-32 overflow-x-hidden">
    <!-- Back Button -->
    <a
      href="/comedor"
      class="inline-flex items-center gap-2 text-white/50 hover:text-brand-lime transition-colors mb-6 group font-bold uppercase tracking-wider text-xs"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 group-hover:-translate-x-1 transition-transform"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Volver a Comedor
    </a>

    <!-- Page Heading & Prize Banner -->
    <div class="flex flex-col lg:flex-row justify-between gap-6 mb-12">
      <div class="flex flex-col gap-2">
        <h1
          class="text-white text-4xl md:text-5xl font-black leading-tight tracking-tight uppercase italic"
        >
          Ranking de <span class="text-brand-lime">Influencia</span>
        </h1>
        <p class="text-white/60 text-lg max-w-xl font-medium">
          Compite con la comunidad estudiantil y ll√©vate el bot√≠n semanal.
        </p>
      </div>

      <div
        class="flex-1 max-w-md bg-linear-to-r from-accent-purple to-indigo-900 rounded-xl p-6 relative overflow-hidden flex items-center justify-between border border-white/20 shadow-2xl"
      >
        <div class="relative z-10">
          <p class="text-xs font-bold uppercase tracking-widest text-white/70">
            Premio Semanal <span
              class="text-brand-lime ml-2"
              id="countdown-timer">00d 00h 00m</span
            >
          </p>
          <p class="text-2xl font-black text-white">10,000 BARAS + Merch</p>
          <button
            class="mt-3 bg-white text-accent-purple px-4 py-1.5 rounded-lg text-xs font-bold uppercase hover:bg-brand-lime hover:text-black transition-colors"
          >
            Ver Detalles
          </button>
        </div>
        <span
          class="material-symbols-outlined text-7xl text-white/20 absolute -right-2 -bottom-2 rotate-12"
          >redeem</span
        >
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex justify-center mb-8 gap-4">
      <button
        id="tab-users"
        class="tab-btn active px-6 py-2 rounded-full font-bold uppercase tracking-widest text-sm bg-brand-lime text-black shadow-lg shadow-brand-lime/20 transition-all"
      >
        Estudiantes
      </button>
      <button
        id="tab-faculties"
        class="tab-btn px-6 py-2 rounded-full font-bold uppercase tracking-widest text-sm bg-white/5 text-white/50 border border-white/10 hover:bg-white/10 transition-all"
      >
        Facultades ‚öîÔ∏è
      </button>
    </div>

    <!-- Main Grid: Removed items-start for full height columns -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <!-- Left & Center: Podium and List -->
      <div class="lg:col-span-8 space-y-8">
        <!-- The Podium (Top 3) -->
        <div
          id="podium-container"
          class="grid grid-cols-3 gap-2 md:gap-4 items-end pt-12 min-h-80 transition-opacity duration-300"
        >
          <!-- Rank 2 -->
          <div class="flex flex-col items-center gap-4">
            <div class="relative group cursor-pointer">
              <div
                class="absolute -inset-1 bg-[#DB2777]/30 rounded-full blur-sm opacity-50 group-hover:opacity-100 transition duration-1000 group-hover:duration-200"
              >
              </div>
              <div
                class="size-24 md:size-32 hexagon-clip bg-[#DB2777]/10 group-hover:bg-[#DB2777]/25 transition-colors duration-300 p-1 flex items-center justify-center border-2 border-[#DB2777]/40 glow-pink"
              >
                <img
                  id="rank2-avatar"
                  class="hexagon-clip w-full h-full object-cover bg-black"
                  src="https://ui-avatars.com/api/?background=random&color=fff&name=P2"
                  alt="Rank 2"
                />
                <span id="rank2-icon" class="hidden text-4xl">üèõÔ∏è</span>
              </div>
              <div
                class="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-[#DB2777] text-white px-3 py-0.5 rounded-full border-2 border-black text-xs font-bold shadow-lg"
              >
                #2
              </div>
            </div>
            <div class="text-center">
              <p
                id="rank2-name"
                class="font-bold text-accent-pink text-sm md:text-base uppercase tracking-wider"
              >
                -
              </p>
              <p
                id="rank2-points"
                class="text-white/60 text-xs md:text-sm font-bold italic"
              >
                0 pts
              </p>
            </div>
          </div>

          <!-- Rank 1 -->
          <div class="flex flex-col items-center gap-6 pb-8">
            <div class="relative group cursor-pointer">
              <!-- Golden Crown -->
              <div
                class="absolute -top-10 left-1/2 -translate-x-1/2 z-20 drop-shadow-[0_0_15px_rgba(255,215,0,0.8)]"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  height="48px"
                  viewBox="0 -960 960 960"
                  width="48px"
                  fill="#FFD700"
                  ><path
                    d="M200-200v-560l160 120 120-120 120 120 160-120v560H200Zm80-80h400v-326L556-486 480-562 404-486l-124-120v326Zm200-240Z"
                  ></path></svg
                >
              </div>

              <!-- Particle/Confetti Container -->
              <div class="particles-container">
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
              </div>

              <!-- Glowing Hexagon -->
              <div
                class="absolute -inset-2 bg-linear-to-tr from-brand-lime via-accent-purple to-brand-lime rounded-full blur-lg opacity-40 group-hover:opacity-70 transition duration-1000"
              >
              </div>
              <div
                class="size-32 md:size-44 hexagon-clip bg-brand-lime p-1.5 flex items-center justify-center glow-neon-strong"
              >
                <img
                  id="rank1-avatar"
                  class="hexagon-clip w-full h-full object-cover bg-black"
                  src="https://ui-avatars.com/api/?background=random&color=fff&name=P1"
                  alt="Rank 1"
                />
                <span id="rank1-icon" class="hidden text-5xl">üëë</span>
              </div>
              <div
                class="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-brand-lime text-black px-4 py-1 rounded-full text-sm font-black border-2 border-black shadow-[0_0_15px_rgba(215,253,73,0.6)]"
              >
                #1
              </div>
            </div>
            <div class="text-center">
              <p
                id="rank1-name"
                class="text-lg md:text-xl font-black text-white uppercase tracking-tight"
              >
                -
              </p>
              <p
                id="rank1-points"
                class="text-brand-lime text-base md:text-lg font-black italic drop-shadow-[0_0_5px_rgba(166,242,13,0.5)]"
              >
                0 pts
              </p>
            </div>
          </div>

          <!-- Rank 3 -->
          <div class="flex flex-col items-center gap-4">
            <div class="relative group cursor-pointer">
              <div
                class="absolute -inset-1 bg-[#7C3AED]/30 rounded-full blur-sm opacity-50 group-hover:opacity-100 transition duration-1000 group-hover:duration-200"
              >
              </div>
              <div
                class="size-24 md:size-32 hexagon-clip bg-[#7C3AED]/10 group-hover:bg-[#7C3AED]/25 transition-colors duration-300 p-1 flex items-center justify-center border-2 border-[#7C3AED]/40 glow-purple"
              >
                <img
                  id="rank3-avatar"
                  class="hexagon-clip w-full h-full object-cover bg-black"
                  src="https://ui-avatars.com/api/?background=random&color=fff&name=P3"
                  alt="Rank 3"
                />
                <span id="rank3-icon" class="hidden text-4xl">üèõÔ∏è</span>
              </div>
              <div
                class="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-[#7C3AED] text-white px-3 py-0.5 rounded-full border-2 border-black text-xs font-bold shadow-lg"
              >
                #3
              </div>
            </div>
            <div class="text-center">
              <p
                id="rank3-name"
                class="font-bold text-accent-purple text-sm md:text-base uppercase tracking-wider"
              >
                -
              </p>
              <p
                id="rank3-points"
                class="text-white/60 text-xs md:text-sm font-bold italic"
              >
                0 pts
              </p>
            </div>
          </div>
        </div>

        <!-- Faculty Battle Progress -->
        <div
          id="faculty-battle-summary"
          class="bg-white/5 border border-white/10 rounded-xl p-4 transition-all duration-300"
        >
          <div class="flex justify-between items-end mb-2">
            <span
              class="text-xs font-bold uppercase tracking-wider text-white/60"
              >Batalla de Facultades</span
            >
            <span
              id="battle-details-text"
              class="text-xs text-brand-lime font-black italic"
              >Cargando datos...</span
            >
          </div>
          <div
            id="battle-bar-container"
            class="relative h-4 w-full bg-white/10 rounded-full overflow-hidden flex"
          >
            <!-- Default Placeholder -->
            <div class="h-full bg-white/20 w-1/2 animate-pulse"></div>
            <div class="h-full bg-white/10 w-1/2 animate-pulse"></div>
          </div>
        </div>

        <!-- FILTERS & TABS -->
        <div
          class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white/5 p-2 rounded-2xl border border-white/10"
        >
          <!-- Filter: Scope -->
          <div class="flex bg-black/40 rounded-xl p-1 gap-1" id="scope-filters">
            <button
              class="scope-btn px-4 py-2 rounded-lg text-sm font-bold bg-brand-lime text-black shadow-[0_0_10px_rgba(215,253,73,0.3)] transition-all"
              data-value="global">Global</button
            >
            <button
              class="scope-btn px-4 py-2 rounded-lg text-sm font-bold text-white/50 hover:text-white hover:bg-white/10 transition-all"
              data-value="facultad">Facultad</button
            >
            <button
              class="scope-btn px-4 py-2 rounded-lg text-sm font-bold text-white/50 hover:text-white hover:bg-white/10 transition-all"
              data-value="carrera">Carrera</button
            >
          </div>

          <!-- Filter: Time (Custom Dropdown) -->
          <div class="relative w-full md:w-48 z-20">
            <button
              id="time-filter-btn"
              class="w-full bg-black/40 text-white text-sm font-bold rounded-xl border border-white/10 py-2.5 px-4 flex justify-between items-center hover:border-brand-lime/50 transition-all focus:outline-none focus:border-brand-lime/50 group"
              type="button"
            >
              <span class="text-white" id="time-filter-label">Esta Semana</span>
              <svg
                id="time-filter-arrow"
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 text-white/50 transition-transform duration-200 group-hover:text-brand-lime"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>

            <!-- Dropdown Menu -->
            <div
              id="time-filter-menu"
              class="absolute top-full right-0 w-full mt-2 bg-[#1a1b2e] border border-brand-lime/20 rounded-xl overflow-hidden shadow-[0_10px_40px_rgba(0,0,0,0.5)] z-50 hidden"
            >
              <div class="p-1 flex flex-col gap-1">
                <button
                  class="time-option w-full text-left px-4 py-2.5 rounded-lg text-sm font-medium text-white hover:bg-white/10 transition-colors flex items-center justify-between group"
                  data-label="Esta Semana"
                >
                  <span>Esta Semana</span>
                  <span
                    class="opacity-0 group-hover:opacity-100 text-brand-lime text-xs"
                    >‚óè</span
                  >
                </button>
                <button
                  class="time-option w-full text-left px-4 py-2.5 rounded-lg text-sm font-medium text-white/70 hover:text-white hover:bg-white/10 transition-colors flex items-center justify-between group"
                  data-label="Este Mes"
                >
                  <span>Este Mes</span>
                  <span
                    class="opacity-0 group-hover:opacity-100 text-brand-lime text-xs"
                    >‚óè</span
                  >
                </button>
                <button
                  class="time-option w-full text-left px-4 py-2.5 rounded-lg text-sm font-medium text-white/70 hover:text-white hover:bg-white/10 transition-colors flex items-center justify-between group"
                  data-label="Hist√≥rico"
                >
                  <span>Hist√≥rico</span>
                  <span
                    class="opacity-0 group-hover:opacity-100 text-brand-lime text-xs"
                    >‚óè</span
                  >
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Leaderboard Table (Ranks 4-10) -->
        <div
          class="bg-white/5 rounded-xl border border-white/10 overflow-hidden shadow-2xl"
        >
          <div
            class="px-6 py-4 border-b border-white/10 flex justify-between items-center bg-white/5"
          >
            <h3
              id="ranking-list-title"
              class="font-bold text-lg uppercase tracking-wider text-white"
            >
              Top Global 10
            </h3>
            <span class="text-xs text-white/40 font-bold"
              >SE ACTUALIZA CADA 5 MINUTOS</span
            >
          </div>
          <div
            id="ranking-list-container"
            class="divide-y divide-white/5 min-h-50"
          >
            <!-- Populated by JS -->
            <div class="p-6 text-center text-white/40 italic">
              Cargando ranking...
            </div>
          </div>
        </div>

        <!-- User Status Card (Moved from Footer) -->
        <div
          class="bg-[#0a0b08]/90 border border-brand-lime/30 rounded-2xl py-4 px-6 md:px-12 shadow-[0_10px_30px_rgba(0,0,0,0.5)]"
        >
          <div
            class="flex flex-col md:flex-row items-center justify-between gap-4"
          >
            <!-- User Info -->
            <div
              class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start"
            >
              <div class="flex items-center gap-4">
                <div
                  class="size-12 rounded-full border-2 border-brand-lime p-0.5 overflow-hidden glow-lime"
                >
                  <img
                    id="user-avatar-footer"
                    class="w-full h-full rounded-full object-cover"
                    src="https://ui-avatars.com/api/?background=random&color=fff&name=Me"
                    alt="User"
                  />
                </div>
                <div>
                  <p class="text-sm text-white/60 font-medium">
                    Tu posici√≥n actual
                  </p>
                  <p class="text-2xl font-black text-white italic">
                    RANK <span id="user-rank" class="text-brand-lime"># -</span>
                  </p>
                </div>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="flex-1 max-w-2xl w-full flex flex-col gap-1.5 px-1">
              <div
                class="flex justify-between items-end text-xs font-black uppercase italic tracking-wider"
              >
                <span class="text-white/40">Nivel Actual</span>
                <div class="flex items-center gap-2">
                  <span id="rival-text" class="text-brand-lime text-right"
                    >Cargando rival...</span
                  >
                  <!-- Rival Avatar -->
                  <div
                    class="size-6 rounded-full border border-white/20 overflow-hidden"
                    title="Rival Directo"
                  >
                    <img
                      id="rival-avatar-footer"
                      src="https://ui-avatars.com/api/?background=random&color=fff&name=Rival"
                      class="w-full h-full object-cover"
                      alt="Rival"
                    />
                  </div>
                </div>
              </div>
              <div
                class="h-3 w-full bg-white/10 rounded-full overflow-hidden border border-white/5"
              >
                <div
                  id="rival-progress-bar"
                  class="h-full bg-linear-to-r from-brand-lime/60 to-brand-lime w-[0%] rounded-full relative transition-all duration-1000"
                >
                  <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                </div>
              </div>
            </div>

            <!-- Points & Action (Desktop) -->
            <div class="items-center gap-3 hidden md:flex">
              <div class="text-right">
                <p class="text-xs text-white/40 font-bold">Total Puntos</p>
                <p
                  id="user-points-footer"
                  class="text-lg font-black text-brand-lime italic"
                >
                  0
                </p>
              </div>
              <button
                class="bg-white/5 hover:bg-white/10 p-3 rounded-xl border border-white/10 transition-colors cursor-pointer"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  height="24px"
                  viewBox="0 -960 960 960"
                  width="24px"
                  fill="white"
                  ><path
                    d="M720-80q-50 0-85-35t-35-85q0-7 1-14.5t3-13.5L322-392q-17 15-38 23.5t-44 8.5q-50 0-85-35t-35-85q0-50 35-85t85-35q23 0 44 8.5t38 23.5l282-164q-2-6-3-13.5t-1-14.5q0-50 35-85t85-35q50 0 85 35t35 85q0 50-35 85t-85 35q-23 0-44-8.5T638-672L356-508q2 6 3 13.5t1 14.5q0 7-1 14.5t-3 13.5l282 164q17-15 38-23.5t44-8.5q50 0 85 35t35 85q0 50-35 85t-85 35Z"
                  ></path></svg
                >
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Sidebar: How to Earn Points -->
      <aside class="lg:col-span-4 space-y-6">
        <div
          class="bg-black/20 rounded-xl border border-white/10 p-6 shadow-2xl"
        >
          <h3
            class="text-xl font-black uppercase italic mb-6 border-b border-brand-lime pb-2 inline-block text-white"
          >
            ¬øC√≥mo ganar puntos?
          </h3>
          <div class="space-y-6">
            <div class="flex gap-4 group">
              <div
                class="size-10 rounded-lg bg-brand-lime/10 flex items-center justify-center border border-brand-lime/20 shrink-0 group-hover:bg-brand-lime/20 transition-all text-brand-lime"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  height="24px"
                  viewBox="0 -960 960 960"
                  width="24px"
                  fill="currentColor"
                  ><path
                    d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z"
                  ></path></svg
                >
              </div>
              <div>
                <h4 class="font-bold text-white leading-tight">
                  Bono de Mantenimiento
                </h4>
                <p class="text-sm text-white/50">
                  +10 PI por cada plato subvencionado pagado.
                </p>
              </div>
            </div>

            <div class="flex gap-4 group">
              <div
                class="size-10 rounded-lg bg-brand-lime/10 flex items-center justify-center border border-brand-lime/20 shrink-0 group-hover:bg-brand-lime/20 transition-all text-brand-lime"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  height="24px"
                  viewBox="0 -960 960 960"
                  width="24px"
                  fill="currentColor"
                  ><path
                    d="M280-80v-366q-51-14-85.5-56T160-600v-280h80v280h40v-280h80v280h40v-280h80v280q0 56-34.5 98T360-446v366h-80Zm400 0v-320H560v-280q0-83 58.5-141.5T760-880v800h-80Z"
                  ></path></svg
                >
              </div>
              <div>
                <h4 class="font-bold text-white leading-tight">Capy-Gourmet</h4>
                <p class="text-sm text-white/50">
                  +25 PI en men√∫ especial (Pizza, Hamburguesas). Combo Mes x2.
                </p>
              </div>
            </div>

            <div class="flex gap-4 group">
              <div
                class="size-10 rounded-lg bg-brand-lime/10 flex items-center justify-center border border-brand-lime/20 shrink-0 group-hover:bg-brand-lime/20 transition-all text-brand-lime"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  height="24px"
                  viewBox="0 -960 960 960"
                  width="24px"
                  fill="currentColor"
                  ><path
                    d="m612-292 56-56-148-148v-184h-80v216l172 172ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-400Zm0 320q133 0 226.5-93.5T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 133 93.5 226.5T480-160Z"
                  ></path></svg
                >
              </div>
              <div>
                <h4 class="font-bold text-white leading-tight">Madrugador</h4>
                <p class="text-sm text-white/50">
                  +15 PI por pickup antes de las 11:30 AM.
                </p>
              </div>
            </div>

            <div class="flex gap-4 group">
              <div
                class="size-10 rounded-lg bg-brand-lime/10 flex items-center justify-center border border-brand-lime/20 shrink-0 group-hover:bg-brand-lime/20 transition-all text-brand-lime"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  height="24px"
                  viewBox="0 -960 960 960"
                  width="24px"
                  fill="currentColor"
                  ><path
                    d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-240v-32q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v32q0 33-23.5 56.5T720-160H240q-33 0-56.5-23.5T160-240Zm80 0h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0 320Zm0-400Z"
                  ></path></svg
                >
              </div>
              <div>
                <h4 class="font-bold text-white leading-tight">Capy-Socio</h4>
                <p class="text-sm text-white/50">
                  +50 PI por Split (3+ amigos). +5 PI por Likes.
                </p>
              </div>
            </div>

            <div class="flex gap-4 group">
              <div
                class="size-10 rounded-lg bg-brand-lime/10 flex items-center justify-center border border-brand-lime/20 shrink-0 group-hover:bg-brand-lime/20 transition-all text-brand-lime"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  height="24px"
                  viewBox="0 -960 960 960"
                  width="24px"
                  fill="currentColor"
                  ><path
                    d="M240-80v-160h-80v-80h80v-120h-80v-80h80v-120h-80v-80h80v-160h600v720q-30 0-58 13t-48 37l-44 56-54-56q-20-22-47-36t-59-14q-32 0-59 14t-47 36l-54 56-44-56q-20-24-48-37t-58-13H240Zm80-80h480v-560H320v560Zm0 0v-560 560Z"
                  ></path></svg
                >
              </div>
              <div>
                <h4 class="font-bold text-white leading-tight">
                  Racha Semanal
                </h4>
                <p class="text-sm text-white/50">
                  +100 PI por comer 5 d√≠as seguidos.
                </p>
              </div>
            </div>
          </div>
          <button
            class="w-full mt-8 bg-brand-lime hover:bg-[#c2e440] text-black font-black py-4 rounded-xl transition-all uppercase tracking-widest shadow-lg shadow-brand-lime/20 cursor-pointer"
          >
            Invitar ahora
          </button>
        </div>

        <div
          class="bg-accent-purple/10 border border-accent-purple/30 rounded-xl p-6"
        >
          <p
            class="text-xs font-bold text-accent-purple uppercase tracking-tighter mb-2"
          >
            Tip de Capy
          </p>
          <p class="text-sm text-white/70 italic">
            "Los pagos en comercios asociados te dan el doble de puntos esta
            semana. ¬°Aprovecha!"
          </p>
        </div>
      </aside>
    </div>
  </div>
</MainLayout>

<script>
  // @ts-nocheck
  import { rankingService, authService } from "../services/api";

  // --- NEW LOGIC START ---
  const state = { view: "users", data: null };
  const tabUsers = document.getElementById("tab-users");
  const tabFaculties = document.getElementById("tab-faculties");
  const podiumContainer = document.getElementById("podium-container");
  const battleSummary = document.getElementById("faculty-battle-summary");
  const listTitle = document.getElementById("ranking-list-title");
  const listContainer = document.getElementById("ranking-list-container");

  async function init() {
    try {
      const user = authService.getCurrentUser();
      const userId = user ? user.id || user.user_id : null;

      const response = await rankingService.getRanking(userId);
      if (response) {
        state.data = response;
        render();
      }
    } catch (error) {
      console.error("Ranking load failed", error);
      if (listContainer)
        listContainer.innerHTML =
          '<div class="p-6 text-center text-red-400 italic">Error al cargar ranking.</div>';
    }
    tabUsers?.addEventListener("click", () => switchTab("users"));
    tabFaculties?.addEventListener("click", () => switchTab("faculties"));
  }

  function switchTab(view) {
    state.view = view;
    if (view === "users") {
      tabUsers.classList.add(
        "active",
        "bg-brand-lime",
        "text-black",
        "shadow-lg",
      );
      tabUsers.classList.remove("bg-white/5", "text-white/50");
      tabFaculties.classList.remove(
        "active",
        "bg-brand-lime",
        "text-black",
        "shadow-lg",
      );
      tabFaculties.classList.add("bg-white/5", "text-white/50");
    } else {
      tabFaculties.classList.add(
        "active",
        "bg-brand-lime",
        "text-black",
        "shadow-lg",
      );
      tabFaculties.classList.remove("bg-white/5", "text-white/50");
      tabUsers.classList.remove(
        "active",
        "bg-brand-lime",
        "text-black",
        "shadow-lg",
      );
      tabUsers.classList.add("bg-white/5", "text-white/50");
    }
    render();
  }

  function render() {
    if (!state.data) return;
    podiumContainer.style.opacity = "0";
    setTimeout(() => {
      if (state.view === "users") renderUsers();
      else renderFaculties();
      podiumContainer.style.opacity = "1";
    }, 200);
    updateFooter();
  }

  function renderUsers() {
    const { top3, list } = state.data.users;
    updatePodium(top3 || [], "user");
    updateList(list || [], "user");

    // Call Faculty Battle Update
    if (state.data.faculties) {
      updateFacultyBattle(state.data.faculties);
    }

    if (battleSummary) battleSummary.style.display = "block";
    if (listTitle) listTitle.textContent = "Top Global 10";
  }

  function updateFacultyBattle(faculties) {
    const textEl = document.getElementById("battle-details-text");
    const container = document.getElementById("battle-bar-container");

    if (!faculties || faculties.length === 0) {
      if (textEl) textEl.textContent = "Guerra Fr√≠a (Sin datos)";
      if (container)
        container.innerHTML = `<div class="w-full h-full flex items-center justify-center text-xs text-white/30 italic">Sin actividad reciente</div>`;
      return;
    }

    const f1 = faculties[0];
    const f2 = faculties[1]; // Might be undefined

    if (!f2) {
      // Only 1 faculty exists
      if (textEl) textEl.textContent = `${f1.name} domina el campus`;
      if (container) {
        container.innerHTML = `
              <div class="h-full relative group flex items-center justify-center overflow-hidden" style="width: 100%; background-color: ${f1.meta?.color || "#3b82f6"}">
                 <span class="text-[10px] font-bold text-white drop-shadow-md truncate">${f1.name.toUpperCase()} IMPARABLE</span>
              </div>`;
      }
      return;
    }

    const diff = (f1.xp || 0) - (f2.xp || 0);
    if (textEl) textEl.textContent = `${f1.name} +${diff} pts sobre ${f2.name}`;

    const total = (f1.xp || 0) + (f2.xp || 0);
    const p1 = total > 0 ? ((f1.xp || 0) / total) * 100 : 50;
    const p2 = 100 - p1;

    if (container) {
      container.innerHTML = `
              <div class="h-full relative group transition-all duration-500 flex items-center justify-end pr-2 overflow-hidden" style="width: ${p1}%; background-color: ${f1.meta?.color || "#3b82f6"}">
                 <span class="text-[10px] font-bold text-white drop-shadow-md truncate">${f1.name.substring(0, 3).toUpperCase()}</span>
              </div>
              <div class="h-full relative group transition-all duration-500 flex items-center pl-2 overflow-hidden" style="width: ${p2}%; background-color: ${f2.meta?.color || "#ef4444"}">
                 <span class="text-[10px] font-bold text-white/90 drop-shadow-md truncate">${f2.name.substring(0, 3).toUpperCase()}</span>
              </div>
              <div class="absolute left-[${p1}%] top-0 bottom-0 w-1 bg-black/50 z-10 -translate-x-1/2"></div>
          `;
    }
  }

  function renderFaculties() {
    const faculties = state.data.faculties;
    updatePodium(faculties.slice(0, 3), "faculty");
    updateList(faculties.slice(3), "faculty");
    if (battleSummary) battleSummary.style.display = "none";
    if (listTitle) listTitle.textContent = "Clasificaci√≥n General";
  }

  function updatePodium(items, type) {
    updatePodiumCardNew(1, items[0] || { name: "-", xp: 0, total_xp: 0 }, type);
    updatePodiumCardNew(2, items[1] || { name: "-", xp: 0, total_xp: 0 }, type);
    updatePodiumCardNew(3, items[2] || { name: "-", xp: 0, total_xp: 0 }, type);
  }

  function updatePodiumCardNew(rank, data, type) {
    const nameEl = document.getElementById(`rank${rank}-name`);
    const ptsEl = document.getElementById(`rank${rank}-points`);
    const avatarEl = document.getElementById(`rank${rank}-avatar`);
    const iconEl = document.getElementById(`rank${rank}-icon`);

    // Safety check just in case
    if (!data) return;

    const points =
      type === "user"
        ? data.points || data.xp || 0
        : data.total_xp || data.xp || 0;
    const displayName = type === "user" ? data.name : data.faculty || data.name;

    if (nameEl) nameEl.textContent = displayName || "-";
    if (ptsEl) ptsEl.textContent = `${points} pts`;

    if (type === "user") {
      if (avatarEl) {
        avatarEl.classList.remove("hidden");
        avatarEl.src =
          data.avatar ||
          `https://ui-avatars.com/api/?name=${displayName || "U"}&background=random`;
      }
      if (iconEl) iconEl.classList.add("hidden");
    } else {
      if (avatarEl) avatarEl.classList.add("hidden");
      if (iconEl) {
        iconEl.classList.remove("hidden");
        const name = (displayName || "").toLowerCase();
        let icon = "üè´";
        if (name.includes("medicina") || name.includes("salud")) icon = "ü©∫";
        else if (name.includes("ingenieria") || name.includes("sistemas"))
          icon = "üíª";
        else if (name.includes("derecho") || name.includes("juridicas"))
          icon = "‚öñÔ∏è";
        else if (name.includes("agronom")) icon = "üåæ";
        else if (name.includes("econom")) icon = "üí∞";
        iconEl.textContent = icon;
      }
    }
  }

  function updateList(items, type) {
    if (!listContainer) return;
    listContainer.innerHTML = "";
    items.forEach((item, index) => {
      const rank = index + 4;
      const points =
        type === "user" ? item.points || item.xp : item.total_xp || item.xp;
      const name = type === "user" ? item.name : item.faculty || item.name;
      const isMe =
        type === "user" &&
        state.data.users.user &&
        state.data.users.user.id === item.id;
      const row = document.createElement("div");
      row.className = `flex items-center gap-4 px-6 py-4 hover:bg-white/5 transition-all cursor-pointer group ${isMe ? "user-highlight-card relative overflow-hidden" : ""}`;
      let iconOrAvatar = "";
      if (type === "user") {
        iconOrAvatar = `<img class="w-full h-full object-cover" src="${item.avatar}" onerror="this.src='https://ui-avatars.com/api/?name=${name}&background=random'"/>`;
      } else {
        const n = name.toLowerCase();
        let icon = "üè´";
        if (n.includes("medicina")) icon = "ü©∫";
        else if (n.includes("ingenieria")) icon = "üíª";
        else if (n.includes("derecho")) icon = "‚öñÔ∏è";
        else if (n.includes("agronom")) icon = "üåæ";
        iconOrAvatar = `<div class="bg-white/10 w-full h-full flex items-center justify-center text-xl">${icon}</div>`;
      }
      row.innerHTML = `
            ${isMe ? '<div class="absolute inset-0 bg-brand-lime/5 pointer-events-none"></div>' : ""}
            <span class="${isMe ? "text-brand-lime" : "text-white/40"} font-black italic w-6 group-hover:text-white transition-colors text-center">${rank}</span>
            <div class="size-10 rounded-lg overflow-hidden border ${isMe ? "border-brand-lime/30" : "border-white/10"} relative ${isMe ? "z-10" : ""}">
                ${iconOrAvatar}
            </div>
             <div class="flex-1 flex flex-col justify-center ${isMe ? "z-10" : ""}">
                <p class="font-bold text-white leading-tight">${name} ${isMe ? "(T√∫)" : ""}</p>
                ${type === "user" ? `<p class="text-xs text-white/40">${item.faculty || "Sin facultad"}</p>` : ""}
             </div>
            <p class="text-brand-lime font-black italic text-right ${isMe ? "z-10" : ""}">${points} pts</p>
         `;
      listContainer.appendChild(row);
    });
  }

  function updateFooter() {
    const user = state.data?.users?.user;
    if (!user) return;

    // Set my stats
    setText("user-rank", `#${user.rank}`);
    setText("user-points-footer", user.points);
    const avatarEl = document.getElementById("user-avatar-footer");
    if (avatarEl)
      avatarEl.src =
        user.avatar ||
        `https://ui-avatars.com/api/?name=${user.name}&background=random`;

    // Set rival stats (User above me)
    const rival = state.data.users.rival;
    const hasRival = rival && rival.points !== undefined && rival.rank !== "-";

    if (hasRival) {
      const diff = rival.points - user.points;
      setText("rival-text", `A ${diff} pts del #${rival.rank}`);

      const rivalAvatar = document.getElementById("rival-avatar-footer");
      if (rivalAvatar)
        rivalAvatar.src =
          rival.avatar ||
          `https://ui-avatars.com/api/?name=${rival.name}&background=random`;

      // Calculate progress percentage (0 to 100 relative to catching up)
      // A simple visual is: (My Points / Rival Points) * 100
      let percentage = 0;
      if (rival.points > 0) {
        percentage = (user.points / rival.points) * 100;
      }

      const bar = document.getElementById("rival-progress-bar");
      if (bar) bar.style.width = `${Math.min(percentage, 100)}%`;
    } else {
      // No rival means I am Rank 1 or unranked
      if (typeof user.rank === "number" && user.rank === 1) {
        setText("rival-text", "¬°Eres el Rey Capibara! üëë");
      } else {
        setText("rival-text", "Sigue subiendo de nivel");
      }
      const bar = document.getElementById("rival-progress-bar");
      if (bar) bar.style.width = `100%`;
    }
  }

  init();
  // --- NEW LOGIC END ---

  // NOTE: Old function below is kept but disabled from auto-run.
  async function loadRanking() {
    try {
      const data = await fetchAPI("/ranking");
      if (data) {
        updateRankingUI(data);
      }
    } catch (error) {
      console.error("Error loading ranking:", error);
    }
  }

  function updateRankingUI(data) {
    const { user, top50 } = data;

    // 1. Update Podium (Top 3)
    if (top50 && top50.length > 0) updatePodiumCard("rank1", top50[0]);
    if (top50 && top50.length > 1) updatePodiumCard("rank2", top50[1]);
    if (top50 && top50.length > 2) updatePodiumCard("rank3", top50[2]);

    // 2. Update List (Indices 3-9 -> Rank 4-10)
    const listContainer = document.getElementById("ranking-list-container");
    if (listContainer && top50) {
      listContainer.innerHTML = ""; // Clear skeleton/loading

      const listData = top50.slice(3, 10);
      listData.forEach((u, index) => {
        const rank = index + 4;
        const isMe = user && user.id === u.id;

        const row = document.createElement("div");
        row.className = `flex items-center gap-4 px-6 py-4 hover:bg-white/5 transition-all cursor-pointer group ${isMe ? "user-highlight-card relative overflow-hidden" : ""}`;

        row.innerHTML = `
            ${isMe ? '<div class="absolute inset-0 bg-brand-lime/5 pointer-events-none"></div>' : ""}
            <span class="${isMe ? "text-brand-lime" : "text-white/40"} font-black italic w-6 group-hover:text-white transition-colors">${rank}</span>
            <div class="size-10 rounded-lg overflow-hidden border ${isMe ? "border-brand-lime/30" : "border-white/10"} relative ${isMe ? "z-10" : ""}">
                <img class="w-full h-full object-cover" src="${u.avatar}" alt="${u.name}" onerror="this.src='https://ui-avatars.com/api/?name=${u.name}&background=random'"/>
            </div>
             <div class="flex-1 flex items-center gap-2 ${isMe ? "z-10" : ""}">
                <p class="font-bold text-white">${u.name} ${isMe ? "(T√∫)" : ""}</p>
             </div>
            <p class="text-brand-lime font-black italic text-right ${isMe ? "z-10" : ""}">${u.xp} pts</p>
         `;
        listContainer.appendChild(row);
      });
    }

    // 3. Update Footer (Me)
    if (user) {
      setText("user-rank", `#${user.rank}`);
      setText("user-points-footer", user.points);
      setImg("user-avatar-footer", user.avatar);

      if (user.rival) {
        setText(
          "rival-text",
          `Solo faltan ${user.rival.diff} pts para el #${user.rival.rank}`,
        );
        setImg("rival-avatar-footer", user.rival.avatar);

        // Progress
        let percentage = 0;
        if (user.rival.points > 0) {
          // Simple progress logic relative to rival
          percentage = (user.points / user.rival.points) * 100;
        }
        const bar = document.getElementById("rival-progress-bar");
        if (bar) bar.style.width = `${Math.min(percentage, 100)}%`;
      } else {
        setText("rival-text", "¬°Eres el n√∫mero 1!");
        const bar = document.getElementById("rival-progress-bar");
        if (bar) bar.style.width = `100%`;
      }
    }
  }

  function updatePodiumCard(prefix, data) {
    if (!data) return;
    setText(`${prefix}-name`, data.name);
    setText(`${prefix}-points`, `${data.xp} pts`);
    setImg(`${prefix}-avatar`, data.avatar);
  }

  function setText(id, val) {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  }

  function setImg(id, src) {
    const el = document.getElementById(id);
    if (el) {
      el.src = src;
      el.onerror = () => {
        el.src = `https://ui-avatars.com/api/?name=User&background=random`;
      };
    }
  }

  // Load immediately
  // loadRanking();

  // Scope Filters Logic
  const scopeBtns = document.querySelectorAll(".scope-btn");

  if (scopeBtns.length > 0) {
    scopeBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        // Reset all buttons
        scopeBtns.forEach((b) => {
          b.classList.remove(
            "bg-brand-lime",
            "text-black",
            "shadow-[0_0_10px_rgba(215,253,73,0.3)]",
          );
          b.classList.add("text-white/50");
        });

        // Activate clicked button
        btn.classList.remove("text-white/50");
        btn.classList.add(
          "bg-brand-lime",
          "text-black",
          "shadow-[0_0_10px_rgba(215,253,73,0.3)]",
        );
      });
    });
  }

  // Custom Dropdown Logic
  const filterBtn = document.getElementById("time-filter-btn");
  const filterMenu = document.getElementById("time-filter-menu");
  const filterArrow = document.getElementById("time-filter-arrow");
  const filterLabel = document.getElementById("time-filter-label");
  const timeOptions = document.querySelectorAll(".time-option");

  let isDropdownOpen = false;

  function toggleDropdown() {
    if (!filterMenu || !filterArrow) return;

    isDropdownOpen = !isDropdownOpen;
    if (isDropdownOpen) {
      filterMenu.classList.remove("hidden");
      filterMenu.classList.add("dropdown-enter-active");
      filterArrow.style.transform = "rotate(180deg)";
    } else {
      filterMenu.classList.add("hidden");
      filterMenu.classList.remove("dropdown-enter-active");
      filterArrow.style.transform = "rotate(0deg)";
    }
  }

  // Close when clicking outside
  document.addEventListener("click", (e) => {
    const target = e.target as Node;
    if (
      filterBtn &&
      filterMenu &&
      filterArrow &&
      !filterBtn.contains(target) &&
      !filterMenu.contains(target)
    ) {
      isDropdownOpen = false;
      filterMenu.classList.add("hidden");
      filterArrow.style.transform = "rotate(0deg)";
    }
  });

  if (filterBtn) {
    filterBtn.addEventListener("click", toggleDropdown);
  }

  // Handle Option Selection
  if (timeOptions.length > 0 && filterLabel) {
    timeOptions.forEach((option) => {
      option.addEventListener("click", () => {
        const value = option.getAttribute("data-label");
        if (value) filterLabel.innerText = value;

        // Reset styling for all options
        timeOptions.forEach((opt) => {
          opt.classList.remove("text-white");
          opt.classList.add("text-white/70");
          const check = opt.querySelector("span:last-child");
          if (check) {
            check.classList.remove("opacity-100");
            check.classList.add("opacity-0");
          }
        });

        // Style active option
        option.classList.remove("text-white/70");
        option.classList.add("text-white");
        const checkActive = option.querySelector("span:last-child");
        if (checkActive) {
          checkActive.classList.remove("opacity-0");
          checkActive.classList.add("opacity-100");
        }

        toggleDropdown(); // Close menu
      });
    });
  }

  // Countdown Logic (Mocked)
  const countdownEl = document.getElementById("countdown-timer");
  if (countdownEl) {
    // Set end date to next Sunday
    const now = new Date();
    const nextSunday = new Date();
    nextSunday.setDate(now.getDate() + (7 - now.getDay()));
    nextSunday.setHours(23, 59, 59, 999);

    function updateTimer() {
      if (!countdownEl) return;
      const currentTime = new Date().getTime();
      const distance = nextSunday.getTime() - currentTime;

      if (distance < 0) {
        countdownEl.innerText = "¬°Finalizado!";
        return;
      }

      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor(
        (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60),
      );
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

      countdownEl.innerText = `${days}d ${hours}h ${minutes}m`;
    }

    setInterval(updateTimer, 60000); // Update every minute
    updateTimer(); // Initial call
  }
</script>
