---
import "../styles/global.css";
import NavBar from "../components/NavBar.astro";
import Sidebar from "../components/Sidebar.astro";
import BottomNav from "../components/BottomNav.astro";
import ToastNotification from "../components/ToastNotification.astro";
const { title = "CapyPay", showSidebar = false } = Astro.props;
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <title>{title}</title>
    <!-- Auth Guard Anti-Flash (Improved) -->
    <script is:inline>
      // 1. Ocultar el contenido inmediatamente
      document.write(
        "<style>body { visibility: hidden; opacity: 0; transition: opacity 0.5s ease; }</style>",
      );

      (function () {
        try {
          const token = localStorage.getItem("capypay_token");
          // Quitamos slash final y usamos fallback a '/'
          const path = window.location.pathname.replace(/\/+$/, "") || "/";
          const publicPaths = ["/", "/login", "/index", "/register"];

          // Verificamos si la ruta actual está en la lista de permitidas
          const isPublic = publicPaths.includes(path);

          if (!token && !isPublic) {
            // NO Logueado y ruta privada -> Echar fuera
            window.location.replace("/login");
          } else {
            // Logueado o ruta publica -> Permitir entrada
            document.addEventListener("DOMContentLoaded", () => {
              document.body.style.visibility = "visible";
              document.body.style.opacity = "1";
            });
          }
        } catch (e) {
          /* Si falla algo, por seguridad mandamos al login */
          console.error(e);
          window.location.replace("/login");
        }
      })();
    </script>

    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Outfit", sans-serif;
      }
    </style>
  </head>
  <body
    class="flex h-screen overflow-hidden bg-[#0a0a0a] text-brand-white safe-area-all"
  >
    <!-- 
      FONDO AMBIENTAL
      Estos círculos (divs) son los que dan esa luz de fondo borrosa.
      Si molestan o dan lag, se pueden borrar, pero le dan el toque "glow".
    -->
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
      <div
        class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-purple-900/20 rounded-full blur-[120px] mix-blend-screen"
      >
      </div>
      <div
        class="absolute bottom-[-15%] right-[-15%] w-[35%] h-[35%] bg-purple-900/20 rounded-full blur-[110px] pointer-events-none -z-20"
      >
      </div>
    </div>

    <!-- Sidebar (Desktop) -->
    {
      showSidebar && (
        <div class="hidden lg:flex shrink-0 h-full">
          <Sidebar />
        </div>
      )
    }

    <!-- Main Content Wrapper -->
    <div
      class="flex-1 flex flex-col h-full overflow-y-auto custom-scrollbar relative min-w-0"
    >
      <!-- Navbar (Mobile Only - Hide on Dashboard) -->
      {
        !showSidebar && (
          <div class="lg:hidden sticky top-0 z-40">
            <NavBar />
          </div>
        )
      }

      <main
        class={`grow w-full max-w-400 mx-auto px-4 sm:px-6 lg:px-8 py-6 relative flex flex-col ${showSidebar ? "pb-40 lg:pb-6" : ""}`}
      >
        <slot />
      </main>

      <footer
        class="border-t border-white/5 py-8 mt-auto shrink-0 mx-6 relative z-10 bg-[#0a0a0a]"
      >
        <div
          class="flex flex-col items-center justify-center gap-2 text-center"
        >
          <div
            class="flex items-center gap-2 opacity-30 grayscale hover:grayscale-0 transition-all duration-500"
          >
            <span class="w-2 h-2 rounded-full bg-brand-lime"></span>
            <span class="text-xs font-bold text-white tracking-widest"
              >CAPYPAY SYSTEM</span
            >
          </div>
          <p
            class="text-white/20 text-[10px] font-medium uppercase tracking-wider"
          >
            &copy; {new Date().getFullYear()} CapyLabs. All Rights Reserved.
          </p>
        </div>
      </footer>
    </div>

    <!-- Mobile Bottom Nav (Dashboard Only) -->
    {showSidebar && <BottomNav />}

    <ToastNotification />

    <!-- PIN MODAL GLOBAL -->
    <div
      id="pin-modal"
      class="fixed inset-0 z-100 hidden items-center justify-center bg-black/80 backdrop-blur-md opacity-0 transition-opacity duration-300"
    >
      <div
        class="bg-brand-black border border-white/10 rounded-3xl w-full max-w-sm p-6 m-4 transform scale-95 transition-transform duration-300 relative overflow-hidden shadow-2xl"
      >
        <!-- Glow FX -->
        <div
          class="absolute top-0 right-0 w-48 h-48 bg-brand-lime/10 rounded-full blur-[80px] -translate-y-1/2 translate-x-1/2 pointer-events-none"
        >
        </div>

        <div class="relative z-10 text-center">
          <div
            class="w-16 h-16 bg-white/5 rounded-full mx-auto mb-4 flex items-center justify-center text-brand-lime border border-white/10 shadow-[0_0_15px_rgba(215,253,73,0.1)]"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-8 w-8"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
              ></path>
            </svg>
          </div>

          <h3 class="text-xl font-bold text-white mb-2">Ingresa tu PIN</h3>
          <p class="text-slate-400 text-xs mb-6">
            Confirma para autorizar la transacción
          </p>

          <!-- PIN INPUT -->
          <div class="flex justify-center gap-1 sm:gap-2 mb-6" id="pin-inputs">
            <input
              type="password"
              maxlength="1"
              class="w-10 h-12 bg-slate-900 border border-white/10 rounded-xl text-center text-xl text-white font-bold focus:outline-none focus:border-brand-lime transition-colors focus:shadow-[0_0_10px_rgba(215,253,73,0.2)]"
            />
            <input
              type="password"
              maxlength="1"
              class="w-10 h-12 bg-slate-900 border border-white/10 rounded-xl text-center text-xl text-white font-bold focus:outline-none focus:border-brand-lime transition-colors focus:shadow-[0_0_10px_rgba(215,253,73,0.2)]"
            />
            <input
              type="password"
              maxlength="1"
              class="w-10 h-12 bg-slate-900 border border-white/10 rounded-xl text-center text-xl text-white font-bold focus:outline-none focus:border-brand-lime transition-colors focus:shadow-[0_0_10px_rgba(215,253,73,0.2)]"
            />
            <input
              type="password"
              maxlength="1"
              class="w-10 h-12 bg-slate-900 border border-white/10 rounded-xl text-center text-xl text-white font-bold focus:outline-none focus:border-brand-lime transition-colors focus:shadow-[0_0_10px_rgba(215,253,73,0.2)]"
            />
            <input
              type="password"
              maxlength="1"
              class="w-10 h-12 bg-slate-900 border border-white/10 rounded-xl text-center text-xl text-white font-bold focus:outline-none focus:border-brand-lime transition-colors focus:shadow-[0_0_10px_rgba(215,253,73,0.2)]"
            />
            <input
              type="password"
              maxlength="1"
              class="w-10 h-12 bg-slate-900 border border-white/10 rounded-xl text-center text-xl text-white font-bold focus:outline-none focus:border-brand-lime transition-colors focus:shadow-[0_0_10px_rgba(215,253,73,0.2)]"
            />
          </div>

          <div class="flex gap-3">
            <button
              id="cancel-pin"
              class="flex-1 py-3 bg-white/5 hover:bg-white/10 text-slate-300 text-sm font-bold rounded-xl transition-colors"
              >Cancelar</button
            >
            <button
              id="confirm-pin"
              class="flex-1 py-3 bg-brand-lime hover:bg-[#ccf044] text-black text-sm font-bold rounded-xl shadow-[0_0_10px_rgba(215,253,73,0.2)] transition-colors"
              >Confirmar</button
            >
          </div>
        </div>
      </div>
    </div>

    <script is:inline>
      // Global PIN Logic
      window.requestPin = (callback) => {
        const modal = document.getElementById("pin-modal");
        const inputs = modal.querySelectorAll("input");
        const confirmBtn = document.getElementById("confirm-pin");
        const cancelBtn = document.getElementById("cancel-pin");

        // Reset
        inputs.forEach((i) => (i.value = ""));

        // Show
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        // Allow render
        requestAnimationFrame(() => {
          modal.classList.remove("opacity-0");
          modal.querySelector("div").classList.remove("scale-95");
          modal.querySelector("div").classList.add("scale-100");
          inputs[0].focus();
        });

        // Auto-focus next
        inputs.forEach((input, index) => {
          input.oninput = (e) => {
            if (input.value.length === 1 && index < inputs.length - 1) {
              inputs[index + 1].focus();
            }
          };
          input.onkeydown = (e) => {
            if (e.key === "Backspace" && input.value === "" && index > 0) {
              inputs[index - 1].focus();
            }
            if (e.key === "Enter") {
              confirmBtn.click();
            }
          };
        });

        const cleanup = () => {
          modal.classList.add("opacity-0");
          modal.querySelector("div").classList.add("scale-95");
          modal.querySelector("div").classList.remove("scale-100");
          setTimeout(() => {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
          }, 300);

          // Remove listeners to avoid accumulation (simple approach)
          confirmBtn.onclick = null;
          cancelBtn.onclick = null;
        };

        confirmBtn.onclick = () => {
          const pin = Array.from(inputs)
            .map((i) => i.value)
            .join("");
          if (pin.length < 4) {
            inputs[0].focus();
            inputs.forEach((i) => i.classList.add("border-red-500"));
            setTimeout(
              () => inputs.forEach((i) => i.classList.remove("border-red-500")),
              500,
            );
            return;
          }
          cleanup();
          callback(pin);
        };

        cancelBtn.onclick = () => {
          cleanup();
        };
      };
    </script>
  </body>
</html>
