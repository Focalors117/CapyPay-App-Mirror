---
const { puntosActuales = 1500 } = Astro.props;
---

<div class="modulo-niveles-container w-full">
  <!-- Tarjeta de Perfil -->
  <div id="perfil-card" class="perfil-card bg-brand-black/80 backdrop-blur-xl border-2 border-[#60A5FA] rounded-3xl p-6 mb-6 relative overflow-hidden transition-all duration-500" style="box-shadow: 0 0 20px rgba(96, 165, 250, 0.15);">
    <!-- Glow decorativo del nivel -->
    <div id="glow-nivel" class="absolute -top-20 -right-20 w-40 h-40 rounded-full blur-[60px] pointer-events-none" style="background: rgba(96, 165, 250, 0.2);"></div>
    <!-- Shine effect diagonal en toda la tarjeta -->
    <div class="shine-effect absolute inset-0 rounded-3xl pointer-events-none z-30"></div>
    
    <div class="relative z-10">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-white text-xl font-bold">Hola, <span id="user-greeting">Estudiante</span></h2>
          <p class="text-slate-400 text-sm">Tu progreso acadÃ©mico</p>
        </div>
        <div id="nivel-badge" class="bg-[#60A5FA]/10 border-2 border-[#60A5FA] px-6 py-3 rounded-xl text-[#60A5FA] font-bold text-lg shadow-[0_0_25px_rgba(96,165,250,0.3)] transition-all duration-300 hover:scale-105">
          <span class="nivel-text">Bachiller</span>
        </div>
      </div>

      <!-- Barra de Progreso -->
      <div class="mb-4">
        <div class="flex justify-between text-xs text-slate-400 mb-2">
          <span id="xp-actual">1,500 XP</span>
          <span id="xp-siguiente">2,000 XP</span>
        </div>
        <div class="h-3 bg-slate-800 rounded-full overflow-hidden relative">
          <div id="progreso-bar" class="h-full rounded-full transition-all duration-500 ease-out relative" style="width: 75%; background: linear-gradient(90deg, #60A5FA, #3B82F6);">
            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent w-full animate-shimmer"></div>
          </div>
        </div>
        <p id="xp-faltante" class="text-slate-500 text-xs mt-2 text-center">Faltan 500 XP para el siguiente nivel</p>
      </div>

      <!-- Info de XP ganada hoy -->
      <div class="flex items-center justify-between bg-white/5 rounded-xl py-2 px-4">
        <div class="flex items-center gap-2">
          <span id="xp-indicator" class="w-3 h-3 rounded-full bg-[#60A5FA] animate-pulse shadow-[0_0_8px_rgba(96,165,250,0.6)]"></span>
          <span id="xp-hoy" class="text-slate-300 text-sm">+0 XP obtenida hoy</span>
        </div>
        <a href="#como-ganar-xp" class="text-[10px] text-brand-lime hover:text-white transition-colors flex items-center gap-1 group">
          Â¿CÃ³mo gano XP?
          <svg class="w-3 h-3 group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </a>
      </div>
    </div>
  </div>

  <!-- LÃ­nea de Tiempo de Niveles -->
  <div id="timeline-section" class="timeline-section bg-brand-black/60 backdrop-blur-lg border-2 border-white/10 rounded-3xl p-6 mb-6 transition-all duration-500">
    <h3 class="text-white text-lg font-bold mb-6 flex items-center gap-2">
      <svg class="w-5 h-5 text-brand-lime" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
      </svg>
      Tu Carrera
    </h3>
    
    <div id="timeline-container" class="space-y-4">
      <!-- Los niveles se generan dinÃ¡micamente con JavaScript -->
    </div>
  </div>

  <!-- Beneficios por Nivel -->
  <div id="beneficios-section" class="beneficios-section bg-brand-black/60 backdrop-blur-lg border-2 border-white/10 rounded-3xl p-6 mb-6 transition-all duration-500">
    <h3 class="text-white text-lg font-bold mb-6 flex items-center gap-2">
      <svg class="w-5 h-5 text-brand-lime" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/>
      </svg>
      Beneficios por Nivel
    </h3>
    
    <div id="beneficios-grid" class="grid grid-cols-1 gap-4">
      <!-- Los beneficios se generan dinÃ¡micamente con JavaScript -->
    </div>
  </div>

  <!-- Lista de Tareas -->
  <div id="como-ganar-xp" class="tareas-section bg-brand-black/60 backdrop-blur-lg border-2 border-white/10 rounded-3xl p-6 transition-all duration-500">
    <h3 class="text-white text-lg font-bold mb-4 flex items-center gap-2">
      <svg class="w-5 h-5 text-brand-lime" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
      </svg>
      CÃ³mo ganar XP
    </h3>
    
    <div id="tareas-lista" class="space-y-3">
      <!-- Las tareas se generan dinÃ¡micamente con JavaScript -->
    </div>
  </div>
    </div>
</div>

<style>
  html {
    scroll-behavior: smooth;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .animate-shimmer {
    animation: shimmer 2s infinite;
  }

  /* Nivel Activo - Glow Effect */
  .nivel-activo {
    position: relative;
  }

  .nivel-activo::before {
    content: '';
    position: absolute;
    inset: -2px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--nivel-color), var(--nivel-color-glow));
    filter: blur(8px);
    opacity: 0.4;
    z-index: -1;
  }

  /* Nivel Bloqueado */
  .nivel-bloqueado {
    opacity: 0.4;
    filter: grayscale(100%);
  }

  /* Tarjeta de Beneficio */
  .beneficio-card {
    transition: all 0.3s ease;
  }

  .beneficio-card:hover:not(.bloqueado) {
    transform: translateY(-2px);
    border-color: var(--beneficio-color);
  }

  /* Tarea completada */
  .tarea-completada {
    background: linear-gradient(135deg, rgba(215, 253, 73, 0.1), rgba(131, 98, 232, 0.1));
  }

  /* Shine Effect Diagonal tipo slash */
  .shine-effect::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      115deg,
      transparent 0%,
      transparent 25%,
      rgba(255,255,255, 0.5) 40%,
      rgba(255,255,255, 0.8) 50%,
      rgba(255,255,255, 0.5) 60%,
      transparent 75%,
      transparent 100%
    );
    transform: translateX(-100%);
    animation: shineSlash 5s infinite;
  }

  @keyframes shineSlash {
    0% {
      transform: translateX(-100%);
    }
    40% {
      transform: translateX(100%);
    }
    100% {
      transform: translateX(100%);
    }
  }
</style>

<script define:vars={{ puntosActuales }}>
  let currentPuntos = puntosActuales;

  const nivelesConfig = [
    {
      id: 'novato',
      nombre: 'Novato (Cachorro)',
      rango: '0 - 500 XP',
      puntosMin: 0,
      puntosMax: 500,
      color: '#9CA3AF',
      colorGlow: '#6B7280',
      icono: 'ðŸŒ±',
      beneficios: [
        'Registro bÃ¡sico',
        'Primera recarga'
      ]
    },
    {
      id: 'bachiller',
      nombre: 'Bachiller',
      rango: '501 - 2,000 XP',
      puntosMin: 501,
      puntosMax: 2000,
      color: '#60A5FA',
      colorGlow: '#3B82F6',
      icono: 'ðŸŽ“',
      beneficios: [
        'Descuento del 2% en fotocopias',
        'Acceso a promociones exclusivas'
      ]
    },
    {
      id: 'licenciado',
      nombre: 'Licenciado',
      rango: '2,001 - 5,000 XP',
      puntosMin: 2001,
      puntosMax: 5000,
      color: '#A78BFA',
      colorGlow: '#8B5CF6',
      icono: 'ðŸ“š',
      beneficios: [
        'Acceso a "CapyPay Universitario"',
        'CrÃ©ditos internos',
        'Sin lÃ­mite de transferencias diarias'
      ]
    },
    {
      id: 'master',
      nombre: 'MagÃ­ster',
      rango: '5,001 - 10,000 XP',
      puntosMin: 5001,
      puntosMax: 10000,
      color: '#F472B6',
      colorGlow: '#EC4899',
      icono: 'ðŸŽ–ï¸',
      beneficios: [
        'Prioridad en cola del comedor',
        'Acceso prioritario a eventos',
        'Soporte 24/7'
      ]
    },
    {
      id: 'doctorado',
      nombre: 'Doctorado',
      rango: '10,000+ XP',
      puntosMin: 10001,
      puntosMax: Infinity,
      color: '#D7FD49',
      colorGlow: '#A8E638',
      icono: 'ðŸ‘‘',
      beneficios: [
        'Cero comisiones en retiros',
        'Transferencias externas sin costo',
        'VIP exclusivo',
        'AsesorÃ­a personalizada'
      ]
    }
  ];

  const tareasXP = [
    { accion: 'Pagar en el comedor', xp: 20 },
    { accion: 'Recargar saldo', xp: 10 },
    { accion: 'Transferir a amigos', xp: 5 },
    { accion: 'Referir un amigo', xp: 100 },
    { accion: 'Completar perfil', xp: 50 },
    { accion: 'Pagar transporte', xp: 15 }
  ];

  function calcularNivelActual(puntos) {
    for (let i = nivelesConfig.length - 1; i >= 0; i--) {
      const nivel = nivelesConfig[i];
      if (puntos >= nivel.puntosMin) {
        return nivel;
      }
    }
    return nivelesConfig[0];
  }

  function calcularProgreso(puntos, nivelActual) {
    if (nivelActual.id === 'doctorado') return 100;
    
    const progresoEnNivel = puntos - nivelActual.puntosMin;
    const totalNivel = nivelActual.puntosMax - nivelActual.puntosMin;
    return Math.min(100, Math.max(0, (progresoEnNivel / totalNivel) * 100));
  }

  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  function renderTimeline() {
    const container = document.getElementById('timeline-container');
    if (!container) return;

    const nivelActual = calcularNivelActual(currentPuntos);

    container.innerHTML = nivelesConfig.map((nivel, index) => {
      const esActual = nivel.id === nivelActual.id;
      const esBloqueado = currentPuntos < nivel.puntosMin;
      const esCompletado = currentPuntos >= nivel.puntosMax;

      let estadoClass = '';
      let estadoIcono = '';
      let estadoTexto = '';
      
      if (esActual) {
        estadoClass = 'nivel-activo';
        estadoIcono = 'ðŸ”¥';
        estadoTexto = 'En curso';
      } else if (esCompletado) {
        estadoClass = '';
        estadoIcono = 'âœ…';
        estadoTexto = 'Completado';
      } else {
        estadoClass = 'nivel-bloqueado';
        estadoIcono = 'ðŸ”’';
        estadoTexto = 'Bloqueado';
      }

      return `
        <div class="nivel-timeline ${estadoClass} bg-slate-800/50 rounded-xl p-4 relative" style="--nivel-color: ${nivel.color}; --nivel-color-glow: ${nivel.colorGlow}">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl" style="background: ${nivel.color}20;">
                ${nivel.icono}
              </div>
              <div>
                <h4 class="text-white font-bold">${nivel.nombre}</h4>
                <p class="text-slate-400 text-sm">${nivel.rango}</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs font-medium px-2 py-1 rounded-full" style="background: ${nivel.color}20; color: ${nivel.color};">
                ${estadoTexto}
              </span>
              ${esBloqueado ? '<svg class="w-4 h-4 text-slate-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>' : ''}
            </div>
          </div>
          ${esActual ? `
            <div class="mt-3">
              <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                <div class="h-full rounded-full transition-all duration-500" style="width: ${calcularProgreso(currentPuntos, nivelActual)}%; background: ${nivel.color};"></div>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  function renderBeneficios() {
    const container = document.getElementById('beneficios-grid');
    if (!container) return;

    const nivelActual = calcularNivelActual(currentPuntos);

    container.innerHTML = nivelesConfig.map(nivel => {
      const esBloqueado = currentPuntos < nivel.puntosMin;
      const esActual = nivel.id === nivelActual.id;

      return `
        <div class="beneficio-card ${esBloqueado ? 'bloqueado opacity-50' : ''} bg-slate-800/30 border border-white/10 rounded-xl p-4" style="--beneficio-color: ${nivel.color}">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl shrink-0" style="background: ${nivel.color}20;">
              ${nivel.icono}
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="text-white font-bold text-sm mb-1">${nivel.nombre}</h4>
              <ul class="text-slate-400 text-xs space-y-1">
                ${nivel.beneficios.map(b => `<li class="flex items-start gap-2"><span class="text-brand-lime mt-0.5">â€¢</span>${b}</li>`).join('')}
              </ul>
            </div>
            ${esBloqueado ? '<svg class="w-5 h-5 text-slate-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>' : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  function renderTareas() {
    const container = document.getElementById('tareas-lista');
    if (!container) return;

    container.innerHTML = tareasXP.map((tarea, index) => {
      const completada = Math.random() > 0.7;
      
      return `
        <div class="tarea-item ${completada ? 'tarea-completada' : ''} bg-slate-800/30 border border-white/10 rounded-xl p-3 flex items-center justify-between transition-all hover:bg-slate-800/50">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full flex items-center justify-center ${completada ? 'bg-brand-lime/20 text-brand-lime' : 'bg-white/5 text-slate-500'}">
              ${completada 
                ? '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>'
                : '<span class="text-xs font-bold">' + (index + 1) + '</span>'
              }
            </div>
            <span class="text-sm ${completada ? 'text-brand-lime line-through' : 'text-slate-300'}">${tarea.accion}</span>
          </div>
          <span class="text-xs font-bold ${completada ? 'text-slate-500' : 'text-brand-lime'}">+${tarea.xp} XP</span>
        </div>
      `;
    }).join('');
  }

  function updateUI() {
    const nivelActual = calcularNivelActual(currentPuntos);
    const progreso = calcularProgreso(currentPuntos, nivelActual);

    const nivelBadge = document.getElementById('nivel-badge');
    const nivelText = document.querySelector('.nivel-text');
    const xpActual = document.getElementById('xp-actual');
    const xpSiguiente = document.getElementById('xp-siguiente');
    const xpFaltante = document.getElementById('xp-faltante');
    const progresoBar = document.getElementById('progreso-bar');
    const perfilCard = document.getElementById('perfil-card');
    const glowNivel = document.getElementById('glow-nivel');
    const xpIndicator = document.getElementById('xp-indicator');

    if (nivelBadge && nivelText) {
      nivelText.textContent = nivelActual.nombre;
      nivelBadge.style.borderColor = nivelActual.color;
      nivelBadge.style.color = nivelActual.color;
      nivelBadge.style.backgroundColor = `${nivelActual.color}20`;
    }

    if (xpActual) {
      xpActual.textContent = `${currentPuntos.toLocaleString()} XP`;
    }

    if (xpSiguiente) {
      if (nivelActual.id === 'doctorado') {
        xpSiguiente.textContent = 'MAX';
      } else {
        xpSiguiente.textContent = `${nivelActual.puntosMax.toLocaleString()} XP`;
      }
    }

    if (xpFaltante) {
      if (nivelActual.id === 'doctorado') {
        xpFaltante.textContent = 'Â¡Has alcanzado el nivel mÃ¡ximo!';
      } else {
        const faltante = nivelActual.puntosMax - currentPuntos;
        xpFaltante.textContent = `Faltan ${faltante.toLocaleString()} XP para el siguiente nivel`;
      }
    }

    if (progresoBar) {
      progresoBar.style.width = `${progreso}%`;
      progresoBar.style.background = `linear-gradient(90deg, ${nivelActual.color}, ${nivelActual.colorGlow})`;
    }

    if (perfilCard) {
      perfilCard.style.borderColor = nivelActual.color;
      perfilCard.style.boxShadow = `0 0 20px ${hexToRgba(nivelActual.color, 0.15)}`;
    }

    if (glowNivel) {
      glowNivel.style.background = hexToRgba(nivelActual.color, 0.2);
    }

    if (xpIndicator) {
      xpIndicator.style.backgroundColor = nivelActual.color;
      xpIndicator.style.boxShadow = `0 0 8px ${hexToRgba(nivelActual.color, 0.5)}`;
    }

    // Actualizar bordes de otras secciones
    const timelineSection = document.getElementById('timeline-section');
    const beneficiosSection = document.getElementById('beneficios-section');
    const tareasSection = document.getElementById('como-ganar-xp');

    if (timelineSection) {
      timelineSection.style.borderColor = nivelActual.color;
      timelineSection.style.boxShadow = `0 0 20px ${hexToRgba(nivelActual.color, 0.1)}`;
    }

    if (beneficiosSection) {
      beneficiosSection.style.borderColor = nivelActual.color;
      beneficiosSection.style.boxShadow = `0 0 20px ${hexToRgba(nivelActual.color, 0.1)}`;
    }

    if (tareasSection) {
      tareasSection.style.borderColor = nivelActual.color;
      tareasSection.style.boxShadow = `0 0 20px ${hexToRgba(nivelActual.color, 0.1)}`;
    }

    renderTimeline();
    renderBeneficios();
    renderTareas();
  }

  function actualizarXP(nuevoXP) {
    currentPuntos = nuevoXP;
    updateUI();
  }

  function initModuloNiveles() {
    updateUI();
    window.actualizarXPModulo = actualizarXP;
    window.showXPInfo = showXPInfoModal;
    window.closeXPInfo = closeXPInfoModal;

    // Obtener nombre del usuario del localStorage
    try {
      const userStr = localStorage.getItem('capypay_user');
      if (userStr) {
        const user = JSON.parse(userStr);
        const userName = user.nombre || user.name;
        if (userName) {
          const firstName = userName.split(' ')[0];
          const userGreeting = document.getElementById('user-greeting');
          if (userGreeting) {
            userGreeting.textContent = firstName;
          }
        }
      }
    } catch (e) {
      console.error('Error al obtener nombre de usuario:', e);
    }
  }

  function showXPInfoModal() {
    const modal = document.getElementById('xp-info-modal');
    if (!modal) return;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    requestAnimationFrame(() => {
      modal.classList.remove('opacity-0');
      modal.querySelector('div').classList.remove('scale-95');
      modal.querySelector('div').classList.add('scale-100');
    });
  }

  function closeXPInfoModal() {
    const modal = document.getElementById('xp-info-modal');
    if (!modal) return;
    
    modal.classList.add('opacity-0');
    modal.querySelector('div').classList.add('scale-95');
    modal.querySelector('div').classList.remove('scale-100');
    
    setTimeout(() => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }, 300);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initModuloNiveles();
      
      const modal = document.getElementById('xp-info-modal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeXPInfoModal();
          }
        });
      }
    });
  } else {
    initModuloNiveles();
    
    const modal = document.getElementById('xp-info-modal');
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeXPInfoModal();
        }
      });
    }
  }
</script>
