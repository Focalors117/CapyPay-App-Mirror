---

---

<div
  id="cart-sidebar"
  class="fixed inset-y-0 right-0 w-full md:w-96 bg-[#1a1a1a] border-l border-white/10 shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col h-full"
>
  <!-- Header -->
  <div
    class="p-4 border-b border-white/10 flex items-center justify-between bg-black/40 backdrop-blur-md"
  >
    <h2 class="text-xl font-bold text-white flex items-center gap-2">
      <svg
        class="w-5 h-5 text-brand-lime"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        ><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
        ></path></svg
      >
      Tu Carrito
    </h2>
    <button
      id="close-cart-btn"
      class="p-2 text-white/60 hover:text-white rounded-full hover:bg-white/10 transition-colors"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        ><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path></svg
      >
    </button>
  </div>

  <!-- Items list -->
  <div
    id="cart-items-container"
    class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar"
  >
    <!-- Items will be injected here by JS -->
    <div class="h-full flex flex-col items-center justify-center text-white/40">
      <svg
        class="w-16 h-16 mb-4 opacity-20"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        ><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg
      >
      <p>Tu carrito está vacío</p>
    </div>
  </div>

  <!-- Footer / Checkout -->
  <div class="p-4 border-t border-white/10 bg-black/40 backdrop-blur-md">
    <div class="flex justify-between items-center mb-4 text-white">
      <span class="text-white/60">Total</span>
      <span id="cart-total" class="text-2xl font-bold text-brand-lime"
        >0.00 CP</span
      >
    </div>
    <button
      id="checkout-btn"
      disabled
      class="w-full py-3.5 bg-brand-lime hover:bg-brand-lime/90 disabled:opacity-50 disabled:cursor-not-allowed text-black font-extrabold rounded-xl transition-all active:scale-95 flex items-center justify-center gap-2"
    >
      <span>Ir a Pagar</span>
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        ><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg
      >
    </button>
  </div>
</div>

<!-- Overlay Backgrop -->
<div
  id="cart-overlay"
  class="fixed inset-0 bg-black/90 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300"
>
</div>

<script>
  import {
    isCartOpen,
    cartItems,
    removeItemFromCart,
    addItemToCart,
  } from "../store/cartStore";

  const sidebar = document.getElementById("cart-sidebar");
  const overlay = document.getElementById("cart-overlay");
  const closeBtn = document.getElementById("close-cart-btn");
  const itemsContainer = document.getElementById("cart-items-container");
  const totalEl = document.getElementById("cart-total");
  const checkoutBtn = document.getElementById(
    "checkout-btn",
  ) as HTMLButtonElement | null;

  if (
    sidebar &&
    overlay &&
    closeBtn &&
    itemsContainer &&
    totalEl &&
    checkoutBtn
  ) {
    // Toggle Sidebar visibility
    isCartOpen.subscribe((isOpen) => {
      if (isOpen) {
        sidebar.classList.remove("translate-x-full");
        // No overlay, no scroll lock - just sidebar
        // overlay.classList.remove("opacity-0", "pointer-events-none");
        // document.body.style.overflow = "hidden";
      } else {
        sidebar.classList.add("translate-x-full");
        // overlay.classList.add("opacity-0", "pointer-events-none");
        // document.body.style.overflow = "";
      }
    });

    closeBtn.addEventListener("click", () => isCartOpen.set(false));
    // overlay.addEventListener("click", () => isCartOpen.set(false));

    // Render items cart
    cartItems.subscribe((items) => {
      // Define types manually since we are in a script tag without full project context sometimes
      type CartItem = {
        id: string;
        name: string;
        price: number;
        image: string;
        quantity: number;
      };

      const itemsArray = Object.values(items) as CartItem[];

      if (itemsArray.length === 0) {
        itemsContainer.innerHTML = `
                  <div class="h-full flex flex-col items-center justify-center text-white/40">
                      <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                      <p>Tu carrito está vacío</p>
                  </div>`;
        checkoutBtn.disabled = true;
        totalEl.textContent = "0.00 CP";
        return;
      }

      checkoutBtn.disabled = false;
      let total = 0;

      itemsContainer.innerHTML = itemsArray
        .map((item) => {
          total += item.price * item.quantity;
          return `
                  <div class="flex gap-3 bg-white/5 p-3 rounded-xl border border-white/5">
                      <img src="${item.image}" class="w-16 h-16 rounded-lg object-cover bg-black/20" alt="${item.name}">
                      <div class="flex-1 min-w-0">
                          <h4 class="text-white font-bold text-sm truncate">${item.name}</h4>
                          <p class="text-brand-lime font-bold text-xs mt-1">${item.price} CP</p>
                          <div class="flex items-center gap-3 mt-2">
                              <button class="w-6 h-6 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition-colors btn-decrease" data-id="${item.id}">-</button>
                              <span class="text-white text-sm font-medium w-4 text-center">${item.quantity}</span>
                              <button class="w-6 h-6 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition-colors btn-increase" data-id="${item.id}">+</button>
                          </div>
                      </div>
                  </div>
              `;
        })
        .join("");

      totalEl.textContent = `${total.toLocaleString()} CP`;

      // Re-attach event listeners for dynamic buttons
      document.querySelectorAll(".btn-decrease").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const target = e.target as HTMLElement;
          if (target.dataset.id) {
            removeItemFromCart(target.dataset.id);
          }
        });
      });
      document.querySelectorAll(".btn-increase").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const target = e.target as HTMLElement;
          const id = target.dataset.id;
          if (id) {
            // Need to cast items to allow index access if TS complains, or reuse casting above
            const item = (items as Record<string, CartItem>)[id];
            if (item) addItemToCart(item); // Re-add implies increment
          }
        });
      });
    });

    // Checkout Logic
    checkoutBtn.addEventListener("click", () => {
      window.location.href = "/checkout";
    });
  }
</script>
