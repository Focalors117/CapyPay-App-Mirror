---

---

<div
  class="bg-brand-black rounded-3xl p-6 border border-white/10 shadow-none flex flex-col h-full relative overflow-hidden group"
>
  <!-- Encabezado -->
  <div class="flex justify-between items-start mb-6 z-10">
    <div>
      <h3 class="text-white text-lg font-semibold flex items-center gap-2">
        Transferir
        <span
          class="text-[10px] bg-brand-lime/10 text-brand-lime px-2 py-0.5 rounded-full border border-brand-lime/30"
          >Rápido</span
        >
      </h3>
      <p class="text-slate-400 text-xs mt-1">
        Envía dinero a contactos o usuarios
      </p>
    </div>
    <button class="text-slate-400 hover:text-white transition-colors">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
        ></path>
      </svg>
    </button>
  </div>

  <!-- Pestañas -->
  <div
    class="flex p-1 bg-black/40 rounded-xl border border-brand-lime/20 mb-6 z-10"
    id="transferTabs"
  >
    <button
      class="flex-1 py-2 rounded-lg text-xs font-bold text-black bg-brand-lime shadow-sm transition-all"
      data-tab="contact"
    >
      Mis Contactos
    </button>
    <button
      class="flex-1 py-2 rounded-lg text-xs font-bold text-neutral-400 hover:text-brand-lime transition-all"
      data-tab="external"
    >
      Usuario Externo
    </button>
  </div>

  <!-- Contenido: Modo Contacto -->
  <div
    id="tabContact"
    class="flex flex-col gap-4 flex-1 z-10 transition-all duration-300 relative"
  >
    <div class="space-y-1 relative" id="contact-select-wrapper">
      <label class="text-xs text-slate-400 font-medium ml-1">Destinatario</label
      >
      <!-- Select Personalizado -->
      <div class="relative">
        <button
          id="custom-select-trigger"
          class="w-full bg-[#0f101f] text-white text-sm rounded-xl border border-white/10 p-3 flex justify-between items-center hover:border-brand-lime/50 transition-colors focus:outline-none focus:border-brand-lime focus:ring-1 focus:ring-brand-lime"
          type="button"
        >
          <span class="text-slate-400" id="selected-contact-text"
            >Selecciona un contacto...</span
          >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 text-slate-400 transition-transform duration-200"
            id="select-arrow"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        <!-- Opciones del Dropdown -->
        <div
          id="custom-select-options"
          class="absolute top-full left-0 w-full mt-2 bg-[#1a1b2e] border border-white/10 rounded-xl overflow-hidden shadow-2xl z-50 hidden opacity-0 translate-y-2 transition-all duration-200 max-h-48 overflow-y-auto custom-scrollbar"
        >
          <!-- Se llenará dinámicamente con JS -->
          <div class="p-4 text-center text-xs text-slate-500">
            Cargando contactos...
          </div>
        </div>

        <!-- Input oculto para almacenar el valor -->
        <input type="hidden" name="contact" id="contact-input" />
      </div>
    </div>

    <div class="space-y-1">
      <label class="text-xs text-slate-400 font-medium ml-1">Cantidad</label>
      <div class="relative">
        <span
          class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-semibold"
          >$</span
        >
        <input
          id="contact-amount"
          type="number"
          placeholder="0.00"
          autocomplete="off"
          class="w-full bg-[#0f101f]! text-white text-lg font-bold rounded-xl border border-white/10 py-3 pl-8 pr-4 outline-none focus:border-brand-lime focus:ring-1 focus:ring-brand-lime placeholder:text-slate-600"
        />
      </div>
      <p class="text-[10px] text-slate-500 text-right italic">
        * Aplica comisión del servicio
      </p>
    </div>
  </div>

  <!-- Contenido: Modo Externo (Oculto por defecto) -->
  <div
    id="tabExternal"
    class="hidden flex-col gap-4 flex-1 z-10 transition-all duration-300"
  >
    <div class="space-y-1">
      <label class="text-xs text-slate-400 font-medium ml-1"
        >Cédula del Destinatario</label
      >
      <div class="relative">
        <input
          id="external-identifier"
          type="text"
          placeholder="Ej: V-12345678"
          class="w-full bg-[#0f101f] text-white text-sm rounded-xl border border-white/10 p-3 outline-none focus:border-brand-lime focus:ring-1 focus:ring-brand-lime"
        />
        <div
          class="absolute right-3 top-1/2 -translate-y-1/2 text-emerald-500 hidden"
        >
          <!-- Marcador de Icono de Éxito -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
      </div>
      <p class="text-[10px] text-slate-500 ml-1">
        Buscando en la base de datos global...
      </p>
    </div>

    <div class="space-y-1">
      <label class="text-xs text-slate-400 font-medium ml-1">Cantidad</label>
      <div class="relative">
        <span
          class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-semibold"
          >$</span
        >
        <input
          id="external-amount"
          type="number"
          placeholder="0.00"
          class="w-full bg-[#0f101f]! text-white text-lg font-bold rounded-xl border border-white/10 py-3 pl-8 pr-4 outline-none focus:border-brand-lime focus:ring-1 focus:ring-brand-lime placeholder:text-slate-600"
        />
      </div>
      <p class="text-[10px] text-slate-500 text-right italic">
        * Aplica comisión del servicio
      </p>
    </div>
  </div>

  <!-- Botón de Enviar -->
  <button
    id="btn-send-transfer"
    class="w-full mt-6 bg-brand-lime hover:bg-[#c1e63e] text-black font-bold py-3 rounded-xl transition-all shadow-[0_0_15px_rgba(215,253,72,0.3)] hover:shadow-[0_0_25px_rgba(215,253,72,0.5)] active:scale-95 flex justify-center items-center gap-2 group/btn z-10"
  >
    <span>Enviar Ahora</span>
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-4 w-4 group-hover/btn:translate-x-1 transition-transform text-black"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
    </svg>
  </button>
</div>

<script>
  // @ts-nocheck
  import {
    authService,
    transactionService,
    userService,
  } from "../services/api.js";

  const buttons = document.querySelectorAll("#transferTabs button");
  const tabContact = document.getElementById("tabContact");
  const tabExternal = document.getElementById("tabExternal");

  // Lógica del Select Personalizado (Dropdown)
  const selectTrigger = document.getElementById("custom-select-trigger");
  const selectOptions = document.getElementById("custom-select-options");
  const selectArrow = document.getElementById("select-arrow");
  const selectedText = document.getElementById("selected-contact-text");
  const contactInput = document.getElementById("contact-input");
  const wrapper = document.getElementById("contact-select-wrapper");

  // --- CARGAR CONTACTOS REALES ---
  async function loadContacts() {
    if (!selectOptions) return;
    try {
      const result = await userService.getContacts();
      const contactos = result.contactos || [];

      if (!contactos || contactos.length === 0) {
        selectOptions.innerHTML =
          '<div class="p-4 text-center text-xs text-slate-500">No tienes contactos guardados.</div>';
        return;
      }

      let html = "";
      const colors = [
        {
          bg: "bg-purple-500/20",
          text: "text-purple-400",
          border: "border-purple-500/30",
        },
        {
          bg: "bg-green-500/20",
          text: "text-green-400",
          border: "border-green-500/30",
        },
        {
          bg: "bg-pink-500/20",
          text: "text-pink-400",
          border: "border-pink-500/30",
        },
        {
          bg: "bg-blue-500/20",
          text: "text-blue-400",
          border: "border-blue-500/30",
        },
      ];

      contactos.forEach((c, index) => {
        const style = colors[index % colors.length];
        html += `
            <div
                class="p-2 cursor-pointer hover:bg-white/5 flex items-center gap-3 transition-colors contact-option"
                data-value="${c.cedula}" 
                data-label="${c.nombre}"
                data-image="${c.iniciales}"
                data-style-bg="${style.bg}"
                data-style-text="${style.text}"
                data-style-border="${style.border}"
            >
                <div class="w-8 h-8 rounded-full ${style.bg} ${style.text} flex items-center justify-center text-xs font-bold border ${style.border}">
                ${c.iniciales}
                </div>
                <div class="flex flex-col">
                <span class="text-white text-sm font-medium">${c.nombre}</span>
                <span class="text-[10px] text-slate-400">${c.cedula}</span>
                </div>
            </div>
            `;
      });

      selectOptions.innerHTML = html;
      bindContactOptions(); // Re-asignar eventos clicks

      // --- AUTO-SELECT FROM URL ---
      const urlParams = new URLSearchParams(window.location.search);
      const targetCedula = urlParams.get("transferTo");

      if (targetCedula) {
        // Buscar la opción con esa cédula
        const targetOption = document.querySelector(
          `.contact-option[data-value="${targetCedula}"]`,
        );
        if (targetOption) {
          targetOption.click(); // Simular click para seleccionar
          document.getElementById("contact-amount")?.focus();
        }
      }
    } catch (e) {
      console.error(e);
      selectOptions.innerHTML =
        '<div class="p-4 text-center text-xs text-red-500">Error cargando contactos.</div>';
    }
  }

  // Llamar al inicio
  loadContacts();

  function closeSelect() {
    if (!selectOptions) return;
    selectOptions.classList.add("opacity-0", "translate-y-2");
    selectArrow?.classList.remove("rotate-180");
    selectTrigger?.classList.remove("border-brand-lime");

    setTimeout(() => {
      selectOptions.classList.add("hidden");
    }, 200);
  }

  // Función para bindear el click en las opciones dinámicas
  function bindContactOptions() {
    const newOptions = document.querySelectorAll(".contact-option");
    newOptions.forEach((opt) => {
      opt.addEventListener("click", () => {
        const val = opt.getAttribute("data-value"); // Esto es la CEDULA
        const label = opt.getAttribute("data-label");
        const image = opt.getAttribute("data-image");

        // Estilos guardados en data-attributes
        const bgClass = opt.getAttribute("data-style-bg");
        const textClass = opt.getAttribute("data-style-text");
        const borderClass = opt.getAttribute("data-style-border");

        if (val && label && selectedText && contactInput) {
          // Actualizar el contenido del disparador
          selectedText.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="w-5 h-5 rounded-full ${bgClass} ${textClass} ${borderClass} flex items-center justify-center text-[8px] font-bold border">
                    ${image}
                    </div>
                    <span class="text-white font-medium">${label}</span>
                </div>
            `;

          contactInput.value = val;
          closeSelect();
        }
      });
    });
  }

  if (selectTrigger && selectOptions && selectArrow) {
    selectTrigger.addEventListener("click", () => {
      // Alternar visibilidad
      const isHidden = selectOptions.classList.contains("hidden");

      if (isHidden) {
        selectOptions.classList.remove("hidden");
        // Pequeño retraso para permitir la transición CSS
        setTimeout(() => {
          selectOptions.classList.remove("opacity-0", "translate-y-2");
        }, 10);
        selectArrow.classList.add("rotate-180");
        selectTrigger.classList.add("border-brand-lime");
      } else {
        closeSelect();
      }
    });

    // Cerrar al hacer clic fuera del componente
    document.addEventListener("click", (e) => {
      if (wrapper && !wrapper.contains(e.target)) {
        closeSelect();
      }
    });
  }

  // Manejo de Pestañas (Tabs)
  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-tab");

      if (!tabContact || !tabExternal) return;

      // Reiniciar estado visual de los botones
      buttons.forEach((b) => {
        b.classList.remove(
          "bg-brand-lime",
          "text-black",
          "shadow-sm",
          "hover:text-brand-lime",
        );
        b.classList.add("text-neutral-400", "hover:text-brand-lime");
      });

      // Activar botón seleccionado
      btn.classList.add("bg-brand-lime", "text-black", "shadow-sm");
      btn.classList.remove("text-neutral-400", "hover:text-brand-lime");

      // Cambiar de vista (Contenido)
      if (target === "contact") {
        tabContact.classList.remove("hidden");
        tabContact.classList.add("flex");
        tabExternal.classList.add("hidden");
        tabExternal.classList.remove("flex");
      } else {
        tabExternal.classList.remove("hidden");
        tabExternal.classList.add("flex");
        tabContact.classList.add("hidden");
        tabContact.classList.remove("flex");
      }
    });
  });

  const btnSend = document.getElementById("btn-send-transfer");

  if (btnSend) {
    btnSend.addEventListener("click", async () => {
      // 1. Validar Usuario y Auth
      const user = authService.getCurrentUser();
      if (!user) {
        alert("Debes iniciar sesión");
        window.location.href = "/login";
        return;
      }

      // 2. Determinar Tab Activa
      const isContactTab = !tabContact?.classList.contains("hidden");

      // 3. Obtener Datos
      let cedulaDestino = "";
      let monto = 0;

      if (isContactTab) {
        const contactInputVal = document.getElementById("contact-input")?.value;
        if (!contactInputVal) {
          alert("Selecciona un contacto");
          return;
        }
        cedulaDestino = contactInputVal; // El valor ahora es la cédula

        const amtInput = document.getElementById("contact-amount");
        monto = parseFloat(amtInput?.value || "0");
      } else {
        // Tab Externa
        const extInput = document.getElementById("external-identifier");
        cedulaDestino = extInput?.value;
        const extAmount = document.getElementById("external-amount");
        monto = parseFloat(extAmount?.value || "0");
      }

      // 4. Validar
      if (!cedulaDestino) {
        if (window.showToast)
          window.showToast("Ingresa la Cédula del destinatario", "error");
        else alert("Ingresa la Cédula del destinatario");
        return;
      }
      if (!monto || monto <= 0) {
        if (window.showToast)
          window.showToast("Ingresa un monto válido", "error");
        else alert("Ingresa un monto válido");
        return;
      }

      // 5. Enviar (CON PIN)
      if (window.requestPin) {
        window.requestPin(async (pin) => {
          const originalText = btnSend.innerHTML;
          btnSend.innerHTML = "Enviando...";
          btnSend.disabled = true;

          try {
            const userId = user.id || user.usuarioId || user._id;
            await transactionService.transfer({
              emisor_id: userId,
              cedula_receptor: cedulaDestino,
              monto: monto,
              concepto: "Transferencia Web",
              pin: pin,
            });

            if (window.showToast)
              window.showToast(
                "Transferencia realizada con éxito",
                "success",
                "Pago enviado",
              );

            // Refrescar datos sin recargar
            document.dispatchEvent(new CustomEvent("capypay:refresh-data"));

            // Reset UI
            if (isContactTab) {
              const amtInput = document.getElementById("contact-amount");
              if (amtInput) amtInput.value = "";
            } else {
              const idInput = document.getElementById("external-identifier");
              const amtInput = document.getElementById("external-amount");
              if (idInput) idInput.value = "";
              if (amtInput) amtInput.value = "";
            }

            btnSend.innerHTML = originalText;
            btnSend.disabled = false;
          } catch (error) {
            console.error(error);
            if (window.showToast)
              window.showToast(
                error.message || "Falló la transferencia",
                "error",
                "Error",
              );
            btnSend.innerHTML = originalText;
            btnSend.disabled = false;
          }
        });
      } else {
        alert("Error: sistema de PIN no cargado.");
      }
    });
  }

  // Escuchar evento de transferencia rápida desde Sidebar
  window.addEventListener("quick-transfer-selected", (e) => {
    const customEvent = e;
    if (!customEvent.detail) return;

    const { cedula } = customEvent.detail;
    if (!cedula) return;

    // 1. Cambiar a tab de Contactos
    const contactBtn = document.querySelector('button[data-tab="contact"]');
    if (contactBtn) contactBtn.click();

    // 2. Seleccionar el contacto
    setTimeout(() => {
      // Buscar la opción en la lista generada
      const targetOption = document.querySelector(
        `.contact-option[data-value="${cedula}"]`,
      );

      if (targetOption) {
        targetOption.click();
        const amountInput = document.getElementById("contact-amount");
        if (amountInput) amountInput.focus();
      }
    }, 100);
  });
</script>
