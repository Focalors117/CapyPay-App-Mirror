---

---

<div
  class="bg-brand-black rounded-3xl p-4 sm:p-6 border border-white/10 shadow-none w-full h-full flex flex-col isolate relative overflow-hidden group"
>
  <!-- Sección de Encabezado -->
  <div
    class="flex flex-col xl:flex-row justify-between items-start xl:items-end mb-1 gap-4 relative z-10"
  >
    <!-- Totales -->
    <div
      class="flex flex-wrap justify-start gap-x-8 sm:gap-x-12 gap-y-2 w-full xl:w-auto"
    >
      <div class="flex flex-col items-start">
        <p
          class="text-xs sm:text-sm text-slate-400 font-medium uppercase tracking-wider mb-1"
        >
          Ingresos
        </p>
        <p
          id="total-income-display"
          class="text-2xl sm:text-3xl font-bold text-brand-lime flex items-center gap-1 drop-shadow-[0_0_10px_rgba(215,253,73,0.3)]"
        >
          ...
        </p>
      </div>

      <div class="flex flex-col items-start">
        <p
          class="text-xs sm:text-sm text-slate-400 font-medium uppercase tracking-wider mb-1"
        >
          Gastos
        </p>
        <p
          id="total-expense-display"
          class="text-2xl sm:text-3xl font-bold text-brand-purple flex items-center gap-1 drop-shadow-[0_0_10px_rgba(131,98,232,0.3)]"
        >
          ...
        </p>
      </div>
    </div>

    <!-- Selector de Período -->
    <div
      class="bg-black/40 p-1 rounded-xl flex items-center border border-white/5 w-full xl:w-auto xl:min-w-70"
    >
      <button
        id="btn-weekly"
        class="flex-1 px-2 py-1 rounded-lg text-[10px] sm:text-xs font-bold bg-brand-lime text-black shadow-sm transition-all chart-period-btn"
        data-mode="weekly">Semanal</button
      >
      <button
        id="btn-monthly"
        class="flex-1 px-2 py-1 rounded-lg text-[10px] sm:text-xs font-medium text-slate-400 hover:text-white transition-all chart-period-btn"
        data-mode="monthly">Mensual</button
      >
      <button
        id="btn-quarterly"
        class="flex-1 px-2 py-1 rounded-lg text-[10px] sm:text-xs font-medium text-slate-400 hover:text-white transition-all chart-period-btn"
        data-mode="quarterly">3 Meses</button
      >
    </div>
  </div>

  <!-- Representación Visual del Gráfico -->
  <div
    class="flex-1 w-full bg-brand-black/30 rounded-2xl p-2 sm:p-3 md:p-4 border border-white/5 relative flex gap-1 sm:gap-2"
  >
    <!-- Etiquetas Eje Y (Escala de Dinero) -->
    <div
      id="chart-y-axis"
      class="flex flex-col justify-between text-[10px] sm:text-xs text-slate-400 font-mono py-6 shrink-0 text-right pr-1 sm:pr-2 select-none h-full"
    >
      <span>--</span>
      <span>--</span>
      <span>--</span>
      <span>--</span>
      <span>--</span>
      <span>0</span>
    </div>

    <!-- Área del Gráfico -->
    <div
      id="chart-bars-container"
      class="flex-1 relative flex items-end justify-between gap-1 sm:gap-1.5 md:gap-2 h-full pl-1 sm:pl-2 border-l border-white/5 border-dashed"
    >
      <!-- Líneas de Cuadrícula de Fondo -->
      <div
        class="absolute inset-x-0 inset-y-6 flex flex-col justify-between pointer-events-none opacity-10 w-full z-0 px-1"
      >
        <div
          class="w-full h-px bg-white border-t border-dashed border-slate-500"
        >
        </div>
        <div
          class="w-full h-px bg-white border-t border-dashed border-slate-500"
        >
        </div>
        <div
          class="w-full h-px bg-white border-t border-dashed border-slate-500"
        >
        </div>
        <div
          class="w-full h-px bg-white border-t border-dashed border-slate-500"
        >
        </div>
        <div
          class="w-full h-px bg-white border-t border-dashed border-slate-500"
        >
        </div>
      </div>

      <!-- Loading State -->
      <div
        class="absolute inset-0 flex items-center justify-center text-xs text-slate-500"
      >
        Calculando...
      </div>
    </div>
  </div>
</div>
<script>
  // @ts-nocheck
  import { authService, userService } from "../services/api.js";

  const totalIncomeEl = document.getElementById("total-income-display");
  const totalExpenseEl = document.getElementById("total-expense-display");
  const chartContainer = document.getElementById("chart-bars-container");
  const yAxisContainer = document.getElementById("chart-y-axis");
  const periodBtns = document.querySelectorAll(".chart-period-btn");

  let allMovements = [];
  let currentMode = "weekly";

  function updateButtons() {
    periodBtns.forEach((btn) => {
      const mode = btn.dataset.mode;
      if (mode === currentMode) {
        btn.classList.remove("text-slate-400", "font-medium");
        btn.classList.add(
          "bg-brand-lime",
          "text-black",
          "font-bold",
          "shadow-sm",
        );
      } else {
        btn.classList.add("text-slate-400", "font-medium");
        btn.classList.remove(
          "bg-brand-lime",
          "text-black",
          "font-bold",
          "shadow-sm",
        );
      }
    });
  }

  periodBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      currentMode = btn.dataset.mode;
      updateButtons();
      processData(allMovements, currentMode);
    });
  });

  async function initChart() {
    const user = authService.getCurrentUser();
    if (!user || (!user.cedula && !user.usuarioId)) return;

    try {
      const cedula = user.cedula || user.id;
      const data = await userService.getHistory(cedula);

      if (!data || !data.movimientos) {
        if (chartContainer)
          chartContainer.innerHTML =
            '<div class="absolute inset-0 flex items-center justify-center text-xs text-slate-500">Sin datos</div>';
        return;
      }

      allMovements = data.movimientos;
      processData(allMovements, currentMode);
    } catch (e) {
      console.error("Error cargando gráfico:", e);
      if (chartContainer)
        chartContainer.innerHTML =
          '<div class="absolute inset-0 flex items-center justify-center text-xs text-red-500">Error</div>';
    }
  }

  function processData(movimientos, mode) {
    let stats = [];
    let globalIncome = 0;
    let globalExpense = 0;

    const now = new Date();
    // Normalize today to start of day
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    if (mode === "weekly") {
      // Last 7 days including today? Or fixed Mon-Sun?
      // User likely wants "This Week" or "Last 7 days". Let's do Mon-Sun relative to current week.
      const dayOfWeek = today.getDay(); // 0 (Sun) - 6 (Sat)
      // Calculate Monday of this week
      const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
      const monday = new Date(today.setDate(diff));
      const days = ["Lun", "Mar", "Mie", "Jue", "Vie", "Sab", "Dom"];

      stats = days.map((day, i) => ({
        day,
        income: 0,
        expense: 0,
        date: new Date(monday.getTime() + i * 86400000),
      }));
    } else if (mode === "monthly") {
      // Last 4 Weeks (approx 1 month)
      stats = [];
      for (let i = 0; i < 4; i++) {
        stats.unshift({
          day: `Sem ${4 - i}`,
          income: 0,
          expense: 0,
          weekOffset: i,
        }); // Sem 4, Sem 3, Sem 2, Sem 1
      }
    } else if (mode === "quarterly") {
      // Last 3 Months
      stats = [];
      const currentMonth = now.getMonth();
      const monthNames = [
        "Ene",
        "Feb",
        "Mar",
        "Abr",
        "May",
        "Jun",
        "Jul",
        "Ago",
        "Sep",
        "Oct",
        "Nov",
        "Dic",
      ];

      for (let i = 2; i >= 0; i--) {
        let mIndex = currentMonth - i;
        let y = now.getFullYear();
        if (mIndex < 0) {
          mIndex += 12;
          y--;
        }
        stats.push({
          day: monthNames[mIndex],
          income: 0,
          expense: 0,
          monthIndex: mIndex,
          year: y,
        });
      }
    }

    // Filter and Aggregate
    movimientos.forEach((mov) => {
      const amount = parseFloat(mov.monto);
      const movDate = new Date(mov.fecha);
      const isExpense = mov.es_negativo;
      const movTime = movDate.getTime();

      // Only process if within valid range in general? (Optional optimization)

      if (mode === "weekly") {
        const start = stats[0].date.getTime();
        const end = stats[6].date.getTime() + 86400000; // End of Sunday

        if (movTime >= start && movTime < end) {
          // Find day index
          let dayIndex = movDate.getDay() - 1;
          if (dayIndex === -1) dayIndex = 6; // Sunday

          if (stats[dayIndex]) {
            if (isExpense) {
              stats[dayIndex].expense += amount;
              globalExpense += amount;
            } else {
              stats[dayIndex].income += amount;
              globalIncome += amount;
            }
          }
        }
      } else if (mode === "monthly") {
        // Define "This month" as last 30 days broken into 4 chunks? Or Calendar weeks?
        // Let's do: Filter for movements in current month.
        // And group by week of month (1-7, 8-14, 15-21, 22+).

        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const endOfMonth = new Date(
          now.getFullYear(),
          now.getMonth() + 1,
          0,
          23,
          59,
          59,
        );

        if (
          movTime >= startOfMonth.getTime() &&
          movTime <= endOfMonth.getTime()
        ) {
          const day = movDate.getDate();
          let weekIndex = Math.floor((day - 1) / 7);
          if (weekIndex > 3) weekIndex = 3; // Put rest in last bucket

          if (stats[weekIndex]) {
            if (isExpense) {
              stats[weekIndex].expense += amount;
              globalExpense += amount;
            } else {
              stats[weekIndex].income += amount;
              globalIncome += amount;
            }
          }
        }
      } else if (mode === "quarterly") {
        stats.forEach((s) => {
          if (
            movDate.getMonth() === s.monthIndex &&
            movDate.getFullYear() === s.year
          ) {
            if (isExpense) {
              s.expense += amount;
              globalExpense += amount;
            } else {
              s.income += amount;
              globalIncome += amount;
            }
          }
        });
      }
    });

    if (mode === "monthly" || mode === "quarterly") {
      // Since global totals were recalculated based on view, update them.
      // Although typically global totals shown on card are "Total History" or "Total Period".
      // The UI says "Ingresos Totales". Let's update them to reflect the View.
      // Wait, usually dashboard card shows Balances, but this chart box has its own totals.
      // Yes, "Ingresos Totales". I will update them to reflect the selected period.
    }

    // Always update totals based on period for consistency with chart
    if (totalIncomeEl) totalIncomeEl.innerHTML = `$${globalIncome.toFixed(2)}`;
    if (totalExpenseEl)
      totalExpenseEl.innerHTML = `$${globalExpense.toFixed(2)}`;

    // 6. Calcular Escalas para el Gráfico
    const allValues = stats.flatMap((d) => [d.income, d.expense]);
    const maxValue = Math.max(...allValues, 10);
    const ceiling = Math.ceil(maxValue / 10) * 10;

    // Actualizar Eje Y
    if (yAxisContainer) {
      yAxisContainer.innerHTML = `
                <span>$${ceiling}</span>
                <span>$${(ceiling * 0.8).toFixed(0)}</span>
                <span>$${(ceiling * 0.6).toFixed(0)}</span>
                <span>$${(ceiling * 0.4).toFixed(0)}</span>
                <span>$${(ceiling * 0.2).toFixed(0)}</span>
                <span>$0</span>
            `;
    }

    // 7. Renderizar Barras
    if (chartContainer) {
      const grid = `
            <div class="absolute inset-x-0 inset-y-6 flex flex-col justify-between pointer-events-none opacity-10 w-full z-0 px-1">
                <div class="w-full h-px bg-white border-t border-dashed border-slate-500"></div>
                <div class="w-full h-px bg-white border-t border-dashed border-slate-500"></div>
                <div class="w-full h-px bg-white border-t border-dashed border-slate-500"></div>
                <div class="w-full h-px bg-white border-t border-dashed border-slate-500"></div>
                <div class="w-full h-px bg-white border-t border-dashed border-slate-500"></div>
            </div>`;

      let barsHtml = "";

      stats.forEach((stat) => {
        const incomePct = (stat.income / ceiling) * 100;
        const expensePct = (stat.expense / ceiling) * 100;
        const incomeH = stat.income > 0 ? Math.max(incomePct, 2) : 0;
        const expenseH = stat.expense > 0 ? Math.max(expensePct, 2) : 0;

        barsHtml += `
                  <div class="flex flex-col justify-end items-center h-full flex-1 gap-2 z-10 group/bar cursor-pointer pb-6">
                     <div class="opacity-0 group-hover/bar:opacity-100 absolute top-0 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] sm:text-xs p-2 sm:p-2.5 rounded transform -translate-y-full transition-opacity border border-white/10 pointer-events-none whitespace-nowrap z-50 shadow-xl">
                         <span class="text-brand-lime">Ing: $${stat.income.toFixed(2)}</span> <br/>
                         <span class="text-purple-400">Gas: $${stat.expense.toFixed(2)}</span>
                     </div>
                     <div class="w-full max-w-4 sm:max-w-5 md:max-w-7 h-full flex items-end justify-center relative space-x-0.5 sm:space-x-1">
                         <div style="height: ${incomeH}%" class="w-full bg-brand-lime rounded-t-sm opacity-90 group-hover/bar:opacity-100 transition-all"></div>
                         <div style="height: ${expenseH}%" class="w-full bg-purple-600 rounded-t-sm opacity-90 group-hover/bar:opacity-100 transition-all"></div>
                     </div>
                     <span class="absolute bottom-1 text-[10px] sm:text-xs text-slate-400 font-medium whitespace-nowrap">${stat.day}</span>
                  </div>
                 `;
      });

      chartContainer.innerHTML = grid + barsHtml;
    }
  }

  // Iniciar
  initChart();
</script>
